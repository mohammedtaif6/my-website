<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>قريباً - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-clock"></i> تنتهي قريباً</div>
        <ul class="nav-links">
            <li><a href="index.html">الرئيسية</a></li>
            <li><a href="subscribers.html">المشتركين</a></li>
            <li><a href="debts.html">الديون</a></li>
            <li><a href="payments.html">المبالغ</a></li>
            <li><a href="expenses.html">الصرفيات</a></li>
            <li><a href="reports.html">التقارير</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-card">
            <h1>تنتهي خلال 3 أيام</h1>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>تاريخ الانتهاء</th>
                        <th>تجديد</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;

        window.renderExpiring = function() {
            const subs = DataManager.getSubscribers();
            const today = new Date();
            const expiring = subs.filter(s => {
                if(!s.expiryDate) return false;
                const diff = (new Date(s.expiryDate) - today) / (1000*60*60*24);
                return diff >= 0 && diff <= 3;
            });
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (expiring.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">لا توجد اشتراكات قريبة الانتهاء</td></tr>';
            } else {
                expiring.forEach(s => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${s.name}</td>
                            <td style="color:var(--warning); font-weight:bold;">${s.expiryDate}</td>
                            <td>
                                <button onclick="window.renew('${s.id}')" class="btn btn-primary btn-sm">تجديد</button>
                            </td>
                        </tr>
                    `;
                });
            }
        };

        window.renew = async function(id) {
            const newDate = prompt("تاريخ الانتهاء الجديد:", new Date().toISOString().split('T')[0]);
            if(newDate) {
                await DataManager.updateSubscriber(id, { expiryDate: newDate, status: 'نشط' });
                alert('تم التجديد');
            }
        };

        window.renderPage = window.renderExpiring;
        setTimeout(window.renderExpiring, 500);
    </script>
</body>
</html>
