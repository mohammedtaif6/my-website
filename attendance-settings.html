<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=27.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet Maps CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="auth-system.js"></script>
    <script>AuthSystem.checkSession();</script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* PIN Protection Overlay */
        .pin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .pin-box {
            background: white;
            padding: 50px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 420px;
            width: 90%;
        }

        .pin-input {
            font-size: 2.5rem;
            text-align: center;
            letter-spacing: 20px;
            padding: 20px;
            border: 3px solid var(--primary);
            border-radius: 16px;
            width: 100%;
            margin: 25px 0;
            background: #f8fafc;
        }

        .help-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 6px;
        }

        /* Map Styles */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #e2e8f0;
            z-index: 10;
        }

        .map-container {
            position: relative;
        }

        .map-label {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            font-size: 0.8rem;
            color: var(--primary);
            font-weight: bold;
            pointer-events: none;
        }

        /* Settings Cards */
        .settings-grid {
            display: grid;
            gap: 24px;
            margin-top: 20px;
        }

        .setting-card {
            background: white;
            padding: 28px;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
        }

        .setting-card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        /* Employee Status */
        .employee-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .employee-status-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            border-right: 5px solid #ccc;
        }

        .employee-status-card.present {
            border-right-color: var(--secondary);
            background: #f0fdf4;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-badge.present {
            background: var(--secondary);
            color: white;
        }

        .status-badge.outside {
            background: var(--warning);
            color: white;
        }

        .status-badge.stale {
            background: #64748b;
            color: white;
        }

        .status-badge.absent {
            background: #cbd5e1;
            color: #64748b;
        }

        .employee-status-card.outside {
            border-right-color: var(--warning);
        }

        .employee-status-card.stale {
            border-right-color: #64748b;
            opacity: 0.8;
        }

        .last-seen {
            font-size: 0.75rem;
            color: #94a3b8;
            display: block;
            margin-top: 5px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Error Styles */
        .error-container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
        }

        .error-icon {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: 15px;
        }

        .error-title {
            color: var(--danger);
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .error-message {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
    </style>

    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();

        const CORRECT_PIN = '2580';
        let map, marker, circle;

        window.checkPIN = function () {
            const input = document.getElementById('pin-input').value;
            if (input === CORRECT_PIN) {
                document.getElementById('pin-overlay').style.display = 'none';
                initMap();
                loadSettings();
            } else {
                alert('Ø±Ù…Ø² Ø®Ø§Ø·Ø¦');
                document.getElementById('pin-input').value = '';
            }
        };

        function initMap() {
            if (map) return;
            map = L.map('map').setView([33.3128, 44.3615], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            marker = L.marker([33.3128, 44.3615], { draggable: true }).addTo(map);
            circle = L.circle([33.3128, 44.3615], {
                color: '#2563eb', fillOpacity: 0.2, radius: 50
            }).addTo(map);

            map.on('click', (e) => updateLocation(e.latlng.lat, e.latlng.lng));
            marker.on('dragend', () => {
                const pos = marker.getLatLng();
                updateLocation(pos.lat, pos.lng);
            });
        }

        function updateLocation(lat, lng) {
            document.getElementById('shop-lat').value = lat.toFixed(6);
            document.getElementById('shop-lng').value = lng.toFixed(6);
            marker.setLatLng([lat, lng]);
            circle.setLatLng([lat, lng]);
            map.panTo([lat, lng]);
        }

        window.updateMapCircle = function () {
            const r = parseInt(document.getElementById('shop-radius').value) || 50;
            if (circle) circle.setRadius(r);
        };

        window.getCurrentLocation = function () {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition((pos) => {
                updateLocation(pos.coords.latitude, pos.coords.longitude);
                map.setZoom(18);
            }, (err) => alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' + err.message), { enableHighAccuracy: true });
        };

        async function loadSettings() {
            const settings = await DataManager.getAttendanceSettings();
            if (settings) {
                const lat = settings.shopLat || 33.3128;
                const lng = settings.shopLng || 44.3615;
                const rad = settings.radius || 50;

                document.getElementById('shop-lat').value = lat;
                document.getElementById('shop-lng').value = lng;
                document.getElementById('shop-radius').value = rad;
                document.getElementById('start-time').value = settings.startTime || '09:00';
                document.getElementById('end-time').value = settings.endTime || '18:00';
                document.getElementById('hourly-rate').value = settings.hourlyRate || 2000;

                updateLocation(lat, lng);
                circle.setRadius(rad);
                map.setView([lat, lng], 17);
            }
        }

        window.saveSettings = async function () {
            const settings = {
                shopLat: parseFloat(document.getElementById('shop-lat').value),
                shopLng: parseFloat(document.getElementById('shop-lng').value),
                radius: parseInt(document.getElementById('shop-radius').value),
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
                hourlyRate: parseInt(document.getElementById('hourly-rate').value),
                syncInterval: parseInt(document.getElementById('sync-interval').value),
                timeoutMinutes: 15
            };
            await DataManager.saveAttendanceSettings(settings);
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(tab + '-tab').style.display = 'block';
            if (tab === 'reports') loadReports();
        };

        window.loadReports = async function () {
            const container = document.getElementById('employee-status-container');
            container.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            try {
                const employees = DataManager.getEmployees();
                const shiftDate = await DataManager.getCurrentShiftDate();
                const settings = await DataManager.getAttendanceSettings();
                const rate = settings?.hourlyRate || 0;
                let html = '', total = 0;

                for (const emp of employees) {
                    const report = await DataManager.getEmployeeAttendanceReport(emp.id, shiftDate);
                    const status = report.status; // present, outside, stale, absent

                    if (status === 'present') total++;

                    const statusLabels = {
                        'present': 'âœ… Ù…ØªÙˆØ§Ø¬Ø¯',
                        'outside': 'ğŸ“ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚',
                        'stale': 'ğŸ“µ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„',
                        'absent': 'âšª ØºØ§Ø¦Ø¨'
                    };

                    const lastSeenTime = report.lastSeen ? new Date(report.lastSeen).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '---';

                    html += `
                        <div class="employee-status-card ${status}">
                            <div style="display:flex; justify-content:space-between; align-items: center;">
                                <strong>${emp.name}</strong>
                                <span class="status-badge ${status}">${statusLabels[status]}</span>
                            </div>
                            <div style="margin-top: 10px;">
                                <p style="margin: 0; font-size: 0.9rem;">Ø§Ù„Ø³Ø§Ø¹Ø§Øª: <strong>${report.totalHours.toFixed(2)}</strong></p>
                                <p style="margin: 0; font-size: 0.9rem;">Ø§Ù„Ù…Ø¨Ù„Øº: <strong>${(report.totalHours * rate).toLocaleString()}</strong> Ø¯.Ø¹</p>
                                <small class="last-seen">Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±: ${lastSeenTime}</small>
                            </div>
                        </div>`;
                }
                container.innerHTML = `<div class="stats-overview"><div class="stat-card"><h3>${total}</h3><p>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù†</p></div></div><div class="employee-status-grid">${html}</div>`;
            } catch (e) {
                console.error('Report Error:', e);
                container.innerHTML = `<div class="error-container">
                    <i class="fas fa-exclamation-circle error-icon"></i>
                    <div class="error-title">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>
                    <div class="error-message">${e.message}</div>
                    <button onclick="loadReports()" class="btn-primary" style="margin-top:10px">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>`;
            }
        };
    </script>
</head>

<body>
    <div id="pin-overlay" class="pin-overlay">
        <div class="pin-box">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
            <input type="password" id="pin-input" class="pin-input" maxlength="4"
                onkeypress="if(event.key==='Enter') checkPIN()">
            <button onclick="checkPIN()" class="btn-primary">ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>

    <div class="container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="switchTab('settings')" class="btn-primary" style="flex:1">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button onclick="switchTab('reports')" class="btn-primary" style="flex:1; background:#6b7280">ğŸ“Š
                Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button onclick="window.location.href='index.html'" class="btn-primary"
                style="width:60px; background:#ef4444"><i class="fas fa-home"></i></button>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="setting-card">
                <h3>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„</h3>
                <p class="help-text">Ø§Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„. Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© ØªÙ…Ø«Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­.</p>
                <div class="map-container">
                    <div id="map"></div>
                </div>
                <div class="form-row">
                    <input type="text" id="shop-lat" class="form-control" readonly>
                    <input type="text" id="shop-lng" class="form-control" readonly>
                </div>
                <button onclick="getCurrentLocation()" class="btn-primary"
                    style="background:#10b981; margin-bottom:15px">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ ğŸ“</button>

                <div class="form-group">
                    <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ø¨Ø§Ù„Ù…ØªØ±):</label>
                    <input type="number" id="shop-radius" class="form-control" oninput="updateMapCircle()">
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>ÙØ­Øµ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙƒÙ„ (Ø¯Ù‚ÙŠÙ‚Ø©):</label>
                    <input type="range" id="sync-interval" min="1" max="60" value="1" class="form-control"
                        style="padding: 0;" oninput="document.getElementById('sync-label').innerText = this.value">
                    <p class="help-text">Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† ÙƒÙ„ ÙØ­Øµ ÙˆØ§Ù„Ø¢Ø®Ø±: <strong id="sync-label"
                            style="color:var(--primary)">1</strong> Ø¯Ù‚ÙŠÙ‚Ø©</p>
                </div>
            </div>

            <div class="setting-card">
                <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ÙˆÙ‚Øª Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…:</label>
                        <input type="time" id="start-time" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…:</label>
                        <input type="time" id="end-time" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø£Ø¬Ø± Ø§Ù„Ø³Ø§Ø¹Ø© (Ø¯ÙŠÙ†Ø§Ø±):</label>
                    <input type="number" id="hourly-rate" class="form-control">
                </div>
            </div>

            <button onclick="saveSettings()" class="btn-primary" style="margin-top:20px; font-size:1.2rem">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                ğŸ’¾</button>
        </div>

        <div id="reports-tab" class="tab-content" style="display:none">
            <div id="employee-status-container"></div>
        </div>
    </div>
</body>

</html>