<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OKComputer">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%231e40af' width='192' height='192'/><text x='50%' y='50%' font-size='80' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle' font-family='Arial'>OC</text></svg>">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=2.0">
    <link rel="stylesheet" href="responsive.css?v=2.0">
    <style>
        .card { 
            background: white; 
            transition: transform 0.2s;
        }
        .card:hover { 
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <script src="cache-manager.js"></script>
    <nav class="bg-blue-800 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-4 space-x-reverse text-white font-bold text-lg">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <span>OKComputer</span>
                </div>
                <div class="hidden md:flex space-x-4 space-x-reverse">
                    <a href="index.html" class="text-white font-bold px-3 py-2 bg-white/20 rounded">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    <a href="subscribers.html" class="text-white hover:bg-white/10 px-3 py-2 rounded">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</a>
                    <a href="debts.html" class="text-white hover:bg-white/10 px-3 py-2 rounded">Ø§Ù„Ø¯ÙŠÙˆÙ†</a>
                    <a href="payments.html" class="text-white hover:bg-white/10 px-3 py-2 rounded">Ø§Ù„Ù…Ø¨Ø§Ù„Øº</a>
                    <a href="expenses.html" class="text-white hover:bg-white/10 px-3 py-2 rounded">Ø§Ù„ØµØ±ÙÙŠØ§Øª</a>
                    <a href="reports.html" class="text-white hover:bg-white/10 px-3 py-2 rounded">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="mb-8 bg-gradient-to-r from-blue-700 to-indigo-800 rounded-xl p-8 text-white shadow-lg flex justify-between items-center">
            <div>
                <p class="text-sm opacity-75" id="current-date"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="openActivateModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 font-medium">
                    <i class="fas fa-check"></i>
                    ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
                </button>
                <button onclick="openAddExpenseModal()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 font-medium">
                    <i class="fas fa-plus"></i>
                    Ø¥Ø¶Ø§ÙØ© ØµØ±ÙÙŠØ©
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <a href="subscribers.html" class="card rounded-xl p-6 shadow-sm border border-gray-100 block">
                <div class="flex justify-between items-center mb-4">
                    <div class="p-3 bg-blue-100 rounded-lg text-blue-600"><i class="fas fa-users text-xl"></i></div>
                    <span class="text-xs text-gray-500 font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                </div>
                <h3 class="text-gray-500 text-sm font-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
                <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-total">...</p>
            </a>

            <a href="expired.html" class="card rounded-xl p-6 shadow-sm border border-gray-100 block">
                <div class="flex justify-between items-center mb-4">
                    <div class="p-3 bg-red-100 rounded-lg text-red-600"><i class="fas fa-exclamation-triangle text-xl"></i></div>
                    <span class="text-xs text-gray-500 font-bold">ØªÙ†Ø¨ÙŠÙ‡</span>
                </div>
                <h3 class="text-gray-500 text-sm font-bold">Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§ÙƒÙ‡Ù…</h3>
                <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-expired">...</p>
            </a>

            <a href="expiring.html" class="card rounded-xl p-6 shadow-sm border border-gray-100 block">
                <div class="flex justify-between items-center mb-4">
                    <div class="p-3 bg-orange-100 rounded-lg text-orange-600"><i class="fas fa-hourglass-half text-xl"></i></div>
                    <span class="text-xs text-gray-500 font-bold">Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>
                </div>
                <h3 class="text-gray-500 text-sm font-bold">Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</h3>
                <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-expiring">...</p>
            </a>

            <a href="debts.html" class="card rounded-xl p-6 shadow-sm border border-gray-100 block">
                <div class="flex justify-between items-center mb-4">
                    <div class="p-3 bg-yellow-100 rounded-lg text-yellow-600"><i class="fas fa-money-bill text-xl"></i></div>
                    <span class="text-xs text-gray-500 font-bold">Ù…Ø³ØªØ­Ù‚Ø§Øª</span>
                </div>
                <h3 class="text-gray-500 text-sm font-bold">Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø£Ø¬Ù„)</h3>
                <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-debts">...</p>
            </a>

            <a href="payments.html" class="card rounded-xl p-6 shadow-sm border border-gray-100 block">
                <div class="flex justify-between items-center mb-4">
                    <div class="p-3 bg-green-100 rounded-lg text-green-600"><i class="fas fa-check-circle text-xl"></i></div>
                    <span class="text-xs text-gray-500 font-bold">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
                </div>
                <h3 class="text-gray-500 text-sm font-bold">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h3>
                <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-received">...</p>
            </a>

            <a href="expenses.html" class="card rounded-xl p-6 shadow-sm border border-gray-100 block">
                <div class="flex justify-between items-center mb-4">
                    <div class="p-3 bg-red-100 rounded-lg text-red-600"><i class="fas fa-receipt text-xl"></i></div>
                    <span class="text-xs text-gray-500 font-bold">Ù…ØµØ±ÙˆÙØ§Øª</span>
                </div>
                <h3 class="text-gray-500 text-sm font-bold">Ø§Ù„ØµØ±ÙÙŠØ§Øª</h3>
                <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-expenses">...</p>
            </a>
        </div>
    </main>

    <!-- ===== ØªØ¨ÙˆÙŠØ¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ===== -->
    <div id="activateModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 550px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1.5rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="color: white; font-size: 1.5rem; font-weight: bold; margin: 0;">
                        <i class="fas fa-check-circle ml-2"></i>ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯
                    </h2>
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.875rem; margin: 0.5rem 0 0 0;">Ø£Ø¶Ù Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø­Ø¯Ù‘Ø« Ø§Ø´ØªØ±Ø§Ùƒ Ù…ÙˆØ¬ÙˆØ¯</p>
                </div>
                <button onclick="closeActivateModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px;">âœ•</button>
            </div>

            <!-- Form Content -->
            <form onsubmit="activateSubscription(event)" style="padding: 1.5rem;">
                
                <!-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø´ØªØ±Ùƒ -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                        <i class="fas fa-user-plus ml-2" style="color: #10b981;"></i>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ *
                    </label>
                    <input type="text" id="act-name" required placeholder="Ø§Ø¨Ø¯Ø£ Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; transition: all 0.3s;"
                           oninput="searchSubscriber()"
                           onfocus="this.style.borderColor='#10b981'"
                           onblur="this.style.borderColor='#e5e7eb'">
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª -->
                    <div id="subscriber-suggestions" style="margin-top: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto; display: none; background: #f9fafb;">
                        <div id="suggestions-list"></div>
                    </div>
                    
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ -->
                    <div id="subscriber-info" style="margin-top: 0.75rem; padding: 0.75rem; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; display: none;">
                        <p style="margin: 0.25rem 0; font-size: 0.875rem;">
                            <span style="font-weight: 600; color: #1e40af;">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</span> 
                            <span id="info-phone" style="color: #1f2937;"></span>
                        </p>
                        <p style="margin: 0.25rem 0; font-size: 0.875rem;">
                            <span style="font-weight: 600; color: #1e40af;">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span> 
                            <span id="info-status" style="color: #1f2937;"></span>
                        </p>
                    </div>
                </div>

                <!-- Ø§Ù„ÙØ§ØµÙ„ -->
                <hr style="border: none; border-top: 2px solid #f3f4f6; margin: 1.5rem 0;">

                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¹Ø± -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">
                        <i class="fas fa-tag ml-2" style="color: #10b981;"></i>Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ *
                    </label>
                    
                    <!-- Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                        <button type="button" class="price-btn" onclick="selectPrice(35000, this)" 
                                style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 600; color: #1f2937; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-money-bill-wave ml-1"></i>35,000 Ø¯.Ø¹
                        </button>
                        <button type="button" class="price-btn" onclick="selectPrice(30000, this)" 
                                style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 600; color: #1f2937; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-money-bill-wave ml-1"></i>30,000 Ø¯.Ø¹
                        </button>
                        <button type="button" class="price-btn" onclick="toggleCustomPrice(this)" 
                                style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 600; color: #1f2937; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-sliders-h ml-1"></i>Ù…Ø®ØµØµ
                        </button>
                    </div>
                    
                    <!-- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ØµØµ -->
                    <input type="number" id="custom-price" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ØµØµ" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; display: none; transition: all 0.2s;" 
                           step="1000" min="0">
                    <input type="hidden" id="selected-price">
                </div>

                <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                        <i class="fas fa-credit-card ml-2" style="color: #10b981;"></i>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ *
                    </label>
                    <select id="payment-type" required 
                            style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s;">
                        <option value="">âœ“ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹</option>
                        <option value="Ù†Ù‚Ø¯">ğŸ’° Ù†Ù‚Ø¯ (ÙÙˆØ±ÙŠ)</option>
                        <option value="Ø£Ø¬Ù„">ğŸ“… Ø£Ø¬Ù„ (Ù…Ø¤Ø¬Ù„)</option>
                    </select>
                </div>

                <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            <i class="fas fa-calendar-check ml-1" style="color: #10b981;"></i>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                        </label>
                        <input type="date" id="sub-date" disabled 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb; font-size: 0.875rem;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            <i class="fas fa-calendar-times ml-1" style="color: #ef4444;"></i>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                        </label>
                        <input type="date" id="exp-date" disabled 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb; font-size: 0.875rem;">
                    </div>
                </div>

                <!-- Ø§Ù„ÙØ§ØµÙ„ -->
                <hr style="border: none; border-top: 2px solid #f3f4f6; margin: 1.5rem 0;">

                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                <div style="display: flex; gap: 0.75rem;">
                    <button type="button" onclick="closeActivateModal()" 
                            style="flex: 1; padding: 0.75rem; background: #f3f4f6; color: #1f2937; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-times ml-1"></i>Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="button" onclick="printReceipt()" 
                            style="flex: 1; padding: 0.75rem; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-print ml-1"></i>Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button type="submit" 
                            style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-check-circle ml-1"></i>ØªÙØ¹ÙŠÙ„
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Ø¥Ø¶Ø§ÙØ© ØµØ±ÙÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button onclick="closeAddExpenseModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form onsubmit="saveNewExpense(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨ÙŠØ§Ù† *</label>
                    <input type="text" id="add-description" required placeholder="ÙˆØµÙ Ø§Ù„ØµØ±ÙÙŠØ©" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø¹) *</label>
                    <input type="number" id="add-amount" required placeholder="0" class="w-full p-3 border border-gray-300 rounded-lg" min="0" step="1000">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="add-date" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeAddExpenseModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-save ml-2"></i>
                        Ø­ÙØ¸
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="data-manager.js"></script>
    <script>
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof updateDashboard === 'function') {
                updateDashboard();
            }
        });

        function openActivateModal() {
            document.getElementById('activateModal').style.display = 'flex';
            setDefaultDates();
        }

        function closeActivateModal() {
            document.getElementById('activateModal').style.display = 'none';
            resetActivateForm();
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const expiry = new Date();
            expiry.setDate(expiry.getDate() + 30);
            const expiryStr = expiry.toISOString().split('T')[0];

            document.getElementById('sub-date').value = today;
            document.getElementById('exp-date').value = expiryStr;
        }

        function selectPrice(price, btn) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.price-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.borderColor = '#e5e7eb';
                b.style.background = 'white';
                b.style.color = '#1f2937';
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            btn.classList.add('selected');
            document.getElementById('selected-price').value = price;
            document.getElementById('custom-price').style.display = 'none';
            
            // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
            btn.style.transform = 'scale(1.05)';
            setTimeout(() => { btn.style.transform = 'scale(1)'; }, 100);
        }

        function toggleCustomPrice(btn) {
            const customInput = document.getElementById('custom-price');
            const isHidden = customInput.style.display === 'none';
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.price-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.borderColor = '#e5e7eb';
                b.style.background = 'white';
                b.style.color = '#1f2937';
            });
            
            if (isHidden) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ØµØµ
                btn.classList.add('selected');
                customInput.style.display = 'block';
                customInput.focus();
                customInput.style.borderColor = '#10b981';
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ØµØµ
                customInput.style.display = 'none';
                document.getElementById('selected-price').value = '';
            }
        }

        function searchSubscriber() {
            const input = document.getElementById('act-name').value.trim();
            const suggestionBox = document.getElementById('subscriber-suggestions');
            const infoBox = document.getElementById('subscriber-info');
            
            if (!input) {
                suggestionBox.style.display = 'none';
                infoBox.style.display = 'none';
                return;
            }

            let results = [];
            try {
                results = DataManager.searchSubscribers(input);
            } catch (e) {
                const all = DataManager.getSubscribers() || [];
                const q = input.toLowerCase();
                results = all.filter(s => (s.name || '').toLowerCase().includes(q));
            }
            
            if (results.length === 0) {
                suggestionBox.style.display = 'none';
                infoBox.style.display = 'none';
                return;
            }

            const suggestionsList = document.getElementById('suggestions-list');
            suggestionsList.innerHTML = results.map(s => `
                <div style="padding: 0.75rem; border-bottom: 1px solid #e5e7eb; hover:background #f3f4f6; cursor: pointer; transition: all 0.2s;" 
                     onclick="selectSubscriber(${s.id})" 
                     onmouseover="this.style.background='#f3f4f6'" 
                     onmouseout="this.style.background='white'">
                    <div style="font-weight: 600; color: #1f2937;">${s.name}</div>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                        ğŸ“ ${s.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'} | ğŸ“Š ${s.status || 'Ø¨Ø¯ÙˆÙ† Ø­Ø§Ù„Ø©'}
                    </div>
                </div>
            `).join('');

            suggestionBox.style.display = 'block';

            if (results.length === 1) {
                showSubscriberInfo(results[0]);
            }
        }

        function selectSubscriber(id) {
            const subscriber = DataManager.getSubscriber(id);
            
            if (subscriber) {
                document.getElementById('act-name').value = subscriber.name;
                document.getElementById('subscriber-suggestions').style.display = 'none';
                showSubscriberInfo(subscriber);
            }
        }

        function showSubscriberInfo(subscriber) {
            if (!subscriber) return;
            document.getElementById('info-phone').textContent = subscriber.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            document.getElementById('info-status').textContent = subscriber.status || 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
            document.getElementById('subscriber-info').style.display = 'block';
        }

        function activateSubscription(e) {
            e.preventDefault();
            const name = document.getElementById('act-name').value;
            const priceInput = document.getElementById('selected-price').value || document.getElementById('custom-price').value;
            const price = parseInt(priceInput) || 0;
            const paymentType = document.getElementById('payment-type').value;
            const subscribeDate = document.getElementById('sub-date').value;
            const expiryDate = document.getElementById('exp-date').value;

            if (!price) return;

            let existing = null;
            try {
                const results = DataManager.searchSubscribers(name);
                existing = results.find(s => s.name === name);
            } catch(e) {}

            if (existing) {
                DataManager.updateSubscriber(existing.id, {
                    price, paymentType, subscribeDate, expiryDate,
                    status: 'Ù†Ø´Ø·'
                });
            } else {
                DataManager.addSubscriber({
                    name, price, paymentType, subscribeDate, expiryDate,
                    status: 'Ù†Ø´Ø·'
                });
            }

            updateDashboard();
            closeActivateModal();
        }

        function printReceipt() {
            const name = document.getElementById('act-name').value;
            const price = document.getElementById('selected-price').value || document.getElementById('custom-price').value;
            const paymentType = document.getElementById('payment-type').value;
            const subscribeDate = document.getElementById('sub-date').value;
            const expiryDate = document.getElementById('exp-date').value;

            if (!name || !price) return;

            let phone = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            try {
                const results = DataManager.searchSubscribers(name);
                const sub = results.find(s => s.name === name);
                if (sub) phone = sub.phone;
            } catch(e) {}

            const start = new Date(subscribeDate);
            const end = new Date(expiryDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

            const receiptHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ø¥ÙŠØµØ§Ù„</title>
                    <style>
                        @page { size: 80mm auto; margin: 0; }
                        body { margin: 0; padding: 0; font-family: Arial, sans-serif; direction: rtl; color: #222; }
                        .receipt { width: 80mm; padding: 8px; background: #fff; }
                        .header { text-align: center; padding: 6px 0; border-bottom: 1px solid #e6e6e6; }
                        .header h1 { margin: 0; font-size: 16px; font-weight: 700; color: #111; }
                        .header p { margin: 4px 0 0; font-size: 11px; color: #666; }
                        .content { padding: 6px; font-size: 12px; line-height: 1.6; }
                        .row { margin: 6px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
                        .label { color: #333; font-weight: 600; text-align: right; }
                        .value { color: #111; text-align: left; }
                        .divider { border-bottom: 1px dashed #e6e6e6; margin: 8px 0; }
                        .amount-box { padding: 8px; border: 1px solid #ddd; text-align: center; margin: 8px 0; background: #fff; }
                        .amount-box .value { font-size: 18px; font-weight: 700; font-family: 'Courier New', monospace; color: #111; }
                        .details { font-size: 11px; color: #444; padding: 6px; border-top: 1px solid #f5f5f5; margin-top: 8px; }
                        .status { display: inline-block; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-weight: 600; color: #111; background: #fff; margin-top: 8px; }
                        .footer { text-align: center; font-size: 10px; color: #666; border-top: 1px solid #f1f1f1; padding-top: 6px; margin-top: 8px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header">
                            <h1>OKComputer</h1>
                            <p>Ø¥ÙŠØµØ§Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</p>
                        </div>
                        <div class="content">
                            <div class="row"><span class="label">Ø§Ù„Ø§Ø³Ù…</span><span class="value">${name}</span></div>
                            <div class="row"><span class="label">Ø§Ù„Ù‡Ø§ØªÙ</span><span class="value">${phone}</span></div>
                            <div class="divider"></div>
                            <div class="amount-box">
                                <div class="label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</div>
                                <div class="value">${parseInt(price).toLocaleString('ar-IQ')} Ø¯.Ø¹</div>
                            </div>
                            <div class="row"><span class="label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹</span><span class="value">${paymentType}</span></div>
                            <div class="details">
                                <div class="row"><span class="label">Ù…Ù†</span><span class="value">${subscribeDate}</span></div>
                                <div class="row"><span class="label">Ø¥Ù„Ù‰</span><span class="value">${expiryDate}</span></div>
                                <div class="row"><span class="label">Ø§Ù„Ù…Ø¯Ø©</span><span class="value">${days} ÙŠÙˆÙ…</span></div>
                            </div>
                            <div class="status">Ù†Ø´Ø·</div>
                            <div class="footer">
                                <div>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</div>
                                <div style="margin-top:6px;color:#999;font-size:10px;">${new Date().toLocaleString('ar-IQ')}</div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.right = '-10000px';
            iframe.style.width = '0px';
            iframe.style.height = '0px';
            iframe.style.border = '0';
            document.body.appendChild(iframe);

            const iwin = iframe.contentWindow || iframe;
            const idoc = iframe.contentDocument || iframe.contentWindow.document;
            idoc.open();
            idoc.write(receiptHTML);
            idoc.close();

            let _printed = false;
            const _cleanup = () => { try { document.body.removeChild(iframe); } catch(e) {} };
            const doPrint = () => {
                if (_printed) return;
                _printed = true;
                try {
                    iwin.focus();
                    if (iwin.print) iwin.print();
                } catch (err) {
                    console.error('Print error:', err);
                }
                setTimeout(_cleanup, 800);
            };

            iframe.onload = () => doPrint();
            const _fallbackTimer = setTimeout(() => doPrint(), 700);
        }

        function resetActivateForm() {
            // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª
            document.getElementById('act-name').value = '';
            document.getElementById('payment-type').value = '';
            document.getElementById('selected-price').value = '';
            document.getElementById('custom-price').value = '';
            document.getElementById('custom-price').style.display = 'none';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            document.getElementById('subscriber-suggestions').style.display = 'none';
            document.getElementById('subscriber-info').style.display = 'none';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.price-btn').forEach(b => {
                b.classList.remove('selected');
                b.style.borderColor = '#e5e7eb';
                b.style.background = 'white';
                b.style.color = '#1f2937';
            });
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            setDefaultDates();
        }

        window.onclick = function(e) {
            const activateModal = document.getElementById('activateModal');
            const addExpenseModal = document.getElementById('addExpenseModal');
            if (e.target === activateModal) closeActivateModal();
            if (e.target === addExpenseModal) closeAddExpenseModal();
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ±ÙÙŠØ© ---
        function openAddExpenseModal() {
            document.getElementById('add-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('addExpenseModal').style.display = 'flex';
        }

        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'none';
            document.getElementById('add-description').value = '';
            document.getElementById('add-amount').value = '';
            document.getElementById('add-date').value = '';
        }

        function saveNewExpense(e) {
            e.preventDefault();
            const description = document.getElementById('add-description').value;
            const amount = parseInt(document.getElementById('add-amount').value) || 0;
            const date = document.getElementById('add-date').value;

            if (!description || amount <= 0) {
                return;
            }

            let allExpenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            
            const newExpense = {
                id: Date.now(),
                description,
                amount,
                date,
                createdAt: new Date().toISOString()
            };

            allExpenses.push(newExpense);
            localStorage.setItem('expenses', JSON.stringify(allExpenses));
            updateDashboard();
            closeAddExpenseModal();
        }

        window.updateDashboard = function() {
            const stats = DataManager.getStatistics();
            const subs = DataManager.getSubscribers();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯ÙŠÙˆÙ† (Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¨Ù†ÙˆØ¹ Ø£Ø¬Ù„)
            const debts = subs.filter(s => s.paymentType === 'Ø£Ø¬Ù„' && s.price > 0)
                .reduce((sum, s) => sum + (parseInt(s.price) || 0), 0);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† Ø«Ù„Ø§Ø« Ù…ØµØ§Ø¯Ø±:
            
            // 1. Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ÙŠÙ†
            let received = subs.filter(s => s.paymentType === 'Ù†Ù‚Ø¯' && s.price > 0)
                .reduce((sum, s) => sum + (parseInt(s.price) || 0), 0);
            
            // 2. Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø²Ø¦ÙŠ ÙˆØ§Ù„ÙƒØ§Ù…Ù„) - âœ“ Ø§Ù„Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
            const transactions = DataManager.getAllTransactions();
            if (transactions && Array.isArray(transactions)) {
                const totalTransactions = transactions.reduce((sum, t) => sum + (parseInt(t.amount) || 0), 0);
                received += totalTransactions;
            }
            
            // 3. Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø³Ø¯Ø¯Ø© ÙƒØ§Ù…Ù„Ø§Ù‹ (Ù„Ù„ØªÙˆØ§ÙÙ‚ÙŠØ© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…)
            const fullPayments = subs.filter(s => s.lastPaymentDate && s.originalPrice > 0 && !transactions.some(t => t.subscriberId === s.id))
                .reduce((sum, s) => sum + (parseInt(s.originalPrice) || 0), 0);
            received += fullPayments;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            let expenses = 0;
            const expensesData = JSON.parse(localStorage.getItem('expenses') || '[]');
            if (Array.isArray(expensesData)) {
                expenses = expensesData.reduce((sum, e) => sum + (parseInt(e.amount) || 0), 0);
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ§ÙÙŠ
            const netReceived = received - expenses;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('stat-total').textContent = stats.totalSubscribers;
            document.getElementById('stat-expired').textContent = stats.expiredSubscribers;
            document.getElementById('stat-expiring').textContent = stats.expiringSubscribers;
            document.getElementById('stat-debts').textContent = debts.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('stat-received').textContent = netReceived.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('stat-expenses').textContent = expenses.toLocaleString() + ' Ø¯.Ø¹';
        }

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateDashboard Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof updateDashboard === 'function') {
                    updateDashboard();
                }
            }, 500);
        });

        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js', { scope: './' }).catch(() => {
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            });
        }
    </script>
</body>
</html>
