<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الرئيسية - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="data-manager.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-chart-line"></i> OK Computer</div>
        <ul class="nav-links">
            <li><a href="index.html" class="active"><i class="fas fa-home"></i> <span>الرئيسية</span></a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> <span>المشتركين</span></a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> <span>الديون</span></a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> <span>المبالغ</span></a></li>
            <li><a href="expenses.html"><i class="fas fa-file-invoice-dollar"></i> <span>الصرفيات</span></a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> <span>التقارير</span></a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header" style="background: linear-gradient(to left, #1e40af, #3b82f6); color: white;">
            <div>
                <h1 style="color:white; font-size: 24px;">لوحة التحكم</h1>
                <span id="dateDisplay" style="opacity: 0.8; font-size: 14px;"></span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openModal('activateModal')" class="btn" style="background: white; color: #1e40af;">
                    <i class="fas fa-check-circle"></i> تفعيل اشتراك
                </button>
                <button onclick="openModal('expenseModal')" class="btn" style="background: #ef4444; color: white;">
                    <i class="fas fa-receipt"></i> إضافة صرفية
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <a href="subscribers.html" class="stat-card">
                <h3><i class="fas fa-users"></i> المشتركين</h3>
                <div class="value" id="val-subs">0</div>
            </a>
            <a href="debts.html" class="stat-card" style="border-bottom-color: #ef4444;">
                <h3><i class="fas fa-money-bill"></i> الديون (أجل)</h3>
                <div class="value" id="val-debts">0</div>
            </a>
            <a href="payments.html" class="stat-card" style="border-bottom-color: #10b981;">
                <h3><i class="fas fa-hand-holding-usd"></i> الواردات</h3>
                <div class="value" id="val-received">0</div>
            </a>
            <a href="expenses.html" class="stat-card" style="border-bottom-color: #f59e0b;">
                <h3><i class="fas fa-file-invoice"></i> المصروفات</h3>
                <div class="value" id="val-expenses">0</div>
            </a>
            <a href="expired.html" class="stat-card" style="border-bottom-color: #6b7280;">
                <h3><i class="fas fa-exclamation-circle"></i> المنتهية</h3>
                <div class="value" id="val-expired">0</div>
            </a>
            <a href="expiring.html" class="stat-card" style="border-bottom-color: #8b5cf6;">
                <h3><i class="fas fa-clock"></i> قريباً</h3>
                <div class="value" id="val-expiring">0</div>
            </a>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="window.location.reload(true)" class="btn btn-secondary">
                <i class="fas fa-sync"></i> تحديث الصفحة
            </button>
        </div>
    </div>

    <div id="activateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تفعيل اشتراك جديد</h3>
                <button class="close-btn" onclick="closeModal('activateModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>اسم المشترك</label>
                <input type="text" id="act-name" placeholder="ابحث..." oninput="searchSub(this.value)">
                <div id="search-results" style="max-height:100px; overflow-y:auto; border:1px solid #eee; display:none;"></div>
            </div>
            <div class="form-group">
                <label>السعر</label>
                <input type="number" id="act-price" value="35000">
            </div>
            <div class="form-group">
                <label>نوع الدفع</label>
                <select id="act-type">
                    <option value="نقد">نقد (واصل)</option>
                    <option value="أجل">أجل (دين)</option>
                </select>
            </div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>البدء</label>
                    <input type="date" id="act-start">
                </div>
                <div style="flex:1">
                    <label>الانتهاء</label>
                    <input type="date" id="act-end">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="printReceiptFromModal()" class="btn btn-secondary"><i class="fas fa-print"></i> طباعة وصل</button>
                <button onclick="saveActivation()" class="btn btn-primary">تفعيل وحفظ</button>
            </div>
        </div>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة صرفية</h3>
                <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>التفاصيل</label>
                <input type="text" id="exp-desc" placeholder="مثال: فاتورة كهرباء">
            </div>
            <div class="form-group">
                <label>المبلغ</label>
                <input type="number" id="exp-amount" placeholder="0">
            </div>
            <button onclick="saveExpense()" class="btn btn-danger" style="width:100%">حفظ</button>
        </div>
    </div>

    <script>
        // إعدادات أولية
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('ar-IQ');
        document.getElementById('act-start').value = today;
        const next = new Date(); next.setDate(next.getDate()+30);
        document.getElementById('act-end').value = next.toISOString().split('T')[0];

        // تحديث البيانات
        window.updateDashboard = function() {
            if (typeof DataManager === 'undefined') return;
            const stats = DataManager.getStats();
            document.getElementById('val-subs').innerText = stats.totalSubs;
            document.getElementById('val-debts').innerText = stats.debts.toLocaleString();
            document.getElementById('val-received').innerText = stats.received.toLocaleString();
            document.getElementById('val-expenses').innerText = stats.expenses.toLocaleString();
            document.getElementById('val-expired').innerText = stats.expired;
            document.getElementById('val-expiring').innerText = stats.expiring;
        };

        // نوافذ
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // بحث سريع
        window.searchSub = function(val) {
            const resDiv = document.getElementById('search-results');
            if(!val) { resDiv.style.display='none'; return; }
            const res = DataManager.searchSubscribers(val);
            resDiv.innerHTML = res.map(s => `<div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer" onclick="fill('${s.name}')">${s.name}</div>`).join('');
            resDiv.style.display = 'block';
        };
        window.fill = (n) => { document.getElementById('act-name').value=n; document.getElementById('search-results').style.display='none'; };

        // حفظ التفعيل
        window.saveActivation = function() {
            const name = document.getElementById('act-name').value;
            const price = document.getElementById('act-price').value;
            if(!name || !price) return alert('أكمل البيانات');
            
            const existing = DataManager.searchSubscribers(name).find(s => s.name===name);
            const data = {
                name, price: parseInt(price), paymentType: document.getElementById('act-type').value,
                subscribeDate: document.getElementById('act-start').value,
                expiryDate: document.getElementById('act-end').value,
                status: 'نشط'
            };

            if(existing) DataManager.updateSubscriber(existing.id, data);
            else DataManager.addSubscriber(data);
            
            closeModal('activateModal');
            alert('تم التفعيل');
        };

        // طباعة الوصل
        window.printReceiptFromModal = function() {
            const name = document.getElementById('act-name').value;
            const price = document.getElementById('act-price').value;
            const date = document.getElementById('act-start').value;
            
            if(!name) return alert('ادخل الاسم أولاً');

            const win = window.open('', '', 'width=400,height=600');
            win.document.write(`
                <html dir="rtl"><body style="font-family:Cairo; text-align:center; padding:20px;">
                    <h2>OK Computer</h2>
                    <p>وصل اشتراك انترنت</p>
                    <hr>
                    <p><strong>الاسم:</strong> ${name}</p>
                    <p><strong>المبلغ:</strong> ${parseInt(price).toLocaleString()} د.ع</p>
                    <p><strong>التاريخ:</strong> ${date}</p>
                    <hr>
                    <p>شكراً لاشتراككم معنا</p>
                    <script>window.print();window.close();<\/script>
                </body></html>
            `);
            win.document.close();
        };

        window.saveExpense = function() {
            const d = document.getElementById('exp-desc').value;
            const a = document.getElementById('exp-amount').value;
            if(d && a) {
                DataManager.addExpense({ description: d, amount: a, date: today });
                closeModal('expenseModal');
                alert('تم الحفظ');
            }
        };

        setTimeout(updateDashboard, 1000);
    </script>
</body>
</html>
