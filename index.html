<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="data-manager.js"></script>
    <style>
        /* ستايل النوافذ المنبثقة (Modals) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 20px; width: 95%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        /* ستايل الكروت لتكون قابلة للضغط */
        .stat-card { cursor: pointer; transition: transform 0.2s; display: block; text-decoration: none; }
        .stat-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-chart-line"></i> OK Computer</div>
        <ul class="nav-links">
            <li><a href="index.html" class="active"><i class="fas fa-home"></i> <span>الرئيسية</span></a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> <span>المشتركين</span></a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> <span>الديون</span></a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> <span>المبالغ</span></a></li>
            <li><a href="expenses.html"><i class="fas fa-file-invoice-dollar"></i> <span>الصرفيات</span></a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> <span>التقارير</span></a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header" style="background: linear-gradient(to left, #1e40af, #3b82f6); color: white;">
            <div>
                <h1 style="color:white; font-size: 24px;">أهلاً بك، المدير</h1>
                <span id="dateDisplay" style="opacity: 0.8; font-size: 14px;"></span>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openModal('activateModal')" class="btn" style="background: white; color: #1e40af;">
                    <i class="fas fa-check-circle"></i> تفعيل اشتراك
                </button>
                <button onclick="openModal('expenseModal')" class="btn" style="background: #ef4444; color: white;">
                    <i class="fas fa-receipt"></i> إضافة صرفية
                </button>
            </div>
        </div>

        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
            
            <a href="subscribers.html" class="stat-card">
                <h3 style="color:#1e40af"><i class="fas fa-users"></i> المشتركين</h3>
                <div class="value" id="val-subs">0</div>
            </a>

            <a href="debts.html" class="stat-card" style="border-bottom-color: #ef4444;">
                <h3 style="color:#ef4444"><i class="fas fa-money-bill"></i> الديون (أجل)</h3>
                <div class="value" id="val-debts">0</div>
            </a>

            <a href="payments.html" class="stat-card" style="border-bottom-color: #10b981;">
                <h3 style="color:#10b981"><i class="fas fa-hand-holding-usd"></i> الواردات</h3>
                <div class="value" id="val-received">0</div>
            </a>

            <a href="expenses.html" class="stat-card" style="border-bottom-color: #f59e0b;">
                <h3 style="color:#f59e0b"><i class="fas fa-file-invoice"></i> المصروفات</h3>
                <div class="value" id="val-expenses">0</div>
            </a>

            <a href="expired.html" class="stat-card" style="border-bottom-color: #6b7280;">
                <h3 style="color:#6b7280"><i class="fas fa-exclamation-circle"></i> المنتهية</h3>
                <div class="value" id="val-expired">0</div>
            </a>

            <a href="expiring.html" class="stat-card" style="border-bottom-color: #8b5cf6;">
                <h3 style="color:#8b5cf6"><i class="fas fa-clock"></i> قريباً</h3>
                <div class="value" id="val-expiring">0</div>
            </a>

        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="forceUpdate()" class="btn" style="background: #333; color: white; padding: 10px 30px;">
                <i class="fas fa-sync"></i> تحديث النظام
            </button>
        </div>
    </div>

    <div id="activateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تفعيل اشتراك جديد</h3>
                <button onclick="closeModal('activateModal')" style="background:none;border:none;font-size:20px;">&times;</button>
            </div>
            <div class="form-group">
                <label>اسم المشترك</label>
                <input type="text" id="act-name" placeholder="ابحث عن الاسم..." oninput="searchSub(this.value)">
                <div id="search-results" style="max-height:100px; overflow-y:auto; border:1px solid #eee; display:none;"></div>
            </div>
            <div class="form-group">
                <label>السعر</label>
                <input type="number" id="act-price" value="35000">
            </div>
            <div class="form-group">
                <label>نوع الدفع</label>
                <select id="act-type">
                    <option value="نقد">نقد (واصل)</option>
                    <option value="أجل">أجل (دين)</option>
                </select>
            </div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>تاريخ البدء</label>
                    <input type="date" id="act-start">
                </div>
                <div style="flex:1">
                    <label>تاريخ الانتهاء</label>
                    <input type="date" id="act-end">
                </div>
            </div>
            <button onclick="saveActivation()" class="btn btn-primary" style="width:100%">تفعيل وحفظ</button>
        </div>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة صرفية</h3>
                <button onclick="closeModal('expenseModal')" style="background:none;border:none;font-size:20px;">&times;</button>
            </div>
            <div class="form-group">
                <label>التفاصيل</label>
                <input type="text" id="exp-desc" placeholder="مثال: فاتورة انترنت">
            </div>
            <div class="form-group">
                <label>المبلغ</label>
                <input type="number" id="exp-amount" placeholder="0">
            </div>
            <button onclick="saveExpense()" class="btn btn-danger" style="width:100%">إضافة</button>
        </div>
    </div>

    <script>
        // إعداد التواريخ الافتراضية
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateDisplay').innerText = today;
        document.getElementById('act-start').value = today;
        
        const nextMonth = new Date();
        nextMonth.setDate(nextMonth.getDate() + 30);
        document.getElementById('act-end').value = nextMonth.toISOString().split('T')[0];

        // تحديث الواجهة
        window.updateDashboard = function() {
            if (typeof DataManager === 'undefined') return;
            const stats = DataManager.getStats();
            
            document.getElementById('val-subs').innerText = stats.totalSubs;
            document.getElementById('val-debts').innerText = stats.debts.toLocaleString();
            document.getElementById('val-received').innerText = stats.received.toLocaleString();
            document.getElementById('val-expenses').innerText = stats.expenses.toLocaleString();
            document.getElementById('val-expired').innerText = stats.expired;
            document.getElementById('val-expiring').innerText = stats.expiring;
        };

        // دوال النوافذ
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // البحث السريع في نافذة التفعيل
        window.searchSub = function(val) {
            const resDiv = document.getElementById('search-results');
            if(!val) { resDiv.style.display = 'none'; return; }
            
            const results = DataManager.searchSubscribers(val);
            resDiv.innerHTML = results.map(s => `
                <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;" 
                     onclick="fillSub('${s.name}')">
                     ${s.name}
                </div>
            `).join('');
            resDiv.style.display = 'block';
        };

        window.fillSub = function(name) {
            document.getElementById('act-name').value = name;
            document.getElementById('search-results').style.display = 'none';
        };

        // حفظ التفعيل
        window.saveActivation = function() {
            const name = document.getElementById('act-name').value;
            const price = document.getElementById('act-price').value;
            const type = document.getElementById('act-type').value;
            const start = document.getElementById('act-start').value;
            const end = document.getElementById('act-end').value;

            if(!name || !price) return alert('أكمل البيانات');

            // البحث عن المشترك لتحديثه أو إضافة جديد
            const existing = DataManager.searchSubscribers(name).find(s => s.name === name);
            
            const data = {
                name, 
                price: parseInt(price), 
                paymentType: type,
                subscribeDate: start, 
                expiryDate: end,
                status: 'نشط'
            };

            if(existing) {
                DataManager.updateSubscriber(existing.id, data);
            } else {
                DataManager.addSubscriber(data);
            }
            closeModal('activateModal');
            alert('تم التفعيل بنجاح');
        };

        // حفظ الصرفية
        window.saveExpense = function() {
            const desc = document.getElementById('exp-desc').value;
            const amount = document.getElementById('exp-amount').value;
            if(!desc || !amount) return alert('أكمل البيانات');

            DataManager.addExpense({
                description: desc,
                amount: parseInt(amount),
                date: new Date().toISOString().split('T')[0]
            });
            closeModal('expenseModal');
            document.getElementById('exp-desc').value = '';
            document.getElementById('exp-amount').value = '';
        };

        window.forceUpdate = function() {
            localStorage.clear();
            window.location.reload(true);
        };

        // التحميل
        setTimeout(updateDashboard, 1000);
    </script>
</body>
</html>
