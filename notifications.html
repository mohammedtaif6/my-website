<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=25.0">
    <link rel="stylesheet" href="style-fab.css?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="auth-system.js"></script>
    <script>AuthSystem.checkSession();</script>

    <script type="module">
        import { DataManager } from './data-manager.js';
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.DataManager = DataManager;
        DataManager.init();

        const SERVER_KEY = 'AIzaSyD_AKvTEuxPcJYc15Z7E8_cMgxx0cKh0Zk'; // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙŠ Ø­ØµÙ„Ù†Ø§ Ø¹Ù„ÙŠÙ‡

        window.loadEmployeesForNotify = async function () {
            const select = document.getElementById('employee-select');
            select.innerHTML = '<option value="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';

            try {
                // Fetch fresh data explicitly
                const querySnapshot = await getDocs(collection(DataManager.db, "employees"));
                select.innerHTML = '<option value="all">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</option>';

                let count = 0;
                querySnapshot.forEach((doc) => {
                    const emp = doc.data();
                    if (emp.fcmToken) {
                        const option = document.createElement('option');
                        option.value = emp.fcmToken;
                        option.textContent = `ğŸ‘¤ ${emp.name} (Ù…ØªØµÙ„)`;
                        select.appendChild(option);
                        count++;
                    } else {
                        // Optional: Show offline employees or skip
                        // const option = document.createElement('option');
                        // option.value = "";
                        // option.disabled = true;
                        // option.textContent = `âšª ${emp.name} (ØºÙŠØ± Ù…ÙØ¹Ù„)`;
                        // select.appendChild(option);
                    }
                });

                if (count === 0) {
                    const option = document.createElement('option');
                    option.textContent = "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…ÙØ¹Ù„ÙŠÙ† Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª";
                    option.disabled = true;
                    select.appendChild(option);
                }

            } catch (error) {
                console.error("Error loading employees:", error);
                select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
            }
        };

        window.sendPushNotification = async function () {
            const btn = document.getElementById('send-btn');
            const target = document.getElementById('employee-select').value;
            const title = document.getElementById('notif-title').value;
            const body = document.getElementById('notif-body').value;

            if (!title || !body) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ');
                return;
            }

            if (!target || target === 'loading') {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù…');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            let tokens = [];
            if (target === 'all') {
                // Collect all tokens via options
                const options = document.getElementById('employee-select').options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value && options[i].value !== 'all' && options[i].value !== 'loading') {
                        tokens.push(options[i].value);
                    }
                }
            } else {
                tokens.push(target);
            }

            if (tokens.length === 0) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… ØªÙˆÙƒÙ† ØªÙØ¹ÙŠÙ„!');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±';
                return;
            }

            let successCount = 0;

            // Send to each token (Legacy HTTP API doesn't support batch nicely in client-side reliably without CORS issues sometimes, but loop is fine for small count)
            // Actually, multicast is possible with 'registration_ids' parameter in JSON!

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… CORS Proxy Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø£Ù…Ù†ÙŠ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
                const proxyUrl = 'https://corsproxy.io/?';
                const targetUrl = 'https://fcm.googleapis.com/fcm/send';

                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
                    method: 'POST',
                    headers: {
                        'Authorization': 'key=' + SERVER_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        registration_ids: tokens, // Array of tokens
                        notification: {
                            title: title,
                            body: body,
                            icon: 'icons/icon-192x192.png',
                            sound: 'default'
                        },
                        priority: 'high'
                    })
                });

                const data = await response.json();
                console.log('FCM Response:', data);

                if (data.success > 0) {
                    alert(`âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${data.success} Ø¬Ù‡Ø§Ø²!`);
                    document.getElementById('notif-title').value = '';
                    document.getElementById('notif-body').value = '';
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + JSON.stringify(data.results));
                }

            } catch (error) {
                console.error('Error sending notification:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±';
        };

        // Initialize
        window.onload = loadEmployeesForNotify;
    </script>
</head>

<body>

    <button class="menu-btn" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-right"></i>
    </button>

    <div class="container" style="padding-top: 60px;">
        <div class="card fade-in">
            <h2 style="color: var(--primary); margin-bottom: 20px; text-align: center;">
                <i class="fas fa-broadcast-tower"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            </h2>

            <div class="form-group">
                <label>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                <select id="employee-select" class="form-control">
                    <option value="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...</option>
                </select>
            </div>

            <div class="form-group">
                <label>ğŸ“Œ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡:</label>
                <input type="text" id="notif-title" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ Ù‡Ø§Ù…">
            </div>

            <div class="form-group">
                <label>ğŸ“ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                <textarea id="notif-body" class="form-control" rows="4"
                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡Ù†Ø§..."></textarea>
            </div>

            <button id="send-btn" onclick="sendPushNotification()" class="btn-primary"
                style="width: 100%; margin-top: 20px;">
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            </button>

            <p style="margin-top: 15px; font-size: 0.85rem; color: #666; text-align: center;">
                â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØµÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù‚Ø§Ù…ÙˆØ§ Ø¨ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.
            </p>
        </div>
    </div>

</body>

</html>