<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المشتركين - لوحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <a href="index.html" class="flex items-center space-x-2 text-white font-bold text-lg hover:opacity-90">
                        <i class="fas fa-chart-line text-2xl"></i>
                        <span>OKComputer</span>
                    </a>
                    <div class="hidden md:flex space-x-1">
                        <a href="index.html" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
                            <i class="fas fa-home ml-2"></i>الرئيسية
                        </a>
                        <a href="subscribers.html" class="text-white bg-white bg-opacity-20 px-3 py-2 rounded-lg transition-all font-medium">
                            <i class="fas fa-users ml-2"></i>المشتركين
                        </a>
                        <a href="debts.html" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
                            <i class="fas fa-credit-card ml-2"></i>الديون
                        </a>
                        <a href="payments.html" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
                            <i class="fas fa-money-bill ml-2"></i>المبالغ المستلمة
                        </a>
                        <a href="expired.html" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
                            <i class="fas fa-exclamation-triangle ml-2"></i>منتهية
                        </a>
                        <a href="expiring.html" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
                            <i class="fas fa-hourglass-half ml-2"></i>قريبة
                        </a>
                        <a href="reports.html" class="text-white hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
                            <i class="fas fa-chart-bar ml-2"></i>التقارير
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white font-bold hover:bg-opacity-30 cursor-pointer">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <h1 class="text-4xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-users text-blue-600 ml-3 text-3xl"></i>
                المشتركين
            </h1>
            <p class="text-gray-600 mt-2">إدارة ومتابعة المشتركين وبيانات الاشتراكات</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-wrap gap-3 mb-8">
            <button onclick="openAddModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-plus"></i>
                إضافة مشترك جديد
            </button>
            <button onclick="openActivateModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-check"></i>
                تفعيل اشتراك
            </button>
            <button onclick="exportData()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-download"></i>
                تصدير CSV
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg p-6 shadow-sm border-r-4 border-blue-600">
                <p class="text-sm text-gray-600">إجمالي المشتركين</p>
                <p class="text-2xl font-bold text-gray-900" id="total-count">0</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border-r-4 border-green-600">
                <p class="text-sm text-gray-600">نشط</p>
                <p class="text-2xl font-bold text-gray-900" id="active-count">0</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border-r-4 border-orange-600">
                <p class="text-sm text-gray-600">قيد الانتظار</p>
                <p class="text-2xl font-bold text-gray-900" id="pending-count">0</p>
            </div>
            
            <div class="bg-white rounded-lg p-6 shadow-sm border-r-4 border-red-600">
                <p class="text-sm text-gray-600">منتهي</p>
                <p class="text-2xl font-bold text-gray-900" id="expired-count">0</p>
            </div>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-sm mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-48">
                    <input type="text" id="search" placeholder="بحث عن اسم أو هاتف..." 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeyup="loadSubscribers()">
                </div>
                <select id="filter-status" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="loadSubscribers()">
                    <option value="">جميع الحالات</option>
                    <option value="نشط">نشط</option>
                    <option value="قيد الانتظار">قيد الانتظار</option>
                    <option value="غير نشط">غير نشط</option>
                </select>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-right p-4 font-semibold text-gray-700">#</th>
                            <th class="text-right p-4 font-semibold text-gray-700">الاسم</th>
                            <th class="text-right p-4 font-semibold text-gray-700">الهاتف</th>
                            <th class="text-right p-4 font-semibold text-gray-700">تاريخ الاشتراك</th>
                            <th class="text-right p-4 font-semibold text-gray-700">انتهاء الاشتراك</th>
                            <th class="text-right p-4 font-semibold text-gray-700">الحالة</th>
                            <th class="text-right p-4 font-semibold text-gray-700">السعر</th>
                            <th class="text-right p-4 font-semibold text-gray-700">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="subscribers-body" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="flex justify-between items-center p-4 border-t border-gray-200">
                <div class="text-sm text-gray-600">
                    عرض <span id="page-info">0</span> سجل
                </div>
                <div class="flex space-x-2">
                    <button onclick="previousPage()" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <span id="current-page" class="px-3 py-2 bg-blue-600 text-white rounded-lg">1</span>
                    <button onclick="nextPage()" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">إضافة مشترك جديد</h2>
                <button onclick="closeAddModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form onsubmit="saveNewSubscriber(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">الاسم *</label>
                    <input type="text" id="add-name" required placeholder="أدخل الاسم الكامل" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">الهاتف</label>
                    <input type="text" id="add-phone" placeholder="رقم الهاتف" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeAddModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        إلغاء
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-save ml-2"></i>
                        حفظ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">تعديل بيانات المشترك</h2>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form onsubmit="saveEditSubscriber(event)">
                <input type="hidden" id="edit-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">الاسم *</label>
                    <input type="text" id="edit-name" required class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">الهاتف</label>
                    <input type="text" id="edit-phone" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        إلغاء
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-save ml-2"></i>
                        حفظ التعديلات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="activateModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">تفعيل اشتراك جديد</h2>
                <button onclick="closeActivateModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form onsubmit="activateSubscription(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم المشترك *</label>
                    <input type="text" id="act-name" required placeholder="أدخل اسم المشترك" 
                           class="w-full p-3 border border-gray-300 rounded-lg"
                           oninput="searchSubscriber()">
                    <div id="subscriber-suggestions" class="mt-2 border border-gray-300 rounded-lg max-h-48 overflow-y-auto hidden">
                        <div id="suggestions-list"></div>
                    </div>
                    <div id="subscriber-info" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <p><span class="font-medium">الهاتف:</span> <span id="info-phone" class="text-gray-700"></span></p>
                        <p><span class="font-medium">الحالة الحالية:</span> <span id="info-status" class="text-gray-700"></span></p>
                    </div>
                </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">سعر الاشتراك *</label>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <button type="button" class="price-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-blue-600 font-medium" onclick="selectPrice(35000, this)">
                                35,000 د.ع
                            </button>
                            <button type="button" class="price-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-blue-600 font-medium" onclick="selectPrice(30000, this)">
                                30,000 د.ع
                            </button>
                            <button type="button" class="price-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-blue-600 font-medium" onclick="toggleCustomPrice(this)">
                                مخصص
                            </button>
                        </div>
                        <input type="hidden" id="selected-price">
                        <input type="number" id="custom-price" placeholder="السعر المخصص" class="w-full p-3 border border-gray-300 rounded-lg hidden" step="1000">
                    </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع الدفع *</label>
                    <select id="payment-type" required class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="">اختر نوع الدفع</option>
                        <option value="نقد">نقد</option>
                        <option value="أجل">أجل</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الاشتراك</label>
                        <input type="date" id="sub-date" disabled class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ الانتهاء</label>
                        <input type="date" id="exp-date" disabled class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeActivateModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        إلغاء
                    </button>
                    <button type="button" onclick="printReceipt()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        <i class="fas fa-print ml-2"></i>
                        طباعة
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-check ml-2"></i>
                        تفعيل
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="data-manager.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let allSubscribers = [];
        let filteredSubscribers = [];

        // تحميل البيانات وعرض الجدول
        function loadSubscribers() {
            const search = document.getElementById('search').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;

            // حماية ضد البيانات الفارغة
            allSubscribers = DataManager.getSubscribers() || [];
            
            filteredSubscribers = allSubscribers.filter(s => {
                if (!s) return false;
                const name = (s.name || '').toLowerCase();
                const phone = (s.phone || '').toString();
                
                const matchesSearch = !search || 
                    name.includes(search) ||
                    phone.includes(search);
                
                const matchesStatus = !statusFilter || s.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });

            currentPage = 1;
            renderTable();
            updateStats();
        }

        // رسم الجدول مع إضافة زر التعديل
        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredSubscribers.slice(start, end);

            const tbody = document.getElementById('subscribers-body');
            tbody.innerHTML = pageData.map((s, idx) => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${start + idx + 1}</td>
                    <td class="p-4 font-medium">${s.name || 'بدون اسم'}</td>
                    <td class="p-4 text-gray-600">${s.phone || '-'}</td>
                    <td class="p-4 text-gray-600">${s.subscribeDate || '-'}</td>
                    <td class="p-4 text-gray-600">${s.expiryDate || '-'}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(s.status)}">
                            ${s.status || 'غير محدد'}
                        </span>
                    </td>
                    <td class="p-4 font-bold text-blue-600">${(s.price || 0).toLocaleString()} د.ع</td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button onclick="openEditModal(${s.id})" class="text-blue-600 hover:text-blue-800 text-sm" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSubscriber(${s.id})" class="text-red-600 hover:text-red-800 text-sm" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('page-info').textContent = `${start + 1}-${Math.min(end, filteredSubscribers.length)} من ${filteredSubscribers.length}`;
            document.getElementById('current-page').textContent = currentPage;
        }

        function updateStats() {
            const stats = DataManager.getStatistics();
            document.getElementById('total-count').textContent = stats.totalSubscribers;
            document.getElementById('active-count').textContent = stats.activeSubscribers;
            document.getElementById('pending-count').textContent = stats.pendingSubscribers;
            document.getElementById('expired-count').textContent = stats.expiredSubscribers;
        }

        function getStatusColor(status) {
            const colors = {
                'نشط': 'bg-green-100 text-green-800',
                'قيد الانتظار': 'bg-orange-100 text-orange-800',
                'غير نشط': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        // --- إدارة النوافذ المنبثقة (Modals) ---

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('add-name').value = '';
            document.getElementById('add-phone').value = '';
        }

        function saveNewSubscriber(e) {
            e.preventDefault();
            const name = document.getElementById('add-name').value;
            const phone = document.getElementById('add-phone').value;

            DataManager.addSubscriber({ name, phone });
            loadSubscribers();
            closeAddModal();
        }

        // --- وظائف التعديل الجديدة (Edit) ---
        function openEditModal(id) {
            const subscriber = DataManager.getSubscriber(id);
            if(subscriber) {
                document.getElementById('edit-id').value = subscriber.id;
                document.getElementById('edit-name').value = subscriber.name;
                document.getElementById('edit-phone').value = subscriber.phone;
                document.getElementById('editModal').classList.add('active');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveEditSubscriber(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-id').value);
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;

            DataManager.updateSubscriber(id, { name, phone });
            loadSubscribers();
            closeEditModal();
            alert('تم تعديل البيانات بنجاح');
        }

        // --- وظائف تفعيل الاشتراك (مع إصلاح البحث) ---

        function openActivateModal() {
            document.getElementById('activateModal').classList.add('active');
            setDefaultDates();
        }

        function closeActivateModal() {
            document.getElementById('activateModal').classList.remove('active');
            resetActivateForm();
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const expiry = new Date();
            expiry.setDate(expiry.getDate() + 30);
            const expiryStr = expiry.toISOString().split('T')[0];

            document.getElementById('sub-date').value = today;
            document.getElementById('exp-date').value = expiryStr;
        }

        function selectPrice(price, btn) {
            document.querySelectorAll('.price-btn').forEach(b => b.classList.remove('border-blue-600', 'bg-blue-50'));
            btn.classList.add('border-blue-600', 'bg-blue-50');
            document.getElementById('selected-price').value = price;
            document.getElementById('custom-price').classList.add('hidden');
        }

        function toggleCustomPrice(btn) {
            const customInput = document.getElementById('custom-price');
            const isHidden = customInput.classList.contains('hidden');
            
            document.querySelectorAll('.price-btn').forEach(b => b.classList.remove('border-blue-600', 'bg-blue-50'));
            if (isHidden) {
                btn.classList.add('border-blue-600', 'bg-blue-50');
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        }

        // دالة البحث المصححة (تمنع توقف النظام)
        function searchSubscriber() {
            const input = document.getElementById('act-name').value.trim();
            const suggestionBox = document.getElementById('subscriber-suggestions');
            const infoBox = document.getElementById('subscriber-info');
            
            if (!input) {
                suggestionBox.classList.add('hidden');
                infoBox.classList.add('hidden');
                return;
            }

            let results = [];
            try {
                results = DataManager.searchSubscribers(input);
            } catch (e) {
                // بحث احتياطي يدوي في حال فشل DataManager
                const all = DataManager.getSubscribers() || [];
                const q = input.toLowerCase();
                results = all.filter(s => (s.name || '').toLowerCase().includes(q));
            }
            
            if (results.length === 0) {
                suggestionBox.classList.add('hidden');
                infoBox.classList.add('hidden');
                return;
            }

            const suggestionsList = document.getElementById('suggestions-list');
            // استخدام ID بدلاً من الاسم في دالة النقر (الحل النهائي للمشكلة)
            suggestionsList.innerHTML = results.map(s => `
                <div class="p-3 border-b border-gray-200 hover:bg-gray-100 cursor-pointer" onclick="selectSubscriber(${s.id})">
                    <div class="font-medium">${s.name}</div>
                    <div class="text-sm text-gray-600">الهاتف: ${s.phone || 'غير متوفر'} | الحالة: ${s.status}</div>
                </div>
            `).join('');

            suggestionBox.classList.remove('hidden');

            if (results.length === 1) {
                showSubscriberInfo(results[0]);
            }
        }

        function selectSubscriber(id) {
            const subscriber = DataManager.getSubscriber(id);
            
            if (subscriber) {
                document.getElementById('act-name').value = subscriber.name;
                document.getElementById('subscriber-suggestions').classList.add('hidden');
                showSubscriberInfo(subscriber);
            }
        }

        function activateSubscription(e) {
            e.preventDefault();
            const name = document.getElementById('act-name').value;
            const priceInput = document.getElementById('selected-price').value || document.getElementById('custom-price').value;
            const price = parseInt(priceInput) || 0;
            const paymentType = document.getElementById('payment-type').value;
            const subscribeDate = document.getElementById('sub-date').value;
            const expiryDate = document.getElementById('exp-date').value;

            if (!price) return;

            let existing = null;
            try {
                const results = DataManager.searchSubscribers(name);
                existing = results.find(s => s.name === name);
            } catch(e) {}

            if (existing) {
                DataManager.updateSubscriber(existing.id, {
                    price, paymentType, subscribeDate, expiryDate,
                    status: 'نشط'
                });
            } else {
                DataManager.addSubscriber({
                    name, price, paymentType, subscribeDate, expiryDate,
                    status: 'نشط'
                });
            }

            loadSubscribers();
            closeActivateModal();
        }

        function showSubscriberInfo(subscriber) {
            if (!subscriber) return;
            document.getElementById('info-phone').textContent = subscriber.phone || 'غير متوفر';
            document.getElementById('info-status').textContent = subscriber.status || 'قيد الانتظار';
            document.getElementById('subscriber-info').classList.remove('hidden');
        }

        function printReceipt() {
            const name = document.getElementById('act-name').value;
            const price = document.getElementById('selected-price').value || document.getElementById('custom-price').value;
            const paymentType = document.getElementById('payment-type').value;
            const subscribeDate = document.getElementById('sub-date').value;
            const expiryDate = document.getElementById('exp-date').value;

            if (!name || !price) return;

            // محاولة جلب الهاتف
            let phone = 'غير متوفر';
            try {
                const results = DataManager.searchSubscribers(name);
                const sub = results.find(s => s.name === name);
                if (sub) phone = sub.phone;
            } catch(e) {}

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>إيصال</title>
                    <style>
                        body { font-family: Arial; direction: rtl; text-align: right; }
                        .receipt { border: 2px solid #333; padding: 20px; max-width: 300px; margin: 20px auto; }
                        h1 { text-align: center; }
                        .line { display: flex; justify-content: space-between; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <h1>إيصال تفعيل</h1>
                        <div class="line"><span>الاسم:</span><span>${name}</span></div>
                        <div class="line"><span>الهاتف:</span><span>${phone}</span></div>
                        <div class="line"><span>السعر:</span><span>${price} د.ع</span></div>
                        <div class="line"><span>الدفع:</span><span>${paymentType}</span></div>
                        <div class="line"><span>من:</span><span>${subscribeDate}</span></div>
                        <div class="line"><span>إلى:</span><span>${expiryDate}</span></div>
                        <hr style="border: 1px solid #333;">
                        <div class="line" style="font-weight: bold;"><span>المجموع:</span><span>${price} د.ع</span></div>
                    </div>
                </body>
                </html>
            `;

            const w = window.open();
            w.document.write(printContent);
            w.document.close();
            setTimeout(() => w.print(), 100);
        }

        function resetActivateForm() {
            document.getElementById('act-name').value = '';
            document.getElementById('payment-type').value = '';
            document.getElementById('selected-price').value = '';
            document.getElementById('custom-price').value = '';
            document.getElementById('subscriber-suggestions').classList.add('hidden');
            document.getElementById('subscriber-info').classList.add('hidden');
            document.querySelectorAll('.price-btn').forEach(b => b.classList.remove('border-blue-600', 'bg-blue-50'));
        }

        function deleteSubscriber(id) {
            if (confirm('هل تريد حذف هذا المشترك؟')) {
                DataManager.deleteSubscriber(id);
                loadSubscribers();
            }
        }

        function exportData() {
            const data = filteredSubscribers.map(s => ({
                'الاسم': s.name,
                'الهاتف': s.phone,
                'تاريخ الاشتراك': s.subscribeDate,
                'انتهاء الاشتراك': s.expiryDate,
                'الحالة': s.status,
                'السعر': s.price
            }));
            DataManager.exportToCSV(data, 'subscribers');
        }

        window.onclick = function(e) {
            const addModal = document.getElementById('addModal');
            const activateModal = document.getElementById('activateModal');
            const editModal = document.getElementById('editModal');
            if (e.target === addModal) closeAddModal();
            if (e.target === activateModal) closeActivateModal();
            if (e.target === editModal) closeEditModal();
        };

        function previousPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { 
            const totalPages = Math.ceil(filteredSubscribers.length / itemsPerPage);
            if (currentPage < totalPages) { currentPage++; renderTable(); } 
        }

        document.addEventListener('DOMContentLoaded', loadSubscribers);
    </script>
</body>
</html>
