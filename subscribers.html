<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المشتركين - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-users"></i> المشتركين
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="subscribers.html" class="active"><i class="fas fa-users"></i> المشتركين</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> المبالغ</a></li>
            <li><a href="expenses.html"><i class="fas fa-file-invoice-dollar"></i> الصرفيات</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-card">
            <div>
                <h1>إدارة المشتركين</h1>
                <p>قائمة بجميع المشتركين في النظام</p>
            </div>
            <div>
                <button onclick="openAddModal()" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> إضافة مشترك
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <input type="text" id="search" placeholder="بحث بالاسم أو الهاتف..." class="form-group"
                    style="width:100%; margin:0; border:none; box-shadow:none; padding:5px; font-size:1.1rem; outline:none;"
                    onkeyup="renderPage()">
                <i class="fas fa-search" style="color:var(--secondary);"></i>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>سجل المشتركين</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الحالة</th>
                            <th>الدين</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Add Subscriber -->
    <div id="addSubscriberModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>إضافة مشترك جديد</h3>
                <button class="close-btn" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>الاسم الكامل</label>
                    <input type="text" id="new-name" placeholder="ادخل الاسم">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" id="new-phone" placeholder="07..." pattern="[0-9]{11}" maxlength="11"
                        title="أدخل رقم هاتف عراقي صحيح (11 رقم)">
                </div>
                <div class="form-group">
                    <label>الدين السابق (إن وجد)</label>
                    <input type="number" id="new-price" value="0">
                </div>
                <button onclick="saveNewSubscriber()" class="btn btn-primary btn-full" id="saveSubBtn">
                    <i class="fas fa-save"></i> حفظ البيانات
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Subscriber Actions (Professional) -->
    <div id="actionModal" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <div class="modal-header">
                <h3 id="actionSubName">خيارات المشترك</h3>
                <button class="close-btn" onclick="closeActionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <button onclick="actionActivate()" class="btn btn-success"
                        style="padding: 20px; flex-direction: column; gap: 10px;">
                        <i class="fas fa-wifi" style="font-size: 2rem;"></i>
                        <span>تفعيل / تجديد</span>
                    </button>
                    <button onclick="actionEdit()" class="btn btn-primary"
                        style="padding: 20px; flex-direction: column; gap: 10px;">
                        <i class="fas fa-edit" style="font-size: 2rem;"></i>
                        <span>تعديل بيانات</span>
                    </button>
                </div>
                <!-- Call Button -->
                <button onclick="actionCall()" class="btn btn-success btn-full" id="callBtn"
                    style="margin-bottom: 15px; display: none;">
                    <i class="fas fa-phone"></i> اتصال بالمشترك
                </button>
                <button onclick="actionDelete()" class="btn btn-outline btn-full"
                    style="color: var(--danger); border-color: var(--danger);">
                    <i class="fas fa-trash"></i> حذف المشترك
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Quick Activate -->
    <div id="quickActivateModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>تجديد الاشتراك</h3>
                <button class="close-btn" onclick="closeQuickActivate()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qa-id">
                <input type="hidden" id="qa-fid">
                <div class="form-group">
                    <label>المبلغ المطلوب</label>
                    <input type="number" id="qa-price" value="35000">
                </div>
                <div class="form-group">
                    <label>طريقة الدفع</label>
                    <select id="qa-type">
                        <option value="نقد">نقد (واصل)</option>
                        <option value="أجل">أجل (دين)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ينتهي في</label>
                    <input type="date" id="qa-end">
                </div>
                <button onclick="saveQuickActivate()" class="btn btn-success btn-full">تجديد الآن</button>
            </div>
        </div>
    </div>

    <script>
        let selectedSubscriber = null;

        window.renderPage = function () {
            if (typeof DataManager === 'undefined') return;
            const q = document.getElementById('search').value;
            const subs = DataManager.searchSubscribers(q);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (subs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:var(--secondary);">لا توجد بيانات للعرض</td></tr>';
                return;
            }

            subs.forEach(s => {
                let statusClass = s.status === 'نشط' ? 'badge badge-success' : 'badge badge-warning';
                let debtClass = s.price > 0 ? 'text-danger' : 'text-success';

                // Add click event to the row
                tbody.innerHTML += `
                    <tr onclick="openActionModal('${s.id}')" style="cursor: pointer;">
                        <td data-label="الاسم" style="font-weight:bold;">${s.name}</td>
                        <td data-label="الهاتف">${s.phone || '-'}</td>
                        <td data-label="الحالة"><span class="${statusClass}">${s.status || 'غير محدد'}</span></td>
                        <td data-label="الدين" class="${debtClass}" style="font-weight:bold;">
                            ${parseInt(s.price || 0).toLocaleString()}
                        </td>
                    </tr>
                `;
            });
        };

        // Open Action Modal
        window.openActionModal = function (id) {
            selectedSubscriber = DataManager.getSubscriber(id);
            if (!selectedSubscriber) return;

            document.getElementById('actionSubName').innerText = selectedSubscriber.name;

            // Show/hide call button based on phone availability
            const callBtn = document.getElementById('callBtn');
            if (selectedSubscriber.phone && selectedSubscriber.phone.trim()) {
                callBtn.style.display = 'block';
            } else {
                callBtn.style.display = 'none';
            }

            document.getElementById('actionModal').classList.add('active');
        };

        window.closeActionModal = () => document.getElementById('actionModal').classList.remove('active');

        // Action: Call Subscriber
        window.actionCall = function () {
            if (!selectedSubscriber || !selectedSubscriber.phone) return;
            window.location.href = 'tel:' + selectedSubscriber.phone;
        };

        // Action Handlers
        window.actionActivate = function () {
            closeActionModal();
            // Open Quick Activate Modal
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);

            document.getElementById('qa-id').value = selectedSubscriber.id;
            document.getElementById('qa-fid').value = selectedSubscriber.firebaseId;
            document.getElementById('qa-end').value = nextMonth.toISOString().split('T')[0];
            document.getElementById('quickActivateModal').classList.add('active');
        };

        window.closeQuickActivate = () => document.getElementById('quickActivateModal').classList.remove('active');

        window.saveQuickActivate = async function () {
            const fid = document.getElementById('qa-fid').value;
            const id = document.getElementById('qa-id').value;
            const price = document.getElementById('qa-price').value;
            const type = document.getElementById('qa-type').value;
            const end = document.getElementById('qa-end').value;

            try {
                await DataManager.renewSubscription(fid, id, {
                    price: parseInt(price),
                    type: type,
                    dateEnd: end
                });
                closeQuickActivate();
                alert('تم التجديد بنجاح');
            } catch (e) {
                alert('خطأ');
            }
        };

        window.actionEdit = async function () {
            closeActionModal();
            const newName = prompt("تعديل الاسم:", selectedSubscriber.name);
            const newPhone = prompt("تعديل الهاتف:", selectedSubscriber.phone);

            if (newName && newName !== selectedSubscriber.name || newPhone !== selectedSubscriber.phone) {
                await DataManager.updateSubscriber(selectedSubscriber.id, { name: newName, phone: newPhone });
            }
        };

        window.actionDelete = async function () {
            closeActionModal();
            await DataManager.deleteSubscriber(selectedSubscriber.id);
        };

        window.openAddModal = () => document.getElementById('addSubscriberModal').classList.add('active');
        window.closeAddModal = () => document.getElementById('addSubscriberModal').classList.remove('active');

        window.saveNewSubscriber = async function () {
            const btn = document.getElementById('saveSubBtn');
            const name = document.getElementById('new-name').value;
            const phone = document.getElementById('new-phone').value;
            const price = document.getElementById('new-price').value || 0;

            if (!name) return alert('يجب كتابة الاسم على الأقل');

            btn.disabled = true;
            btn.innerHTML = 'جاري الحفظ...';

            try {
                await DataManager.addSubscriber({
                    name: name,
                    phone: phone,
                    initialPrice: parseInt(price),
                    status: 'نشط',
                    paymentType: parseInt(price) > 0 ? 'أجل' : 'نقد',
                    expiryDate: ''
                });

                closeAddModal();
                document.getElementById('new-name').value = '';
                document.getElementById('new-phone').value = '';
            } catch (e) {
                alert('خطأ');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> حفظ البيانات';
            }
        };

        window.loading = false;
        window.updatePageData = window.renderPage;
        setInterval(() => { if (typeof DataManager !== 'undefined') renderPage(); }, 1000);
    </script>
</body>

</html>