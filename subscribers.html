<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المشتركين - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-users"></i> المشتركين</div>
        <ul class="nav-links">
            <li><a href="index.html">الرئيسية</a></li>
            <li><a href="subscribers.html" class="active">المشتركين</a></li>
            <li><a href="debts.html">الديون</a></li>
            <li><a href="payments.html">المبالغ</a></li>
            <li><a href="expenses.html">الصرفيات</a></li>
            <li><a href="reports.html">التقارير</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-card">
            <h1>قائمة المشتركين</h1>
            <button onclick="window.openAddModal()" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> إضافة مشترك
            </button>
        </div>

        <div class="search-box-container" style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="بحث بالاسم أو الهاتف..." 
                   class="form-group input" style="width: 100%; padding: 12px;"
                   onkeyup="window.renderSubscribers()">
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الهاتف</th>
                        <th>الحالة</th>
                        <th>السعر</th>
                        <th>تحكم</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="addModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>إضافة مشترك جديد</h3>
                <button onclick="window.closeAddModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>الاسم</label>
                    <input type="text" id="new-name" placeholder="الاسم الكامل">
                </div>
                <div class="form-group">
                    <label>الهاتف</label>
                    <input type="text" id="new-phone" placeholder="07...">
                </div>
                <button onclick="window.saveNewSubscriber()" class="btn btn-full btn-primary">حفظ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager; // الربط المهم

        window.renderSubscribers = function() {
            const q = document.getElementById('searchInput').value;
            const subs = DataManager.searchSubscribers(q);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (subs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">لا توجد نتائج</td></tr>';
                return;
            }

            subs.forEach(s => {
                let statusColor = s.status === 'نشط' ? 'var(--success)' : 'var(--warning)';
                tbody.innerHTML += `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.phone || '-'}</td>
                        <td style="color:${statusColor}; font-weight:bold;">${s.status || 'غير محدد'}</td>
                        <td>${(s.price || 0).toLocaleString()}</td>
                        <td>
                            <button onclick="window.editSub('${s.id}')" class="btn btn-primary" style="padding:5px 10px;"><i class="fas fa-edit"></i></button>
                            <button onclick="window.deleteSub('${s.id}')" class="btn btn-danger" style="padding:5px 10px;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.openAddModal = () => document.getElementById('addModal').classList.add('active');
        window.closeAddModal = () => document.getElementById('addModal').classList.remove('active');

        window.saveNewSubscriber = async function() {
            const name = document.getElementById('new-name').value;
            const phone = document.getElementById('new-phone').value;
            if(!name) return alert('الاسم مطلوب');

            await DataManager.addSubscriber({
                name, phone, price: 0, status: 'قيد الانتظار', paymentType: 'نقد',
                startDate: new Date().toISOString().split('T')[0]
            });
            window.closeAddModal();
            alert('تمت الإضافة');
        };

        window.editSub = async function(id) {
            const s = DataManager.getSubscribers().find(x => x.id == id);
            const newPrice = prompt("تعديل السعر:", s.price);
            if(newPrice !== null) {
                await DataManager.updateSubscriber(id, { price: parseInt(newPrice) || 0 });
            }
        };

        window.deleteSub = async function(id) {
            await DataManager.deleteSubscriber(id);
        };

        // دالة التحديث التلقائي
        window.renderPage = window.renderSubscribers;
        
        // التحميل الأولي
        setTimeout(window.renderSubscribers, 500);
    </script>
</body>
</html>
