<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المشتركين - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=11.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-users"></i> المشتركين
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="subscribers.html" class="active"><i class="fas fa-users"></i> المشتركين</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> المبالغ</a></li>
            <li><a href="expenses.html"><i class="fas fa-file-invoice-dollar"></i> الصرفيات</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
        </ul>
    </nav>

    <div class="container">

        <div class="header-card">
            <div>
                <h1>إدارة المشتركين</h1>
                <p>قائمة بجميع المشتركين في النظام</p>
            </div>
            <div>
                <button onclick="openAddModal()" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> إضافة مشترك
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <input type="text" id="search" placeholder="بحث بالاسم أو الهاتف..." class="form-group"
                    style="width:100%; margin:0; border:none; box-shadow:none; padding:5px; font-size:1.1rem; outline:none;"
                    onkeyup="renderPage()">
                <i class="fas fa-search" style="color:var(--secondary);"></i>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>سجل المشتركين</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الحالة</th>
                            <th>السعر</th>
                            <th>تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Add Subscriber -->
    <div id="addSubscriberModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>إضافة مشترك جديد</h3>
                <button class="close-btn" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>الاسم الكامل</label>
                    <input type="text" id="new-name" placeholder="ادخل الاسم">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" id="new-phone" placeholder="07...">
                </div>
                <!-- Default hidden fields or just defaults -->
                <button onclick="saveNewSubscriber()" class="btn btn-primary btn-full" id="saveSubBtn">
                    <i class="fas fa-save"></i> حفظ البيانات
                </button>
            </div>
        </div>
    </div>

    <script>
        window.renderPage = function () {
            if (typeof DataManager === 'undefined') return;
            const q = document.getElementById('search').value;
            const subs = DataManager.searchSubscribers(q);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (subs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--secondary);">لا توجد بيانات للعرض</td></tr>';
                return;
            }

            subs.forEach(s => {
                let statusClass = s.status === 'نشط' ? 'badge badge-success' : 'badge badge-warning';

                tbody.innerHTML += `
                    <tr>
                        <td data-label="الاسم" style="font-weight:bold;">${s.name}</td>
                        <td data-label="الهاتف">${s.phone || '-'}</td>
                        <td data-label="الحالة"><span class="${statusClass}">${s.status || 'غير محدد'}</span></td>
                        <td data-label="السعر" style="font-weight:bold;">${parseInt(s.price || 0).toLocaleString()}</td>
                        <td data-label="تحكم">
                            <button onclick="editSub('${s.id}')" class="btn btn-outline" style="padding:5px 10px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="DataManager.deleteSubscriber('${s.id}')" class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        };

        window.openAddModal = () => document.getElementById('addSubscriberModal').classList.add('active');
        window.closeAddModal = () => document.getElementById('addSubscriberModal').classList.remove('active');

        window.saveNewSubscriber = async function () {
            const btn = document.getElementById('saveSubBtn');
            const name = document.getElementById('new-name').value;
            const phone = document.getElementById('new-phone').value;

            if (!name) return alert('يجب كتابة الاسم على الأقل');

            btn.disabled = true;
            btn.innerHTML = 'جاري الحفظ...';

            try {
                await DataManager.addSubscriber({
                    name: name,
                    phone: phone,
                    price: 0,
                    status: 'قيد الانتظار',
                    paymentType: 'نقد', // Default until activated
                    startDate: new Date().toISOString().split('T')[0]
                });

                closeAddModal();
                document.getElementById('new-name').value = '';
                document.getElementById('new-phone').value = '';
            } catch (e) {
                alert('خطأ');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> حفظ البيانات';
            }
        };

        window.editSub = function (id) {
            // Simplified edit - ideally should be a modal
            const s = DataManager.getSubscriber(id);
            const newName = prompt("تعديل الاسم:", s.name);
            if (newName) {
                // Could ask for price too or open a full modal. Keeping it simple for now to focus on layout.
                DataManager.updateSubscriber(id, { name: newName });
            }
        };

        window.loading = false;
        window.updatePageData = window.renderPage;
        setInterval(() => { if (typeof DataManager !== 'undefined') renderPage(); }, 1000);
    </script>
</body>

</html>