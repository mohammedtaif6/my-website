<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المشتركين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body{font-family:'Inter',sans-serif;background:#f9fafb}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:50;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:white;border-radius:1rem;padding:2rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
    </style>
</head>
<body>
    <nav class="bg-blue-800 shadow sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="index.html" class="text-white font-bold text-xl flex items-center gap-2"><i class="fas fa-chart-line"></i> OKComputer</a>
            <div class="hidden md:flex gap-1">
                <a href="index.html" class="text-gray-200 hover:text-white px-3 py-2 rounded">الرئيسية</a>
                <a href="subscribers.html" class="text-white font-bold bg-white/20 px-3 py-2 rounded">المشتركين</a>
                <a href="debts.html" class="text-gray-200 hover:text-white px-3 py-2 rounded">الديون</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="flex flex-wrap gap-3 mb-6">
            <button onclick="openModal('addModal')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center gap-2"><i class="fas fa-plus"></i> إضافة مشترك</button>
            <button onclick="openActivateModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center gap-2"><i class="fas fa-check"></i> تفعيل اشتراك</button>
            <button onclick="exportData()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 flex items-center gap-2"><i class="fas fa-download"></i> تصدير</button>
        </div>

        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex gap-4">
                <input type="text" id="search" placeholder="بحث سريع..." class="flex-1 p-3 border rounded-lg bg-gray-50" onkeyup="window.loadSubscribers()">
                <select id="filter-status" class="p-3 border rounded-lg bg-gray-50" onchange="window.loadSubscribers()">
                    <option value="">الكل</option>
                    <option value="نشط">نشط</option>
                    <option value="قيد الانتظار">قيد الانتظار</option>
                    <option value="غير نشط">غير نشط</option>
                </select>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="w-full text-right">
                <thead class="bg-gray-100 text-gray-600">
                    <tr><th class="p-4">#</th><th class="p-4">الاسم</th><th class="p-4">الهاتف</th><th class="p-4">التاريخ</th><th class="p-4">الانتهاء</th><th class="p-4">الحالة</th><th class="p-4">السعر</th><th class="p-4">تعديل</th></tr>
                </thead>
                <tbody id="subscribers-body" class="divide-y divide-gray-100"></tbody>
            </table>
            <div class="p-4 bg-gray-50 flex justify-between items-center text-sm text-gray-600">
                <span id="page-info">0 سجل</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="px-3 py-1 border rounded bg-white hover:bg-gray-50">سابق</button>
                    <button onclick="changePage(1)" class="px-3 py-1 border rounded bg-white hover:bg-gray-50">تالي</button>
                </div>
            </div>
        </div>
    </main>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">إضافة مشترك</h2>
            <form onsubmit="saveNewSubscriber(event)">
                <input id="add-name" required placeholder="الاسم الكامل" class="w-full p-3 border rounded mb-3">
                <input id="add-phone" placeholder="رقم الهاتف" class="w-full p-3 border rounded mb-4">
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('addModal')" class="flex-1 py-2 bg-gray-200 rounded">إلغاء</button>
                    <button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">تعديل مشترك</h2>
            <form onsubmit="saveEditSubscriber(event)">
                <input type="hidden" id="edit-id">
                <input id="edit-name" required class="w-full p-3 border rounded mb-3">
                <input id="edit-phone" class="w-full p-3 border rounded mb-4">
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('editModal')" class="flex-1 py-2 bg-gray-200 rounded">إلغاء</button>
                    <button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded">تعديل</button>
                </div>
            </form>
        </div>
    </div>

    <div id="activateModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">تفعيل اشتراك</h2>
            <form onsubmit="activateSubscription(event)">
                <div class="relative mb-3">
                    <input id="act-name" required placeholder="ابحث عن مشترك..." class="w-full p-3 border rounded" oninput="searchSubscriber()">
                    <div id="suggestions" class="absolute w-full bg-white border shadow-lg mt-1 rounded hidden max-h-40 overflow-y-auto z-50"></div>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button type="button" class="p-2 border rounded hover:border-blue-600" onclick="setPrice(35000)">35,000</button>
                    <button type="button" class="p-2 border rounded hover:border-blue-600" onclick="setPrice(30000)">30,000</button>
                    <input id="custom-price" type="number" placeholder="سعر آخر" class="p-2 border rounded">
                </div>
                <select id="payment-type" class="w-full p-3 border rounded mb-3">
                    <option value="نقد">دفع نقدي</option>
                    <option value="أجل">دفع أجل (دين)</option>
                </select>
                <div class="flex gap-2">
                    <input type="date" id="sub-date" class="flex-1 p-2 border rounded bg-gray-50">
                    <input type="date" id="exp-date" class="flex-1 p-2 border rounded bg-gray-50">
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('activateModal')" class="flex-1 py-2 bg-gray-200 rounded">إلغاء</button>
                    <button type="submit" class="flex-1 py-2 bg-green-600 text-white rounded">تفعيل</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="data-manager.js"></script>
    <script>
        let currentPage = 1, pageSize = 10, filteredData = [];

        window.loadSubscribers = function() {
            const search = document.getElementById('search').value.toLowerCase();
            const status = document.getElementById('filter-status').value;
            const all = DataManager.getSubscribers();

            filteredData = all.filter(s => {
                const matchSearch = (s.name||'').toLowerCase().includes(search) || (s.phone||'').includes(search);
                const matchStatus = !status || s.status === status;
                return matchSearch && matchStatus;
            });

            renderTable();
        };

        function renderTable() {
            const start = (currentPage - 1) * pageSize;
            const page = filteredData.slice(start, start + pageSize);
            
            document.getElementById('subscribers-body').innerHTML = page.map((s, i) => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4">${start + i + 1}</td>
                    <td class="p-4 font-bold text-gray-700">${s.name}</td>
                    <td class="p-4 text-gray-500">${s.phone || '-'}</td>
                    <td class="p-4 text-sm">${s.subscribeDate || '-'}</td>
                    <td class="p-4 text-sm">${s.expiryDate || '-'}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${s.status==='نشط'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}">${s.status}</span></td>
                    <td class="p-4 font-bold text-blue-600">${(s.price||0).toLocaleString()}</td>
                    <td class="p-4 flex gap-2">
                        <button onclick="openEdit(${s.id})" class="text-blue-600"><i class="fas fa-edit"></i></button>
                        <button onclick="delSub(${s.id})" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('page-info').textContent = `عرض ${page.length} من ${filteredData.length}`;
        }

        // Modal Logic
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        // Add Subscriber
        window.saveNewSubscriber = (e) => {
            e.preventDefault();
            DataManager.addSubscriber({
                name: document.getElementById('add-name').value,
                phone: document.getElementById('add-phone').value
            });
            closeModal('addModal');
            document.getElementById('add-name').value = '';
            document.getElementById('add-phone').value = '';
        };

        // Edit Logic
        window.openEdit = (id) => {
            const s = DataManager.getSubscriber(id);
            if(s) {
                document.getElementById('edit-id').value = s.id;
                document.getElementById('edit-name').value = s.name;
                document.getElementById('edit-phone').value = s.phone;
                openModal('editModal');
            }
        };

        window.saveEditSubscriber = (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-id').value);
            DataManager.updateSubscriber(id, {
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value
            });
            closeModal('editModal');
        };

        window.delSub = (id) => { if(confirm('حذف؟')) DataManager.deleteSubscriber(id); };

        // Activate Logic
        window.openActivateModal = () => {
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(); nextMonth.setDate(nextMonth.getDate()+30);
            document.getElementById('sub-date').value = today;
            document.getElementById('exp-date').value = nextMonth.toISOString().split('T')[0];
            openModal('activateModal');
        };

        window.setPrice = (p) => { document.getElementById('custom-price').value = p; };

        window.searchSubscriber = () => {
            const val = document.getElementById('act-name').value;
            const list = document.getElementById('suggestions');
            if(!val) { list.classList.add('hidden'); return; }
            
            const res = DataManager.searchSubscribers(val);
            if(res.length) {
                list.innerHTML = res.map(s => `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectSub(${s.id})">${s.name}</div>`).join('');
                list.classList.remove('hidden');
            } else {
                list.classList.add('hidden');
            }
        };

        window.selectSub = (id) => {
            const s = DataManager.getSubscriber(id);
            document.getElementById('act-name').value = s.name;
            document.getElementById('suggestions').classList.add('hidden');
        };

        window.activateSubscription = (e) => {
            e.preventDefault();
            const name = document.getElementById('act-name').value;
            const price = document.getElementById('custom-price').value;
            if(!price) return;

            const existing = DataManager.searchSubscribers(name).find(s => s.name === name);
            const data = {
                name, price, 
                paymentType: document.getElementById('payment-type').value,
                subscribeDate: document.getElementById('sub-date').value,
                expiryDate: document.getElementById('exp-date').value,
                status: 'نشط'
            };

            if(existing) DataManager.updateSubscriber(existing.id, data);
            else DataManager.addSubscriber(data);
            
            closeModal('activateModal');
        };

        window.changePage = (d) => {
            if(d === 1 && (currentPage * pageSize) < filteredData.length) currentPage++;
            if(d === -1 && currentPage > 1) currentPage--;
            renderTable();
        };

        window.exportData = () => DataManager.exportToCSV(filteredData, 'subscribers');
    </script>
</body>
</html>
