<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ­Øµ Firebase</title>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .status-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .success {
            border-left: 4px solid #4caf50;
        }

        .error {
            border-left: 4px solid #f44336;
        }

        .warning {
            border-left: 4px solid #ff9800;
        }

        pre {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>ğŸ” ÙØ­Øµ Ø§ØªØµØ§Ù„ Firebase</h1>

    <div id="status"></div>

    <button onclick="testFirebase()" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">
        Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-raYlvzPz8T7Mnx8bTWA4O8CyHvp7K_0",
            authDomain: "okcomputer-system.firebaseapp.com",
            projectId: "okcomputer-system",
            storageBucket: "okcomputer-system.firebasestorage.app",
            messagingSenderId: "17748146044",
            appId: "1:17748146044:web:e4a2063ac34c6ee27016f9"
        };

        let app, db;
        let statusDiv = document.getElementById('status');

        function addStatus(message, type) {
            const box = document.createElement('div');
            box.className = `status-box ${type}`;
            box.innerHTML = message;
            statusDiv.appendChild(box);
        }

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            addStatus('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
            addStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:<br><pre>${error.message}</pre>`, 'error');
        }

        window.testFirebase = async function () {
            statusDiv.innerHTML = '';
            addStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...', 'warning');

            try {
                // 1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                addStatus('ğŸ“– Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† subscribers...', 'warning');
                const querySnapshot = await getDocs(collection(db, 'subscribers'));
                addStatus(`âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${querySnapshot.size} Ø³Ø¬Ù„ Ù…Ù† subscribers`, 'success');

                // 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
                addStatus('ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ù‰ test_connection...', 'warning');
                const testDoc = await addDoc(collection(db, 'test_connection'), {
                    timestamp: new Date().toISOString(),
                    test: true
                });
                addStatus(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ø®ØªØ¨Ø§Ø±: ${testDoc.id}`, 'success');

                // 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù
                addStatus('ğŸ—‘ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø°Ù...', 'warning');
                await deleteDoc(doc(db, 'test_connection', testDoc.id));
                addStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ', 'success');

                // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                const collections = ['transactions', 'employees', 'maintenances'];
                for (const col of collections) {
                    try {
                        const snap = await getDocs(collection(db, col));
                        addStatus(`âœ… ${col}: ${snap.size} Ø³Ø¬Ù„`, 'success');
                    } catch (err) {
                        addStatus(`âŒ ${col}: ${err.message}`, 'error');
                    }
                }

                addStatus('<h3>âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª!</h3>', 'success');

            } catch (error) {
                addStatus(`âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:<br><pre>${error.code}\n${error.message}</pre>`, 'error');

                if (error.code === 'permission-denied') {
                    addStatus(`
                        <h3>âš ï¸ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª!</h3>
                        <p>ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore ØªÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©:</p>
                        <pre>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;  // Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·
    }
  }
}
                        </pre>
                    `, 'error');
                }
            }
        };

        // Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('load', () => {
            setTimeout(testFirebase, 500);
        });
    </script>
</body>

</html>
