<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل صيانة - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=19.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="auth-system.js"></script>
    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <script>
        AuthSystem.checkSession();
    </script>

    <nav class="navbar">
        <div class="logo"><i class="fas fa-wrench"></i> تسجيل صيانة</div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-card"
            style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div
                    style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                    <i class="fas fa-wrench" style="font-size: 1.5rem;"></i>
                </div>
                <div style="flex: 1;">
                    <h1 style="font-size: 1.3rem; margin: 0 0 3px 0;">تسجيل صيانة جديدة</h1>
                    <p id="employee-name" style="margin: 0; font-size: 0.9rem; opacity: 0.95;">جاري التحميل...</p>
                </div>
            </div>
        </div>

        <div class="modal-box" style="position: static; max-width: 600px; margin: 0 auto; animation: none;">
            <div class="modal-body">
                <form id="maintenanceForm" onsubmit="window.submitMaintenance(event)">
                    <!-- المشترك -->
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> اسم المشترك</label>
                        <input type="text" id="sub-name" placeholder="ابحث عن المشترك..."
                            oninput="window.searchSubscriber(this.value)" autocomplete="off" required>
                        <div id="search-results"
                            style="display:none; border:1px solid #ddd; max-height:150px; overflow-y:auto; margin-top:5px; border-radius:8px;">
                        </div>
                        <input type="hidden" id="sub-id">
                        <input type="hidden" id="sub-phone">
                    </div>

                    <!-- نوع الصيانة -->
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> نوع الصيانة</label>
                        <select id="maint-type" required>

                            <option value="">-- اختر --</option>
                            <option value="استبدال كيبل">استبدال كيبل</option>
                            <option value="استبدال راوتر">استبدال راوتر</option>
                            <option value="إعدادات وتهيئة">إعدادات وتهيئة</option>
                            <option value="إصلاح خط">إصلاح خط</option>
                            <option value="فحص وتشخيص">فحص وتشخيص</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>

                    <!-- القطع المستبدلة -->
                    <div class="form-group">
                        <label><i class="fas fa-box"></i> القطع المستبدلة (اختياري)</label>
                        <input type="text" id="maint-parts" placeholder="مثال: كيبل 20 متر، راوتر TP-Link">
                    </div>

                    <!-- التكلفة -->
                    <div class="form-grid">
                        <div class="form-group" style="margin:0">
                            <label><i class="fas fa-money-bill"></i> التكلفة</label>
                            <input type="number" id="maint-cost" placeholder="0" value="0" min="0">
                        </div>
                        <div class="form-group" style="margin:0">
                            <label><i class="fas fa-credit-card"></i> الدفع</label>
                            <select id="maint-paid">
                                <option value="مجاني">مجاني</option>
                                <option value="مدفوع نقداً">مدفوع نقداً</option>
                                <option value="مدفوع على الاشتراك">مدفوع على الاشتراك</option>
                            </select>
                        </div>
                    </div>

                    <!-- ملاحظات -->
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> ملاحظات (اختياري)</label>
                        <textarea id="maint-notes" rows="3" placeholder="أي ملاحظات إضافية..."
                            style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:var(--radius-md); font-family:inherit;"></textarea>
                    </div>

                    <!-- إرسال واتساب -->
                    <div class="form-group"
                        style="background:#e8f5e9; padding:15px; border-radius:10px; border:1px solid #81c784;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin:0;">
                            <input type="checkbox" id="send-whatsapp" checked style="width:20px; height:20px;">
                            <span style="font-weight:bold; color:#2e7d32;"><i class="fab fa-whatsapp"></i> إرسال تفاصيل
                                الصيانة للمشترك</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-success btn-full" style="margin-top:20px;">
                        <i class="fas fa-check-circle"></i> تسجيل الصيانة
                    </button>
                </form>
            </div>
        </div>

        <!-- سجل الصيانات -->
        <div class="table-container" style="margin-top:30px;">
            <div class="table-header">
                <h3><i class="fas fa-history"></i> آخر الصيانات</h3>
            </div>
            <div id="recent-maintenances" style="padding:20px;">
                <p style="text-align:center; color:#888;">جاري التحميل...</p>
            </div>
        </div>
    </div>

    <script>
        // عرض اسم الموظف
        if (AuthSystem.currentUser) {
            document.getElementById('employee-name').innerText = `الموظف: ${AuthSystem.currentUser.name}`;
        }

        // البحث عن مشترك
        window.searchSubscriber = (query) => {
            const results = document.getElementById('search-results');
            if (!query || query.length < 2) {
                results.style.display = 'none';
                return;
            }

            const subs = DataManager.searchSubscribers(query);
            if (subs.length > 0) {
                results.innerHTML = subs.slice(0, 5).map(s => `
                    <div onclick="window.selectSubscriber(${s.id}, '${s.name}', '${s.phone || ''}')" 
                         style="padding:12px; cursor:pointer; border-bottom:1px solid #eee; transition:background 0.2s;"
                         onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                        <strong>${s.name}</strong>
                        ${s.phone ? `<br><small style="color:#666;"><i class="fas fa-phone"></i> ${s.phone}</small>` : ''}
                    </div>
                `).join('');
                results.style.display = 'block';
            } else {
                results.innerHTML = '<div style="padding:12px; color:#888;">لا توجد نتائج</div>';
                results.style.display = 'block';
            }
        };

        window.selectSubscriber = (id, name, phone) => {
            document.getElementById('sub-name').value = name;
            document.getElementById('sub-id').value = id;
            document.getElementById('sub-phone').value = phone;
            document.getElementById('search-results').style.display = 'none';
        };

        // إرسال الصيانة
        window.submitMaintenance = async (e) => {
            e.preventDefault();

            const data = {
                subscriberId: document.getElementById('sub-id').value,
                subscriberName: document.getElementById('sub-name').value,
                subscriberPhone: document.getElementById('sub-phone').value,
                type: document.getElementById('maint-type').value,
                parts: document.getElementById('maint-parts').value,
                cost: parseInt(document.getElementById('maint-cost').value) || 0,
                paymentType: document.getElementById('maint-paid').value,
                notes: document.getElementById('maint-notes').value,
                sendWhatsApp: document.getElementById('send-whatsapp').checked,
                employeeId: AuthSystem.currentUser.id,
                employeeName: AuthSystem.currentUser.name
            };

            if (!data.subscriberId) {
                return alert('الرجاء اختيار المشترك من القائمة');
            }

            await DataManager.addMaintenance(data);

            // مسح النموذج
            document.getElementById('maintenanceForm').reset();
            document.getElementById('sub-id').value = '';
            document.getElementById('sub-phone').value = '';

            loadRecentMaintenances();
        };

        // تحميل آخر الصيانات
        async function loadRecentMaintenances() {
            const maintenances = DataManager.getMaintenances();
            const container = document.getElementById('recent-maintenances');

            if (!maintenances || maintenances.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888;">لا توجد صيانات مسجلة</p>';
                return;
            }

            // عرض آخر 5 صيانات للموظف الحالي
            const myMaintenances = maintenances
                .filter(m => m.employeeId == AuthSystem.currentUser.id)
                .slice(0, 5);

            if (myMaintenances.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888;">لم تسجل أي صيانات بعد</p>';
                return;
            }

            container.innerHTML = myMaintenances.map(m => `
                <div style="background:#f9f9f9; padding:15px; margin-bottom:10px; border-radius:10px; border-right:4px solid var(--primary);">
                    <div style="font-weight:bold; margin-bottom:8px;">
                        <i class="fas fa-user"></i> ${m.subscriberName}
                    </div>
                    <div style="color:#666; font-size:0.9rem;">
                        <i class="fas fa-tools"></i> ${m.type} 
                        ${m.cost > 0 ? `• <i class="fas fa-money-bill"></i> ${m.cost.toLocaleString()} د.ع` : '• مجاني'}
                    </div>
                    <div style="color:#888; font-size:0.8rem; margin-top:5px;">
                        <i class="fas fa-clock"></i> ${new Date(m.createdAt).toLocaleString('ar-IQ')}
                    </div>
                </div>
            `).join('');
        }

        // تحميل الصيانات عند بدء الصفحة
        setInterval(() => {
            if (typeof DataManager !== 'undefined') {
                loadRecentMaintenances();
            }
        }, 2000);
    </script>
</body>

</html>