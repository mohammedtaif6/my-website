<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المنتهية - OK Computer</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Kufi+Arabic:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=29.0">
    <link rel="stylesheet" href="style-fab.css?v=3.0">
    <link rel="stylesheet" href="style-modal.css?v=3.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="auth-system.js?v=5.0"></script>
    <script src="whatsapp-helper.js"></script>
    <script>
        // Anti-Flicker: Apply visibility as fast as possible
        (function () {
            const settings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
            const style = document.createElement('style');
            let css = '';
            ['nav-subscribers', 'nav-active', 'nav-debts', 'nav-payments', 'nav-reports', 'nav-employees', 'nav-telegram'].forEach(id => {
                if (settings[id] === false) css += `#${id} { display: none !important; } `;
            });
            style.innerHTML = css;
            document.head.appendChild(style);
        })();
        AuthSystem.checkSession();
    </script>
    <script type="module">
        import { DataManager } from './data-manager.js?v=35.0';
        window.DataManager = DataManager;
        DataManager.init();
    </script>

    <style>
        :root {
            --danger-gradient: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        body {
            font-family: 'Noto Kufi Arabic', 'Outfit', sans-serif;
            background: #f0f2f5;
        }

        .header-section {
            background: var(--danger-gradient);
            padding: 40px 20px 60px;
            border-radius: 0 0 40px 40px;
            color: white;
            text-align: center;
            margin-bottom: -40px;
            box-shadow: 0 10px 20px rgba(255, 75, 43, 0.2);
        }

        .header-section h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .search-container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .search-input-wrapper {
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 5px 20px;
            box-shadow: var(--glass-shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .search-input-wrapper i {
            color: #888;
            margin-left: 10px;
        }

        .search-input-wrapper input {
            border: none;
            padding: 15px;
            width: 100%;
            font-size: 1rem;
            outline: none;
            background: transparent;
        }

        .expired-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 60px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Expired Card Design */
        .expired-card {
            background: var(--glass);
            backdrop-filter: blur(4px);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: var(--glass-shadow);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .expired-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .expired-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--danger-gradient);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .user-info h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1a1a1a;
            font-weight: 700;
        }

        .user-info p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .expiry-badge {
            background: #fff5f5;
            color: #e53e3e;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            border: 1px solid #feb2b2;
        }

        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.7rem;
            color: #94a3b8;
            margin-bottom: 2px;
        }

        .stat-value {
            font-weight: bold;
            color: #334155;
            font-size: 0.9rem;
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 5px;
        }

        .btn-action {
            padding: 12px;
            border-radius: 14px;
            border: none;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-renew {
            background: #10b981;
            color: white;
        }

        .btn-renew:hover {
            background: #059669;
            transform: scale(1.02);
        }

        .btn-wa {
            background: #25d366;
            color: white;
        }

        .btn-wa:hover {
            background: #128c7e;
            transform: scale(1.02);
        }

        .empty-state {
            grid-column: 1 / -1;
            padding: 80px 20px;
            text-align: center;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.2;
        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .expired-card {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }
    </style>
</head>

<body>
    <script>AuthSystem.checkSession();</script>

    <!-- Mobile Header & Toggle -->
    <button class="menu-btn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar / Drawer Navigation -->
    <nav class="navbar" id="main-nav">
        <div class="header-card"
            style="margin: 0; background: none; box-shadow: none; border: none; padding: 0 0 20px 0;">
            <div class="logo" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 0;">
                <i class="fas fa-chart-line"></i> OK Computer
            </div>
        </div>

        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li id="nav-subscribers"><a href="subscribers.html"><i class="fas fa-users"></i> المشتركين</a></li>
            <li id="nav-active"><a href="active_subscribers.html"><i class="fas fa-signal"></i> الفعالين</a></li>
            <li id="nav-expired"><a href="expired.html" class="active"><i class="fas fa-clock"></i> المنتهية</a></li>
            <li id="nav-debts"><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li id="nav-payments"><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> الصندوق</a></li>
            <li id="nav-reports"><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
            <li id="nav-employees"><a href="employees.html"><i class="fas fa-users-cog"></i> الموظفين</a></li>

            <li id="nav-telegram"><a href="telegram-settings.html"><i class="fab fa-telegram"></i> Telegram</a></li>
            <li id="nav-settings"><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
        </ul>

        <div class="nav-overlay" onclick="toggleMenu()"></div>
    </nav>

    <div class="header-section">
        <h1>الاشتراكات المنتهية</h1>
        <p>تحتاج تجديد أو تنبيه <span id="expired-count-badge">0</span></p>
    </div>

    <div class="container">
        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="بحث باسم المشترك أو رقم الهاتف..."
                    onkeyup="renderPage()">
            </div>
        </div>

        <div id="expiredGrid" class="expired-grid">
            <!-- سيتم ملء المشتركين هنا -->
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>جاري تحميل البيانات...</p>
            </div>
        </div>
    </div>

    <!-- Quick Activate Modal -->
    <div id="quickActivateModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3><i class="fas fa-sync-alt" style="margin-left:8px; color:#0ea5e9;"></i> تجديد الاشتراك</h3>
                <button class="close-btn" onclick="closeQuickActivate()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qa-id">
                <input type="hidden" id="qa-fid">

                <!-- رصيد النظام -->
                <div id="qa-balance-info"
                    style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #7dd3fc; border-radius: 12px; padding: 10px 15px; margin-bottom: 15px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.8rem; color:#0369a1;"><i class="fas fa-wallet"></i> رصيد النظام</span>
                    <strong id="qa-balance-value" style="color:#0369a1; font-size:1rem;">0</strong>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-box" style="margin-left:5px; color:#8b5cf6;"></i> الباقة</label>
                    <select id="qa-package" onchange="window.onPackageChange(this.value)">
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-money-bill" style="margin-left:5px; color:#059669;"></i> المبلغ</label>
                    <input type="number" id="qa-price" value="35000">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-credit-card" style="margin-left:5px; color:#f59e0b;"></i> طريقة
                        الدفع</label>
                    <select id="qa-type">
                        <option value="نقد">نقد (واصل)</option>
                        <option value="أجل">أجل (دين)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar" style="margin-left:5px; color:#ef4444;"></i> تاريخ الانتهاء
                        القادم</label>
                    <input type="date" id="qa-end">
                </div>
                <button onclick="saveQuickActivate()" class="btn btn-success btn-full">
                    <i class="fas fa-check-circle" style="margin-left:5px;"></i> تأكيد التجديد
                </button>
            </div>
        </div>
    </div>

    <script>
        let lastRenderedTime = 0;

        window.renderPage = function () {
            if (typeof DataManager === 'undefined') return;
            const subs = DataManager.getSubscribers();
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const todayStr = new Date().toISOString().split('T')[0];
            const now = new Date();

            const expired = subs.filter(s => {
                if (!s.expiryDate) return false;

                // البحث
                if (searchTerm && !s.name.toLowerCase().includes(searchTerm) && !s.phone.includes(searchTerm)) {
                    return false;
                }

                let itemDate = s.expiryDate;
                if (itemDate.indexOf('/') > 0) {
                    const parts = itemDate.split('/');
                    if (parts.length === 3) itemDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }

                if (itemDate < todayStr) return true;
                if (itemDate === todayStr) return now.getHours() >= 16;
                return false;
            });

            document.getElementById('expired-count-badge').innerText = expired.length;

            // ✅ بصمة البيانات - لمنع الوميض
            const dataHash = expired.map(s => s.id + '|' + (s.expiryDate || '') + '|' + (s.price || 0)).join('||') + '||q:' + searchTerm;
            if (window.lastExpiredHash === dataHash) return;
            window.lastExpiredHash = dataHash;

            const grid = document.getElementById('expiredGrid');

            if (expired.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle" style="color:#10b981; opacity:1"></i>
                        <h2 style="color:#444">الوضع ممتاز!</h2>
                        <p>لا توجد اشتراكات منتهية حالياً.</p>
                    </div>
                `;
                return;
            }

            const userIsAdmin = AuthSystem && AuthSystem.currentUser && AuthSystem.currentUser.type === 'admin';

            grid.innerHTML = expired.map(s => {
                const dateObj = new Date(s.expiryDate);
                const readableDate = dateObj.toLocaleDateString('ar-u-nu-latn', { day: 'numeric', month: 'long' });
                const debt = parseInt(s.price || 0);

                return `
                    <div class="expired-card">
                        <div class="card-header">
                            <div class="user-info">
                                <h3>${s.name}</h3>
                                <p><i class="fas fa-phone"></i> ${s.phone || 'بدون هاتف'}</p>
                            </div>
                            <div class="expiry-badge">
                                منتهي
                            </div>
                        </div>

                        <div class="card-stats" onclick="window.location.href='subscribers.html?id=${s.id}'" style="cursor:pointer">
                            <div class="stat-item">
                                <span class="stat-label">تاريخ الانتهاء</span>
                                <span class="stat-value">${readableDate}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">دين سابق</span>
                                <span class="stat-value ${debt > 0 ? 'text-danger' : ''}">${debt.toLocaleString('en-US')} د.ع</span>
                            </div>
                        </div>

                        <div class="card-actions">
                            <button onclick="window.openRenew('${s.firebaseId}', '${s.id}')" class="btn-action btn-renew" style="grid-column: span 2">
                                <i class="fas fa-sync-alt"></i> تجديد الاشتراك
                            </button>
                            <button onclick="window.notifyWA('${s.phone}', '${s.name}')" class="btn-action btn-wa">
                                <i class="fab fa-whatsapp"></i> تنبيه واتساب
                            </button>
                            ${userIsAdmin ? `
                                <button onclick="window.deleteSub('${s.id}')" class="btn-action" style="background:#fee2e2; color:#b91c1c;">
                                    <i class="fas fa-trash"></i> حذف المشترك
                                </button>
                            ` : `
                                <button disabled class="btn-action" style="background:#f1f5f9; color:#94a3b8; cursor:not-allowed;">
                                    <i class="fas fa-lock"></i> محدود
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.lastExpiredHash = '';

        window.deleteSub = (id) => DataManager.deleteSubscriber(id);

        window.notifyWA = function (phone, name) {
            WhatsAppHelper.sendExpiredNotification(name, phone);
        };

        window.onPackageChange = function (pkgId) {
            const pkgs = DataManager.getSystemSettings().packages || [];
            const selected = pkgs.find(p => p.id === pkgId);
            if (selected) {
                document.getElementById('qa-price').value = selected.salePrice;
            }
        };

        window.openRenew = function (fid, id) {
            const subs = DataManager.getSubscribers();
            const sub = subs.find(s => s.id == id);

            const today = new Date();
            let targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + 30);

            // ✅ عرض رصيد النظام
            const balance = DataManager.getSystemBalance();
            const balEl = document.getElementById('qa-balance-value');
            const balInfo = document.getElementById('qa-balance-info');
            if (balEl) {
                balEl.textContent = balance.toLocaleString('en-US') + ' د.ع';
                if (balance <= 0) {
                    balInfo.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                    balInfo.style.borderColor = '#fca5a5';
                    balEl.style.color = '#dc2626';
                } else {
                    balInfo.style.background = 'linear-gradient(135deg, #f0f9ff, #e0f2fe)';
                    balInfo.style.borderColor = '#7dd3fc';
                    balEl.style.color = '#0369a1';
                }
            }

            document.getElementById('qa-id').value = id;
            document.getElementById('qa-fid').value = fid;
            document.getElementById('qa-end').value = targetDate.toISOString().split('T')[0];

            // تحديث قائمة الباقات
            const pkgSelect = document.getElementById('qa-package');
            const packages = DataManager.getSystemSettings().packages || [];
            if (pkgSelect) {
                pkgSelect.innerHTML = packages.map(p => `<option value="${p.id}">${p.name} (${p.salePrice.toLocaleString('en-US')} د.ع)</option>`).join('');

                // اختيار باقة المشترك المثبتة تلقائياً
                if (sub && sub.packageId) {
                    pkgSelect.value = sub.packageId;
                    window.onPackageChange(sub.packageId);
                } else if (packages.length > 0) {
                    pkgSelect.value = packages[0].id;
                    window.onPackageChange(packages[0].id);
                }
            }

            document.getElementById('quickActivateModal').classList.add('active');
        };

        window.closeQuickActivate = () => document.getElementById('quickActivateModal').classList.remove('active');

        window.saveQuickActivate = async function () {
            const fid = document.getElementById('qa-fid').value;
            const id = document.getElementById('qa-id').value;
            const price = document.getElementById('qa-price').value;
            const type = document.getElementById('qa-type').value;
            const end = document.getElementById('qa-end').value;
            const packageId = document.getElementById('qa-package').value;

            if (!price || !end) {
                DataManager.showToast('⚠️ يرجى إكمال البيانات', 'error');
                return;
            }

            if (!packageId) {
                DataManager.showToast('⚠️ يرجى اختيار الباقة', 'error');
                return;
            }

            try {
                await DataManager.renewSubscription(fid, id, {
                    price: parseInt(price),
                    type: type,
                    dateEnd: end,
                    packageId: packageId
                });
                closeQuickActivate();
            } catch (e) {
                DataManager.showToast('❌ فشل تجديد الاشتراك: ' + e.message, 'error');
            }
        };

        // المزامنة الدورية
        setInterval(() => {
            if (typeof DataManager !== 'undefined' && DataManager.getSubscribers().length > 0) {
                renderPage();
            }
        }, 3000);

        // Menu Toggle Logic
        window.toggleMenu = function () {
            const nav = document.getElementById('main-nav');
            const overlay = document.querySelector('.nav-overlay');
            nav.classList.toggle('active');
            if (nav.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
    </script>
</body>

</html>