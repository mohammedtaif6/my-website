<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المبالغ - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=11.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-hand-holding-usd"></i> الصندوق
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> المشتركين</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li><a href="payments.html" class="active"><i class="fas fa-hand-holding-usd"></i> المبالغ</a></li>
            <li><a href="expenses.html"><i class="fas fa-file-invoice-dollar"></i> الصرفيات</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
        </ul>
    </nav>

    <div class="container">

        <div class="header-card">
            <div>
                <h1>حركة الصندوق</h1>
                <p>سجل المقبوضات والنفقات اليومية</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="addPaymentManually()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> إضافة مقبوض
                </button>
                <button onclick="window.DataManager.archiveDay()" class="btn btn-warning" style="color:black;">
                    <i class="fas fa-archive"></i> ترحيل يومي
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card"
                style="background: linear-gradient(135deg, #10b981, #059669); color: white; justify-content: space-between;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px;">
                        <i class="fas fa-wallet" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h3 style="color: rgba(255,255,255,0.9); margin-bottom: 5px;">الرصيد الصافي</h3>
                        <p id="actualBalance" style="color: white; font-size: 2rem;">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>سجل المعاملات</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم / البيان</th>
                            <th>المبلغ</th>
                            <th>النوع</th>
                            <th>التاريخ</th>
                            <th>تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Manual Payment -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>إضافة مقبوض يدوي</h3>
                <button class="close-btn" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>المشترك</label>
                    <select id="subscriberSelect">
                        <option value="">-- اختر مشترك --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المبلغ</label>
                    <input type="number" id="paymentAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <input type="text" id="paymentDescription" placeholder="تسديد اشتراك، دفعة...">
                </div>
                <button onclick="saveManualPayment()" class="btn btn-primary btn-full" id="savePayBtn">
                    <i class="fas fa-save"></i> حفظ المقبوض
                </button>
            </div>
        </div>
    </div>

    <script>
        window.renderPage = function () {
            if (typeof DataManager === 'undefined') return;
            const trans = DataManager.getAllTransactions();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let totalReceived = 0;
            let totalExpenses = 0;

            if (trans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--secondary);">الصندوق فارغ</td></tr>';
            } else {
                // Sort by ID descending (newest first)
                trans.sort((a, b) => (b.id || 0) - (a.id || 0)).forEach(t => {
                    const sub = DataManager.getSubscriber(t.subscriberId);
                    const amount = t.amount || 0;

                    if (amount > 0) totalReceived += amount;
                    else totalExpenses += Math.abs(amount);

                    const date = new Date(t.createdAt || Date.now()).toLocaleDateString('ar-IQ');
                    const isExpense = amount < 0;

                    tbody.innerHTML += `
                        <tr>
                            <td data-label="البيان" style="font-weight:600;">
                                ${sub ? sub.name : (t.description || (isExpense ? 'صرفية' : 'غير معروف'))}
                            </td>
                            <td data-label="المبلغ">
                                <span class="badge ${isExpense ? 'badge-danger' : 'badge-success'}">
                                    ${Math.abs(amount).toLocaleString()}
                                </span>
                            </td>
                            <td data-label="النوع">${t.type || '-'}</td>
                            <td data-label="التاريخ">${date}</td>
                            <td data-label="تحكم">
                                <button onclick="deletePaymentConfirm('${t.id}')" class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            const actualBalance = totalReceived - totalExpenses;
            document.getElementById('actualBalance').innerText = actualBalance.toLocaleString() + ' د.ع';
        };

        window.openPaymentModal = function () {
            document.getElementById('paymentModal').classList.add('active');
            const select = document.getElementById('subscriberSelect');
            const subscribers = DataManager.getSubscribers();
            select.innerHTML = '<option value="">-- اختر مشترك --</option>';
            subscribers.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub.id;
                opt.text = sub.name;
                select.appendChild(opt);
            });
        };

        window.closePaymentModal = function () {
            document.getElementById('paymentModal').classList.remove('active');
        };

        window.addPaymentManually = window.openPaymentModal;

        window.saveManualPayment = async function () {
            const btn = document.getElementById('savePayBtn');
            const subId = document.getElementById('subscriberSelect').value;
            const amount = document.getElementById('paymentAmount').value;
            const desc = document.getElementById('paymentDescription').value || 'مقبوض يدوي';

            if (!subId || !amount) return alert('الرجاء اختيار المشترك وتحديد المبلغ');

            btn.disabled = true;
            btn.innerHTML = 'جاري الحفظ...';

            try {
                await DataManager.recordTransaction(subId, parseInt(amount), desc, 'نقد');
                closePaymentModal();
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentDescription').value = '';
            } catch (e) {
                alert('خطأ');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> حفظ المقبوض';
            }
        };

        window.deletePaymentConfirm = async function (id) {
            if (confirm('حذف هذا السجل المالي نهائياً؟')) {
                await DataManager.deleteTransaction(id);
            }
        };

        window.updatePageData = window.renderPage;
        setInterval(() => { if (typeof DataManager !== 'undefined') renderPage(); }, 1000);
    </script>
</body>

</html>