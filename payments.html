<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المبالغ - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-hand-holding-usd"></i> المبالغ</div>
        <ul class="nav-links">
            <li><a href="index.html">الرئيسية</a></li>
            <li><a href="subscribers.html">المشتركين</a></li>
            <li><a href="debts.html">الديون</a></li>
            <li><a href="payments.html" class="active">المبالغ</a></li>
            <li><a href="expenses.html">الصرفيات</a></li>
            <li><a href="reports.html">التقارير</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header-card">
            <h1>الصندوق اليومي</h1>
            <p id="totalIncome" style="color:var(--success); font-weight:bold;">0 د.ع</p>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>المشترك</th>
                        <th>المبلغ</th>
                        <th>التاريخ</th>
                        <th>تراجع</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div style="margin-top:20px; text-align:center;">
            <button onclick="window.archive()" class="btn btn-primary" style="width:100%">ترحيل للأرشيف (تصفير)</button>
        </div>
    </div>

    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;

        window.renderPayments = function() {
            const trans = DataManager.getAllTransactions();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let total = 0;

            if (trans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">الصندوق فارغ</td></tr>';
            } else {
                trans.sort((a,b) => b.id - a.id).forEach(t => {
                    total += t.amount;
                    const sub = DataManager.getSubscribers().find(s => s.id == t.subscriberId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${sub ? sub.name : 'محذوف'}</td>
                            <td style="color:var(--success); font-weight:bold;">${t.amount.toLocaleString()}</td>
                            <td>${t.date}</td>
                            <td>
                                <button onclick="window.deleteTrans('${t.id}')" class="btn btn-danger btn-sm"><i class="fas fa-undo"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
            document.getElementById('totalIncome').innerText = `المجموع: ${total.toLocaleString()} د.ع`;
        };

        window.deleteTrans = async function(id) {
            await DataManager.deleteTransaction(id);
        };

        window.archive = async function() {
            const trans = DataManager.getAllTransactions();
            if(trans.length === 0) return alert('لا يوجد شيء للترحيل');
            if(confirm('هل أنت متأكد من ترحيل المبالغ للأرشيف وتصفير الصندوق؟')) {
                // ترحيل كل المعاملات
                for(let t of trans) {
                    await DataManager.addDoc(DataManager.collection(DataManager.db, "archived_transactions"), t);
                    await DataManager.deleteDoc(DataManager.doc(DataManager.db, "transactions", t.firebaseId));
                }
                alert('تم الترحيل');
            }
        };

        window.renderPage = window.renderPayments;
        setTimeout(window.renderPayments, 500);
    </script>
</body>
</html>
