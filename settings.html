<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=28.0">
    <link rel="stylesheet" href="style-fab.css?v=2.0">
    <link rel="stylesheet" href="style-modal.css?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Telegram 409 error: This is likely due to an invalid bot token or webhook URL. Please check your Telegram bot settings. -->

    <script src="auth-system.js?v=4.0"></script>
    <script>
        // Anti-Flicker: Apply visibility as fast as possible
        (function () {
            const settings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
            const style = document.createElement('style');
            let css = '';
            ['nav-subscribers', 'nav-active', 'nav-debts', 'nav-payments', 'nav-reports', 'nav-employees', 'nav-telegram'].forEach(id => {
                if (settings[id] === false) css += `#${id} { display: none !important; } `;
            });
            style.innerHTML = css;
            document.head.appendChild(style);
        })();
        AuthSystem.checkSession();
    </script>

    <style>
        .settings-header {
            background: white;
            padding: 40px 20px 30px;
            border-radius: 20px;
            color: #0f172a;
            text-align: center;
            margin: 15px 15px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
        }

        .settings-header h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #1e293b;
        }

        .settings-header p {
            color: #64748b;
            margin: 0;
            font-size: 0.95rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 0 15px;
            margin-bottom: 25px;
        }

        @media (min-width: 900px) {
            .settings-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .settings-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .section-title {
            background: transparent;
            padding: 20px 20px 15px;
            font-weight: 800;
            font-size: 1.1rem;
            color: #0f172a;
            border-bottom: 2px solid #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item:hover {
            background: #f8fafc;
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #334155;
        }

        .setting-label i {
            width: 35px;
            height: 35px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .setting-label .icon-blue {
            background: #eff6ff;
            color: #3b82f6;
        }

        .setting-label .icon-teal {
            background: #f0fdfa;
            color: #0d9488;
        }

        .setting-label .icon-red {
            background: #fef2f2;
            color: #ef4444;
        }

        .setting-label .icon-purple {
            background: #f5f3ff;
            color: #8b5cf6;
        }

        .setting-label .icon-indigo {
            background: #eef2ff;
            color: #6366f1;
        }

        .setting-label .icon-orange {
            background: #fff7ed;
            color: #f97316;
        }

        .setting-label .icon-gray {
            background: #f1f5f9;
            color: #64748b;
        }

        .setting-label .icon-dark {
            background: #f8fafc;
            color: #334155;
        }

        .setting-label .icon-green {
            background: #f0fdf4;
            color: #22c55e;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            border-radius: 28px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .toggle-switch input:checked+.toggle-slider {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Input fields */
        .setting-input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            color: #334155;
            width: 160px;
            text-align: center;
            transition: border-color 0.2s;
            direction: rtl;
        }

        .setting-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Reset Button */
        .reset-btn {
            margin: 0 15px 30px;
            padding: 16px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: calc(100% - 30px);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .save-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 9999;
            transition: transform 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .save-toast.show {
            transform: translateX(-50%) translateY(0);
        }

        @media (max-width: 600px) {
            .setting-input {
                width: 120px;
            }
        }

        /* Packages Styling */
        .packages-list {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .package-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .package-info h4 {
            margin: 0;
            color: #1e293b;
            font-size: 1rem;
        }

        .package-info p {
            margin: 2px 0 0;
            color: #64748b;
            font-size: 0.8rem;
        }

        .package-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon-danger {
            color: #ef4444;
            background: #fee2e2;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
        }

        .add-package-form {
            padding: 20px;
            background: #f1f5f9;
            border-top: 1px solid #e2e8f0;
        }

        .package-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .package-inputs {
                grid-template-columns: 1fr;
            }
        }

        .pkg-input {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Collapsible Styling */
        .section-title {
            cursor: pointer;
            position: relative;
        }

        .section-title::after {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 20px;
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .settings-section.active .section-title::after {
            transform: rotate(180deg);
        }

        .section-content {
            display: none;
            border-top: 1px solid #f1f5f9;
        }

        .settings-section.active .section-content {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .balance-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <!-- PIN Lock Overlay -->
    <div id="pin-lock-overlay"
        style="position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;">
        <div
            style="background: rgba(255,255,255,0.05); padding: 50px 40px; border-radius: 30px; text-align: center; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 30px 60px rgba(0,0,0,0.4); max-width: 90%; width: 400px; position:relative; overflow:hidden;">
            <!-- Glow Effect -->
            <div
                style="position:absolute; top:-50px; left:-50px; width:150px; height:150px; background:rgba(99, 102, 241, 0.4); filter:blur(60px); border-radius:50%;">
            </div>

            <div style="font-size: 3.5rem; margin-bottom: 20px; position:relative; z-index:2;"><i
                    class="fas fa-shield-alt" style="color:#6366f1;"></i></div>
            <h2
                style="margin: 0 0 10px 0; font-size: 1.8rem; font-weight:800; position:relative; z-index:2; font-family:'Outfit', sans-serif;">
                Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ©</h2>
            <p style="color: #94a3b8; margin-bottom: 35px; font-size: 0.95rem; position:relative; z-index:2;">Ø§Ù„Ø±Ø¬Ø§Ø¡
                Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>

            <div style="margin-bottom: 25px; position: relative; z-index:2;">
                <input type="password" id="pin-input" maxlength="4" inputmode="numeric" autocomplete="off"
                    style="font-size: 2.2rem; letter-spacing: 20px; width: 220px; text-align: center; padding: 15px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white; outline: none; transition: 0.3s; font-family:'Outfit', sans-serif;"
                    placeholder="â€¢â€¢â€¢â€¢">
            </div>

            <div id="pin-error"
                style="color: #fca5a5; height: 25px; font-size: 0.9rem; margin-bottom: 20px; position:relative; z-index:2; font-weight:600; opacity:0; transition:0.3s;">
            </div>

            <button onclick="checkPin()"
                style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; padding: 16px 40px; border-radius: 16px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s; box-shadow: 0 10px 20px rgba(99,102,241,0.3); position:relative; z-index:2;">
                <i class="fas fa-unlock-alt" style="margin-left:8px;"></i> ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </button>

            <button onclick="window.location.href='index.html'"
                style="background: transparent; color: #94a3b8; border: none; margin-top: 25px; font-size: 0.95rem; cursor: pointer; text-decoration: none; position:relative; z-index:2; display:flex; align-items:center; justify-content:center; gap:8px; width:100%; transition:0.2s;">
                <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>
        </div>
    </div>

    <script>
        // PIN Security Logic
        (function () {
            // Check if already unlocked in this session
            if (sessionStorage.getItem('settings_unlocked') === 'true') {
                document.getElementById('pin-lock-overlay').style.display = 'none';
            } else {
                // Focus input automatically
                setTimeout(() => document.getElementById('pin-input').focus(), 500);
            }

            // Enter key support
            document.getElementById('pin-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') checkPin();
            });

            // Auto-submit on 4 digits
            document.getElementById('pin-input').addEventListener('input', function (e) {
                if (this.value.length === 4) checkPin();
            });
        })();

        window.checkPin = async function () {
            const input = document.getElementById('pin-input');
            const error = document.getElementById('pin-error');
            const enteredPin = input.value;
            const submitBtn = input.nextElementSibling.nextElementSibling; // the button

            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            error.style.opacity = '0';

            let storedPin = '0000';

            try {
                // Wait briefly if DataManager is still loading
                for (let i = 0; i < 30; i++) {
                    if (typeof DataManager !== 'undefined' && DataManager.db) break;
                    await new Promise(res => setTimeout(res, 100));
                }

                if (typeof DataManager !== 'undefined' && DataManager.db) {
                    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
                    const snapshot = await getDoc(doc(DataManager.db, "settings", "global"));
                    if (snapshot.exists() && snapshot.data().pinCode !== undefined) {
                        storedPin = snapshot.data().pinCode;
                        const localSettings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
                        localSettings.pinCode = storedPin;
                        localStorage.setItem('sas_settings', JSON.stringify(localSettings));
                    }
                } else {
                    const localSettings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
                    if (localSettings && localSettings.pinCode !== undefined) {
                        storedPin = localSettings.pinCode;
                    }
                }
            } catch (e) {
                console.warn("Direct auth fetch failed, fallback to local:", e);
                const localSettings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
                if (localSettings && localSettings.pinCode !== undefined) {
                    storedPin = localSettings.pinCode;
                }
            }

            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-unlock-alt" style="margin-left:8px;"></i> ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';

            if (enteredPin === storedPin || storedPin === "") {
                sessionStorage.setItem('settings_unlocked', 'true');
                document.getElementById('pin-lock-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('pin-lock-overlay').style.display = 'none';
                    // Trigger UI render setup once pin succeeds to be safe
                    setInterval(() => {
                        if (typeof DataManager !== 'undefined' && DataManager.getSystemBalance) {
                            const balance = DataManager.getSystemBalance() || 0;
                            const balEl = document.getElementById('display-system-balance');
                            if (balEl) balEl.innerText = balance.toLocaleString('en-US') + ' IQD';
                        }
                    }, 1000);
                }, 300);
            } else {
                error.innerText = 'Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!';
                error.style.opacity = '1';
                input.style.borderColor = '#ef4444';
                input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.2)';
                input.value = '';

                // Add shake animation
                input.style.transform = 'translateX(-5px)';
                setTimeout(() => input.style.transform = 'translateX(5px)', 50);
                setTimeout(() => input.style.transform = 'translateX(-5px)', 100);
                setTimeout(() => input.style.transform = 'translateX(0)', 150);

                setTimeout(() => {
                    input.style.borderColor = 'rgba(255,255,255,0.1)';
                    input.style.boxShadow = 'none';
                    error.style.opacity = '0';
                }, 2000);
            }
        }
    </script>
    <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

    <nav class="navbar" id="main-nav">
        <div class="header-card" style="margin:0; background:none; box-shadow:none; border:none; padding:0 0 20px 0;">
            <div class="logo" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 0;">
                <i class="fas fa-chart-line"></i> OK Computer
            </div>
            <button class="close-menu" onclick="toggleMenu()"
                style="position: absolute; left: 0; top: 0;">&times;</button>
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</a></li>
            <li><a href="active_subscribers.html"><i class="fas fa-signal"></i> Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¯ÙŠÙˆÙ†</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
            <li><a href="employees.html"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a></li>
            <li><a href="telegram-settings.html"><i class="fab fa-telegram"></i> Telegram</a></li>
            <li><a href="settings.html" class="active"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</a></li>
        </ul>
        <div class="nav-overlay" onclick="toggleMenu()"></div>
    </nav>

    <div class="settings-header">
        <h1><i class="fas fa-cog" style="color:#6366f1;"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ®ØµÙŠØµ</h1>
        <p>ØªØ­ÙƒÙ… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ…Ø¸Ù‡Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø© ØªØ§Ù…Ø©</p>
        <button onclick="forceUpdateSystem()"
            style="margin-top: 20px; background: white; color: #ef4444; border: 1px solid #ef4444; padding: 10px 20px; border-radius: 12px; font-size: 0.9rem; cursor: pointer; font-weight: bold; transition: 0.2s;">
            <i class="fas fa-sync-alt"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
        </button>
    </div>

    <!-- Grid Container Start -->
    <div class="settings-grid">

        <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰) -->
        <div class="settings-section">
            <div class="section-title"><i class="fas fa-box-open" style="color:#f59e0b;"></i> Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div>
            <div class="section-content">
                <div id="packages-container" class="packages-list">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ù‡Ù†Ø§ -->
                </div>

                <div class="add-package-form"
                    style="background: #f8fafc; border:none; padding:20px; margin:15px; border-radius:15px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 0.95rem; color: #475569;"><i
                            class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <div class="package-inputs">
                        <input type="text" id="pkg-name" class="pkg-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø© (Ù…Ø«Ù„Ø§Ù‹: Ù†ÙˆØ±Ù…Ø§Ù„)">
                        <input type="number" id="pkg-cost" class="pkg-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø±ØµÙŠØ¯)">
                        <input type="number" id="pkg-sale" class="pkg-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹ (ØµÙ†Ø¯ÙˆÙ‚)">
                    </div>
                    <button onclick="addNewPackage()" class="btn-primary"
                        style="width: 100%; padding: 12px; border-radius: 12px; border: none; background: #0f172a; color: white; font-weight: bold; cursor: pointer;">
                        Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù‚Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø¥Ø¯Ø§Ø±Ø© Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„ØªÙØ¹ÙŠÙ„Ø§Øª) -->
        <div class="settings-section">
            <div class="section-title"><i class="fas fa-wallet" style="color:#10b981;"></i> Ø±ØµÙŠØ¯ ÙˆØ­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
            </div>
            <div class="section-content">
                <div style="padding: 20px;">
                    <div
                        style="background: white; border: 2px solid #f1f5f9; padding: 30px 20px; border-radius: 24px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); position:relative; overflow:hidden;">

                        <div
                            style="font-size: 0.95rem; color: #64748b; font-weight:700; margin-bottom: 8px; position:relative; z-index:2;">
                            <i class="fas fa-coins" style="color:#10b981;"></i> Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ± Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©
                        </div>
                        <div id="display-system-balance"
                            style="font-size: 3rem; font-weight: 800; font-family:'Outfit', sans-serif; letter-spacing:1px; color:#0f172a; position:relative; z-index:2;">
                            0 IQD</div>
                    </div>

                    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
                    <div style="margin-bottom:20px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <button onclick="adjustSystemBalance(22000)"
                            style="background: #f0fdf4; border: 1.5px solid #bbf7d0; color: #16a34a; font-weight: bold; border-radius: 14px; padding: 12px; cursor: pointer; transition: 0.2s; font-size:0.95rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;">
                            <i class="fas fa-plus-circle"></i> Ù†ÙˆØ±Ù…Ø§Ù„ (+22k)
                        </button>
                        <button onclick="adjustSystemBalance(-22000)"
                            style="background: #fef2f2; border: 1.5px solid #fecaca; color: #ef4444; font-weight: bold; border-radius: 14px; padding: 12px; cursor: pointer; transition: 0.2s; font-size:0.95rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;">
                            <i class="fas fa-minus-circle"></i> Ù†ÙˆØ±Ù…Ø§Ù„ (-22k)
                        </button>
                        <button onclick="adjustSystemBalance(24000)"
                            style="background: #f0fdf4; border: 1.5px solid #bbf7d0; color: #16a34a; font-weight: bold; border-radius: 14px; padding: 12px; cursor: pointer; transition: 0.2s; font-size:0.95rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;">
                            <i class="fas fa-plus-circle"></i> Ø³ÙˆØ¨Ø± (+24k)
                        </button>
                        <button onclick="adjustSystemBalance(-24000)"
                            style="background: #fef2f2; border: 1.5px solid #fecaca; color: #ef4444; font-weight: bold; border-radius: 14px; padding: 12px; cursor: pointer; transition: 0.2s; font-size:0.95rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;">
                            <i class="fas fa-minus-circle"></i> Ø³ÙˆØ¨Ø± (-24k)
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0;">
                        <label
                            style="display: block; font-size: 0.95rem; color: #334155; margin-bottom: 15px; font-weight: bold;"><i
                                class="fas fa-keyboard" style="color:#64748b;"></i> Ø¥Ø¯Ø®Ø§Ù„ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø®ØµØµ Ù„Ù„Ø±ØµÙŠØ¯</label>
                        <div style="display: flex; gap: 10px; flex-direction: column;">
                            <input type="number" id="input-system-balance" class="pkg-input"
                                style="width: 100%; text-align: center; font-weight: bold; font-size:1.2rem; padding:15px; border-radius:12px; background:white;"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙƒÙ„ÙŠØ§Ù‹...">
                            <button onclick="updateSystemBalanceDirectly()" class="btn-primary"
                                style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size:1.05rem; box-shadow:0 4px 10px rgba(59,130,246,0.3); transition:0.2s;">
                                <i class="fas fa-check-circle"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ ÙƒÙ‚ÙŠÙ…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© -->
    <div class="settings-section">
        <div class="section-title"><i class="fas fa-sliders-h" style="color:#3b82f6;"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªØ³Ø¹ÙŠØ±
        </div>
        <div class="section-content">
            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-indigo fas fa-tag"></i>
                    <span>Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                </div>
                <input type="text" class="setting-input" id="set-system-name" value="OK Computer">
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-green fas fa-money-bill"></i>
                    <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>
                </div>
                <input type="number" class="setting-input" id="set-default-price" value="35000">
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-blue fas fa-calendar-alt"></i>
                    <span>Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø£ÙŠØ§Ù…)</span>
                </div>
                <input type="number" class="setting-input" id="set-sub-duration" value="30">
            </div>
        </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„ØªØ­ÙƒÙ… -->
    <div class="settings-section">
        <div class="section-title"><i class="fas fa-shield-alt" style="color:#ef4444;"></i> Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</div>
        <div class="section-content">
            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-red fas fa-trash-alt"></i>
                    <div>
                        <span>Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="set-allow-box-deletion">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item" style="border-top:1px dashed #e2e8f0; margin-top:10px; padding-top:20px;">
                <div class="setting-label">
                    <i class="icon-red fas fa-lock"></i>
                    <div style="text-align: right;">
                        <span style="display:block;">ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ø­Ù…Ø§ÙŠØ© (PIN)</span>
                        <p style="font-size:0.75rem; color:#94a3b8; margin:0;">Ø§Ø­Ø°ÙÙ‡ Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„</p>
                    </div>
                </div>
                <input type="text" class="setting-input" id="set-pin-code" placeholder="0000" maxlength="4"
                    inputmode="numeric" style="width: 100px;">
            </div>
        </div>
    </div>

    <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
    <div class="settings-section">
        <div class="section-title"><i class="fas fa-th-large" style="color:#8b5cf6;"></i> Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="section-content">
            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-blue fas fa-users"></i>
                    <span>Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-subscribers-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-teal fas fa-signal"></i>
                    <span>Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-active-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-red fas fa-money-bill-wave"></i>
                    <span>Ø§Ù„Ø¯ÙŠÙˆÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-debts-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-purple fas fa-wallet"></i>
                    <span>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-payments-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-indigo fas fa-chart-bar"></i>
                    <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-reports-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-orange fas fa-user-tie"></i>
                    <span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-employees-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-orange fas fa-exclamation-triangle"></i>
                    <span>ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-expiring-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-gray fas fa-times-circle"></i>
                    <span>Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-expired-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-dark fab fa-telegram-plane"></i>
                    <span>Ø¨ÙˆØª Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="card-telegram-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- ØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div class="settings-section">
        <div class="section-title"><i class="fas fa-bars" style="color:#0d9488;"></i> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</div>
        <div class="section-content">
            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-blue fas fa-users"></i>
                    <span>Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-subscribers-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-teal fas fa-signal"></i>
                    <span>Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-active-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-red fas fa-money-bill-wave"></i>
                    <span>Ø§Ù„Ø¯ÙŠÙˆÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-debts-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-purple fas fa-hand-holding-usd"></i>
                    <span>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-payments-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-indigo fas fa-chart-bar"></i>
                    <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-reports-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-orange fas fa-users-cog"></i>
                    <span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-employees-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <i class="icon-dark fab fa-telegram"></i>
                    <span>Telegram</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="nav-telegram-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Grid End -->
    </div>

    <!-- Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¬Ø¯ÙŠØ¯) -->
    <div style="padding: 0 15px;">
        <button class="save-btn" onclick="saveAllSettings()"
            style="background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">
            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>

        <!-- Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† -->
        <button class="reset-btn" onclick="resetAllSettings()">
            <i class="fas fa-undo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>

        <!-- Toast -->
        <div class="save-toast" id="saveToast">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>

        <script>
            const SETTINGS_KEY = 'sas_settings';

            // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===
            function loadSettings() {
                console.log("ğŸ› ï¸ UI: loadSettings() triggered");

                // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† DataManager (Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹) Ù…Ø¹ ØªÙØ¶ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø­Ø§Ø¨ ÙØ§Ø±ØºØ§Ù‹ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                const cloudSettings = (typeof DataManager !== 'undefined' && DataManager.getSystemSettings)
                    ? DataManager.getSystemSettings() : {};
                const localSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');

                // Ø¯Ù…Ø¬ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª)
                const settings = Object.keys(cloudSettings).length > 0 ? cloudSettings : localSettings;

                console.log("ğŸ“¦ UI: Applying settings to fields:", settings);

                if (Object.keys(settings).length === 0) {
                    console.log("â„¹ï¸ No settings found in Cloud or LocalStorage.");
                    return;
                }

                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
                if (settings.systemName) document.getElementById('set-system-name').value = settings.systemName;
                if (settings.defaultPrice) document.getElementById('set-default-price').value = settings.defaultPrice;
                if (settings.subDuration) document.getElementById('set-sub-duration').value = settings.subDuration;
                if (settings.pinCode) document.getElementById('set-pin-code').value = settings.pinCode;
                if (settings.allowBoxDeletion !== undefined) document.getElementById('set-allow-box-deletion').checked = settings.allowBoxDeletion;

                // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© ÙÙŠ LocalStorage Ù„Ø¶Ù…Ø§Ù† ØªÙˆÙØ±Ù‡Ø§ Ù„Ù€ PIN Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø³Ø±Ø¹Ø©
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));

                // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù…
                if (typeof DataManager !== 'undefined') {
                    const balance = DataManager.getSystemBalance() || 0;
                    document.getElementById('display-system-balance').innerText = balance.toLocaleString('en-US') + ' IQD';
                }

                // ÙƒØ±ÙˆØª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                const toggleMap = {
                    'card-subscribers': 'card-subscribers-toggle',
                    'card-active': 'card-active-toggle',
                    'card-debts': 'card-debts-toggle',
                    'card-payments': 'card-payments-toggle',
                    'card-reports': 'card-reports-toggle',
                    'nav-card-employees': 'card-employees-toggle',
                    'card-expiring': 'card-expiring-toggle',
                    'card-expired': 'card-expired-toggle',
                    'nav-card-telegram': 'card-telegram-toggle'
                };

                for (const [key, id] of Object.entries(toggleMap)) {
                    const el = document.getElementById(id);
                    if (el) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (undefined)ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ true Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                        el.checked = settings[key] !== false;
                    }
                }

                // ØµÙØ­Ø§Øª Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø±
                const navKeys = ['nav-subscribers', 'nav-active', 'nav-debts', 'nav-payments', 'nav-reports', 'nav-employees', 'nav-telegram'];
                navKeys.forEach(key => {
                    const el = document.getElementById(key + '-toggle');
                    if (el) el.checked = settings[key] !== false;
                });

                // Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø« Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©)
                window.currentPackages = settings.packages || [];
                if (window.currentPackages.length === 0) {
                    window.currentPackages = [
                        { id: 'pkg_norm', name: 'Ù†ÙˆØ±Ù…Ø§Ù„ (Normal)', costPrice: 22000, salePrice: 35000 },
                        { id: 'pkg_super', name: 'Ø³ÙˆØ¨Ø± (Super)', costPrice: 24000, salePrice: 40000 },
                        { id: 'pkg_gold', name: 'Ø¬ÙˆÙ„Ø¯ (Gold)', costPrice: 28000, salePrice: 50000 }
                    ];
                }
                renderPackagesList();
            }

            function renderPackagesList() {
                const container = document.getElementById('packages-container');
                if (!container) return;

                if (window.currentPackages.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                    return;
                }

                container.innerHTML = window.currentPackages.map(pkg => {
                    let icon = 'fa-box';
                    let color = '#64748b';
                    if (pkg.name.toLowerCase().includes('norm')) { icon = 'fa-star'; color = '#3b82f6'; }
                    if (pkg.name.toLowerCase().includes('sup')) { icon = 'fa-bolt'; color = '#f59e0b'; }
                    if (pkg.name.toLowerCase().includes('gold')) { icon = 'fa-crown'; color = '#eab308'; }

                    return `
                    <div class="package-card" style="border-right: 5px solid ${color};">
                        <div class="package-info">
                            <h4 style="display:flex; align-items:center; gap:8px;">
                                <i class="fas ${icon}" style="color:${color}"></i>
                                ${pkg.name}
                            </h4>
                            <p>Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯: <b style="color:#ef4444;">${pkg.costPrice.toLocaleString()}</b> | Ø³Ø¹Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹: <b style="color:#10b981;">${pkg.salePrice.toLocaleString()}</b></p>
                        </div>
                        <div class="package-actions">
                            <button onclick="removePackage('${pkg.id}')" class="btn-icon-danger"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            window.addNewPackage = function () {
                const name = document.getElementById('pkg-name').value;
                const cost = parseInt(document.getElementById('pkg-cost').value);
                const sale = parseInt(document.getElementById('pkg-sale').value);

                if (!name || isNaN(cost) || isNaN(sale)) {
                    return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                }

                const newPkg = {
                    id: 'pkg_' + Date.now(),
                    name,
                    costPrice: cost,
                    salePrice: sale
                };

                window.currentPackages.push(newPkg);
                renderPackagesList();

                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('pkg-name').value = '';
                document.getElementById('pkg-cost').value = '';
                document.getElementById('pkg-sale').value = '';
            }

            window.removePackage = function (id) {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø§Ù‚Ø©ØŸ')) return;
                window.currentPackages = window.currentPackages.filter(p => p.id !== id);
                renderPackagesList();
            }

            // Ø¬Ø¹Ù„ loadSettings Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ù€ DataManager
            window.loadSettings = loadSettings;

            // === Ø­ÙØ¸ Ø§Ù„ÙƒÙ„ ===
            async function saveAllSettings() {
                console.log("ğŸš€ UI: saveAllSettings() started");
                const settings = {};

                // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
                settings.systemName = document.getElementById('set-system-name').value;
                settings.defaultPrice = parseInt(document.getElementById('set-default-price').value || 35000);
                settings.subDuration = parseInt(document.getElementById('set-sub-duration').value || 30);
                settings.pinCode = document.getElementById('set-pin-code').value || '0000';

                // 2. ÙƒØ±ÙˆØª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                const toggleMap = {
                    'card-subscribers': 'card-subscribers-toggle',
                    'card-active': 'card-active-toggle',
                    'card-debts': 'card-debts-toggle',
                    'card-payments': 'card-payments-toggle',
                    'card-reports': 'card-reports-toggle',
                    'nav-card-employees': 'card-employees-toggle',
                    'card-expiring': 'card-expiring-toggle',
                    'card-expired': 'card-expired-toggle',
                    'nav-card-telegram': 'card-telegram-toggle'
                };
                for (const [key, id] of Object.entries(toggleMap)) {
                    const el = document.getElementById(id);
                    if (el) settings[key] = el.checked;
                }

                // 3. Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø±
                const navKeys = ['nav-subscribers', 'nav-active', 'nav-debts', 'nav-payments', 'nav-reports', 'nav-employees', 'nav-telegram'];
                navKeys.forEach(key => {
                    const el = document.getElementById(key + '-toggle');
                    if (el) settings[key] = el.checked;
                });

                // 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                settings.allowBoxDeletion = document.getElementById('set-allow-box-deletion').checked;

                // 5. Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
                settings.packages = window.currentPackages || [];

                console.log("ğŸ“¤ UI: Sending data to DataManager:", settings);

                if (typeof DataManager !== 'undefined' && DataManager.saveAllSystemSettings) {
                    try {
                        await DataManager.saveAllSystemSettings(settings);
                        console.log("âœ… UI: Remote save successful");
                        showSaveToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
                    } catch (err) {
                        console.error("âŒ UI: Remote save failed:", err);
                        showSaveToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ - ØªÙÙ‚Ø¯ Ø§Ù„ÙƒÙˆÙ†Ø³Ù„');
                    }
                } else {
                    console.warn("âš ï¸ UI: DataManager not found, falling back to LocalStorage");
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                    showSaveToast('âš ï¸ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·');
                }
            }

            window.updateSystemBalanceDirectly = async function () {
                const newBalanceStr = document.getElementById('input-system-balance').value;
                if (newBalanceStr === '') return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±ØµÙŠØ¯');

                const newBalance = parseFloat(newBalanceStr);
                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„ÙŠØµØ¨Ø­ ${newBalance.toLocaleString('en-US')} IQDØŸ`)) {
                    if (typeof DataManager !== 'undefined' && DataManager.setSystemBalance) {
                        const success = await DataManager.setSystemBalance(newBalance);
                        if (success) {
                            document.getElementById('display-system-balance').innerText = newBalance.toLocaleString('en-US') + ' IQD';
                            document.getElementById('input-system-balance').value = '';
                            showSaveToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
                        }
                    }
                }
            }

            window.adjustSystemBalance = async function (amount) {
                if (typeof DataManager === 'undefined' || !DataManager.setSystemBalance) return;

                const currentBalance = DataManager.getSystemBalance() || 0;
                const newBalance = currentBalance + amount;
                const actionText = amount > 0 ? "Ø¥Ø¶Ø§ÙØ©" : "Ø®ØµÙ…";
                const amtStr = Math.abs(amount).toLocaleString('en-US');

                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${actionText} ${amtStr} IQD Ù„ÙŠØµØ¨Ø­ Ø§Ù„Ø±ØµÙŠØ¯ ${newBalance.toLocaleString('en-US')} IQDØŸ`)) {
                    const success = await DataManager.setSystemBalance(newBalance);
                    if (success) {
                        document.getElementById('display-system-balance').innerText = newBalance.toLocaleString('en-US') + ' IQD';
                        showSaveToast('âœ… ØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    }
                }
            }

            window.toggleSection = function (el) {
                el.classList.toggle('active');
            }

            window.forceUpdateSystem = async function () {
                if (!confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) return;

                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                }

                if ('caches' in window) {
                    const keys = await caches.keys();
                    for (let key of keys) {
                        await caches.delete(key);
                    }
                }

                localStorage.clear(); // Safe as most data is cloud-synced, but optional. 
                // Better only clear specific keys if we want to keep login.
                // localStorage.removeItem('sas_settings'); 

                location.reload(true);
            }



            // === Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ===
            function resetAllSettings() {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ')) return;
                // Ù„Ù„ØªØµÙÙŠØ± Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØŒ Ø³Ù†Ø­ØªØ§Ø¬ Ù„Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø£Ùˆ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.
                // Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ø³Ù†Ù…Ø³Ø­ Ø§Ù„Ù€ localStorage ÙˆÙ†Ø·Ù„Ø¨ Ø§Ù„Ø­Ø°Ù ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ù†ØªØ±ÙƒÙ‡Ø§
                localStorage.removeItem(SETTINGS_KEY);
                showSaveToast('ğŸ”„ ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ. Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….');
                loadSettings();
            }

            // === Toast ===
            function showSaveToast(msg) {
                const toast = document.getElementById('saveToast');
                toast.innerText = msg || 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }

            // === Menu Toggle ===
            window.toggleMenu = function () {
                const nav = document.getElementById('main-nav');
                nav.classList.toggle('active');
                document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
            };

            // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            loadSettings();
        </script>
        <script type="module">
            import { DataManager } from './data-manager.js?v=34.0';
            window.DataManager = DataManager;
            DataManager.init();
        </script>
</body>

</html>