<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø¯ÙŠÙˆÙ† - OK Computer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Kufi+Arabic:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=25.0">
    <link rel="stylesheet" href="style-fab.css?v=1.0">
    <link rel="stylesheet" href="style-modal.css?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="auth-system.js"></script>
    <script src="whatsapp-helper.js"></script>
    <script type="module">
        import { DataManager } from './data-manager.js?v=21.0';
        window.DataManager = DataManager;
        DataManager.init();
    </script>

    <style>
        :root {
            --debt-gradient: linear-gradient(135deg, #ef4444 0%, #991b1b 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        body {
            font-family: 'Noto Kufi Arabic', 'Outfit', sans-serif;
            background: #f0f2f5;
        }

        .header-section {
            background: var(--debt-gradient);
            padding: 40px 20px 60px;
            border-radius: 0 0 40px 40px;
            color: white;
            text-align: center;
            margin-bottom: -40px;
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.2);
        }

        .header-section h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .total-debt-box {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            display: inline-block;
            margin-top: 15px;
            border: 2px solid #fee2e2;
        }

        .debt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 60px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .debt-card {
            background: var(--glass);
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .debt-card:hover {
            transform: translateY(-5px);
            background: white;
        }

        .debt-amount {
            color: #dc2626;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .btn-pay {
            background: #10b981;
            color: white;
        }

        .btn-wa {
            background: #25d366;
            color: white;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .debt-card {
            animation: fadeIn 0.4s ease-out;
        }
    </style>
</head>

<body>
    <script>AuthSystem.checkSession();</script>

    <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

    <nav class="navbar" id="main-nav">
        <!-- Reusing Sidebar -->
        <div class="header-card"
            style="margin: 0; background: none; box-shadow: none; border: none; padding: 0 0 20px 0;">
            <div class="logo" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 0;">
                <i class="fas fa-chart-line"></i> OK Computer
            </div>
            <button class="close-menu" onclick="toggleMenu()"
                style="position: absolute; left: 0; top: 0;">&times;</button>
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</a></li>
            <li><a href="active_subscribers.html"><i class="fas fa-signal"></i> Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†</a></li>
            <li><a href="expired.html"><i class="fas fa-clock"></i> Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</a></li>
            <li><a href="debts.html" class="active"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¯ÙŠÙˆÙ†</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
            <li><a href="employees.html"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</a></li>
        </ul>
        <div class="nav-overlay" onclick="toggleMenu()"></div>
    </nav>

    <div class="header-section">
        <h1>Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h1>
        <p>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</p>
        <div class="total-debt-box">
            <span style="color:#64748b; font-size: 0.8rem; display:block;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙˆÙ†</span>
            <span id="totalDebtDisplay" style="color:#dc2626; font-size:1.4rem; font-weight:800;">0 Ø¯.Ø¹</span>
        </div>
        <br>
        <button id="adminShareBtn" class="btn btn-sm btn-primary" onclick="window.openShareDebtsModal()"
            style="display:none; margin-top:15px; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3);">
            <i class="fas fa-share-alt"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù…ÙˆØ¸Ù
        </button>
    </div>

    <div class="container">
        <div class="search-container" style="max-width: 600px; margin: 0 auto; position: relative; z-index: 10;">
            <div class="search-input-wrapper"
                style="background:white; border-radius: 20px; display: flex; align-items: center; padding: 5px 20px; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.1);">
                <i class="fas fa-search" style="color:#888; margin-left:10px;"></i>
                <input type="text" id="debtSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†..." onkeyup="renderDebts()"
                    style="border:none; padding:15px; width:100%; outline:none;">
            </div>
        </div>

        <div id="grid" class="debt-grid"></div>
    </div>

    <!-- Modals -->
    <div id="payDebtModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ† - <span id="debtSubName"></span></h3><button class="close-btn"
                    onclick="closeDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="debtSubId"><input type="hidden" id="debtSubFirebaseId">
                <div class="form-group"><label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span
                            id="currentDebtAmount">0</span>)</label><input type="number" id="payDebtAmount"></div>
                <div style="margin-bottom:15px;"><input type="checkbox" id="send-whatsapp-debt"> <label
                        for="send-whatsapp-debt">Ø¥Ø±Ø³Ø§Ù„ ÙˆØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</label></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="confirmPayDebt(true)" class="btn btn-success"><i class="fas fa-print"></i> ØªØ³Ø¯ÙŠØ¯
                        ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
                    <button onclick="confirmPayDebt(false)" class="btn btn-primary"><i class="fas fa-check"></i> ØªØ³Ø¯ÙŠØ¯
                        ÙÙ‚Ø·</button>
                </div>
            </div>
        </div>
    </div>

    <div id="shareDebtsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Ø¥Ø±Ø³Ø§Ù„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ†</h3><button class="close-btn" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</label><select id="employeeSelect"
                        style="width:100%; padding:12px; border-radius:10px; border:2px solid #eee;"></select></div>
                <button onclick="sendDebtsToEmployee()" class="btn btn-success btn-full"><i class="fab fa-whatsapp"></i>
                    Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>
        </div>
    </div>

    <script>
        window.renderDebts = function () {
            if (typeof DataManager === 'undefined' || !DataManager.subscribers) {
                console.log('â³ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                return;
            }

            const q = document.getElementById('debtSearch').value.toLowerCase();

            console.log('ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:', DataManager.subscribers.length);

            // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ† ÙÙ‚Ø·
            let list = DataManager.subscribers.filter(s => {
                const debt = parseInt(s.price || 0);
                return debt > 0;
            });

            console.log('ğŸ’° Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†:', list.length);

            // Ø§Ù„Ø¨Ø­Ø« (Ù…Ø¹ ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…)
            if (q) {
                list = list.filter(s => {
                    if (!s.name) return false;
                    const nameMatch = s.name.toLowerCase().includes(q);
                    const phoneMatch = s.phone && s.phone.includes(q);
                    return nameMatch || phoneMatch;
                });
            }

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠÙ† (Ø§Ù„Ø£ÙƒØ¨Ø± Ø£ÙˆÙ„Ø§Ù‹)
            list.sort((a, b) => parseInt(b.price) - parseInt(a.price));

            const total = list.reduce((sum, s) => sum + parseInt(s.price || 0), 0);
            document.getElementById('totalDebtDisplay').innerText = total.toLocaleString() + ' Ø¯.Ø¹';

            const grid = document.getElementById('grid');
            if (list.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#aaa;"><i class="fas fa-smile-beam fa-3x"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>';
                return;
            }

            grid.innerHTML = list.map(s => `
                <div class="debt-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h3 style="margin:0;">${s.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</h3>
                            <p style="margin:5px 0; color:#64748b; font-size:0.9rem;">${s.phone || '-'}</p>
                        </div>
                        <div class="debt-amount">${parseInt(s.price).toLocaleString()} <small style="font-size:0.6rem;">Ø¯.Ø¹</small></div>
                    </div>
                    <div style="background:#f8fafc; padding:12px; border-radius:15px; font-size:0.85rem; color:#64748b; display:flex; justify-content:space-between;">
                        <span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span>
                        <span>${s.expiryDate || '-'}</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <button onclick="openPayDebtModal('${s.id}', '${s.firebaseId}', '${(s.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…').replace(/'/g, "")}', ${s.price})" class="btn-action btn-pay" style="padding:12px; border:none; border-radius:14px; font-weight:bold; cursor:pointer;"><i class="fas fa-money-bill-wave"></i> ØªØ³Ø¯ÙŠØ¯</button>
                        <button onclick="notifyDebtor('${(s.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…').replace(/'/g, "")}', '${s.phone}', ${s.price})" class="btn-action btn-wa" style="padding:12px; border:none; border-radius:14px; font-weight:bold; cursor:pointer;"><i class="fab fa-whatsapp"></i> ØªÙ†Ø¨ÙŠÙ‡</button>
                    </div>
                </div>
            `).join('');
        };

        window.openPayDebtModal = (id, fid, name, amt) => {
            document.getElementById('debtSubId').value = id;
            document.getElementById('debtSubFirebaseId').value = fid;
            document.getElementById('debtSubName').innerText = name;
            document.getElementById('currentDebtAmount').innerText = amt.toLocaleString();
            document.getElementById('payDebtModal').classList.add('active');
        };
        window.closeDebtModal = () => document.getElementById('payDebtModal').classList.remove('active');
        window.confirmPayDebt = async (p) => {
            let amt = parseInt(document.getElementById('payDebtAmount').value);
            if (!amt) return;
            await DataManager.payDebt(document.getElementById('debtSubFirebaseId').value, document.getElementById('debtSubId').value, amt);
            if (p) DataManager.printReceipt({ title: "ÙˆØµÙ„ ØªØ³Ø¯ÙŠØ¯", subName: document.getElementById('debtSubName').innerText, amount: amt, totalRemaining: 0, date: new Date().toLocaleDateString('ar-IQ'), type: "ØªØ³Ø¯ÙŠØ¯" });
            closeDebtModal();
        };

        window.notifyDebtor = (name, phone, amt) => {
            WhatsAppHelper.sendDebtReminder(name, phone, amt);
        };

        window.openShareDebtsModal = () => {
            let select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option>';
            DataManager.getEmployees().forEach(e => select.innerHTML += `<option value="${e.phone}">${e.name}</option>`);
            document.getElementById('shareDebtsModal').classList.add('active');
        };
        window.closeShareModal = () => document.getElementById('shareDebtsModal').classList.remove('active');
        window.sendDebtsToEmployee = () => {
            let p = document.getElementById('employeeSelect').value;
            if (!p) return;
            let list = DataManager.subscribers.filter(s => parseInt(s.price || 0) > 0);
            let msg = `ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ†:\n` + list.slice(0, 20).map(s => `ğŸ‘¤ ${s.name}: ${parseInt(s.price).toLocaleString()}`).join('\n');
            WhatsAppHelper.send(p, msg);
            closeShareModal();
        };

        window.toggleMenu = () => document.getElementById('main-nav').classList.toggle('active');

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ renderDebts Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Firebase Ø³ØªØ­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

        window.onload = () => {
            // ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            setTimeout(() => {
                const user = AuthSystem.currentUser;
                if (user && user.type === 'admin') {
                    const btn = document.getElementById('adminShareBtn');
                    if (btn) btn.style.display = 'inline-block';
                }
            }, 100);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            setTimeout(() => renderDebts(), 500);
        };

        // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù
        setInterval(() => {
            if (typeof DataManager !== 'undefined' && DataManager.subscribers) {
                renderDebts();
            }
        }, 3000);
    </script>
</body>

</html>