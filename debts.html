<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ุงูุฏููู - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ุฅุถุงูุฉ AuthSystem -->
    <script src="auth-system.js"></script>
    <script>AuthSystem.checkSession();</script>

    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-money-bill-wave"></i> ุงูุฏููู
            <span id="user-name-display"
                style="font-size:0.8rem; margin-right:10px;opacity:0.8;font-weight:normal;"></span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> ุงูุฑุฆูุณูุฉ</a></li>
            <li id="nav-subscribers"><a href="subscribers.html"><i class="fas fa-users"></i> ุงููุดุชุฑููู</a></li>
            <li id="nav-debts"><a href="debts.html" class="active"><i class="fas fa-money-bill-wave"></i> ุงูุฏููู</a>
            </li>
            <li id="nav-payments"><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> ุงูุตูุฏูู</a></li>
            <li id="nav-reports"><a href="reports.html"><i class="fas fa-chart-bar"></i> ุงูุชูุงุฑูุฑ</a></li>
            <li id="nav-employees"><a href="employees.html"><i class="fas fa-users-cog"></i> ุงูููุธููู</a></li>
            <li id="nav-telegram"><a href="telegram-settings.html"><i class="fab fa-telegram"></i> Telegram</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> ุฎุฑูุฌ</a></li>
        </ul>
    </nav>

    <div class="container">

        <div class="header-card">
            <div>
                <h1>ุงูุฏููู ุงููุณุชุญูุฉ</h1>
                <p>ูุชุงุจุนุฉ ุงููุดุชุฑููู ุจูุธุงู ุงูุขุฌู</p>
            </div>
            <div id="totalDebtDisplay" class="text-danger" style="font-size:1.5rem; font-weight:bold;">
                0 ุฏ.ุน
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>ูุงุฆูุฉ ุงูุฏููู</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ุงูุงุณู</th>
                            <th>ุงููุจูุบ ุงููุชุจูู</th>
                            <th>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="debtsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Pay Debt -->
    <div id="payDebtModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>ุชุณุฏูุฏ ุฏูู - <span id="debtSubName"></span></h3>
                <button class="close-btn" onclick="closeDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="debtSubId">
                <div class="form-group">
                    <label>ุงููุจูุบ ุงููุฏููุน (ูู ุฃุตู <span id="currentDebtAmount"></span>)</label>
                    <input type="number" id="payDebtAmount">
                </div>
                <!-- WhatsApp Option for Debt Payment -->
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="send-whatsapp-debt" style="width: auto;">
                    <label for="send-whatsapp-debt" style="margin:0; font-weight:normal; cursor:pointer;">ุฅุฑุณุงู ุชูุงุตูู
                        ุงููุตู ูุงุชุณุงุจ</label>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="confirmPayDebt(true)" class="btn btn-success" style="flex:1"><i
                            class="fas fa-print"></i> ุชุณุฏูุฏ ูุทุจุงุนุฉ</button>
                    <button onclick="confirmPayDebt(false)" class="btn btn-primary" style="flex:1">ุชุณุฏูุฏ ููุท</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.openPayDebtModal = function (id, name, amount) {
            document.getElementById('debtSubId').value = id;
            document.getElementById('debtSubName').innerText = name;
            document.getElementById('currentDebtAmount').innerText = amount.toLocaleString();
            document.getElementById('payDebtAmount').value = '';
            document.getElementById('payDebtModal').classList.add('active');
        };
        window.closeDebtModal = () => document.getElementById('payDebtModal').classList.remove('active');

        window.confirmPayDebt = async function (print = false) {
            const subId = document.getElementById('debtSubId').value;
            const amount = document.getElementById('payDebtAmount').value;
            const sendWhatsapp = document.getElementById('send-whatsapp-debt').checked;

            if (!amount) return alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงููุจูุบ");

            const sub = DataManager.getSubscriber(subId);
            if (sub) {
                // Logic to update Debt
                // 1. Record Transaction (Income)
                await DataManager.recordTransaction(subId, parseInt(amount), `ุชุณุฏูุฏ ุฏูู ูู ุงููุดุชุฑู: ${sub.name}`, 'ููุฏ');

                // 2. Reduce the price (or debt field) logic - Here simpler is just record Transaction.
                // Assuming DataManager handles debt reduction? 
                // Wait, based on previous logic, debt is calculated dynamically or stored? 
                // Let's check updateSubscriber. Actually for debt system usually we update the subscriber price/debt valid.

                // For simplicity as per previous code:
                const newPrice = parseInt(sub.price) - parseInt(amount);
                await DataManager.updateSubscriber(subId, { price: newPrice }); // Reduce debt

                // Receipt Logic
                if (print) {
                    const receiptData = {
                        title: "ูุตู ุชุณุฏูุฏ ุฏูู",
                        subName: sub.name,
                        amount: parseInt(amount),
                        totalRemaining: newPrice,
                        date: new Date().toLocaleDateString('ar-IQ'),
                        type: "ุชุณุฏูุฏ ููุฏ"
                    };
                    DataManager.printReceipt(receiptData);
                }

                if (sendWhatsapp) {
                    const msg = `ูุฑุญุจุงู ${sub.name}ุ\n\nุชู ุงุณุชูุงู ุฏูุนุฉ ุชุณุฏูุฏ ุฏูู ุจูููุฉ: ${parseInt(amount).toLocaleString()} ุฏ.ุน\nุงููุชุจูู ุจุฐูุชูู: ${newPrice.toLocaleString()} ุฏ.ุน\n\nุดูุฑุงู ููู ๐น`;
                    let phone = sub.phone.replace(/^0+/, '');
                    if (!phone.startsWith('964')) phone = '964' + phone;
                    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                }

                closeDebtModal();
                DataManager.showToast("ุชู ุงูุชุณุฏูุฏ ุจูุฌุงุญ");
            }
        };

        window.renderDebts = function () {
            if (typeof DataManager === 'undefined') return;
            const list = DataManager.getSubscribers().filter(s => parseInt(s.price || 0) > 0);
            const tbody = document.getElementById('debtsTableBody');

            // Calculate Total Debt
            const total = list.reduce((sum, s) => sum + parseInt(s.price || 0), 0);
            document.getElementById('totalDebtDisplay').innerText = total.toLocaleString() + ' ุฏ.ุน';

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ูุง ุชูุฌุฏ ุฏููู ูุณุชุญูุฉ</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(s => {
                let expiry = new Date(s.endDate);
                const daysLeft = Math.ceil((expiry - new Date()) / (1000 * 60 * 60 * 24));
                let badge = '';

                if (daysLeft < 0) badge = '<span class="badge badge-danger">ููุชููุฉ</span>';
                else if (daysLeft <= 3) badge = '<span class="badge badge-warning">ุชุดุงุฑู ุนูู ุงูุงูุชูุงุก</span>';

                return `
                 <tr>
                    <td data-label="ุงูุงุณู">${s.name} <br> <small style="color:#666">${s.phone}</small></td>
                    <td data-label="ุงููุจูุบ" style="font-weight:bold; color:#d32f2f;">${parseInt(s.price).toLocaleString()}</td>
                    <td data-label="ุชุงุฑูุฎ ุงูุงุณุชุญูุงู">${s.endDate} ${badge}</td>
                    <td data-label="ุฅุฌุฑุงุกุงุช">
                        <button onclick="openPayDebtModal('${s.id}', '${s.name}', ${s.price})" class="btn btn-sm btn-success">
                            <i class="fas fa-hand-holding-usd"></i> ุชุณุฏูุฏ
                        </button>
                    </td>
                 </tr>
                 `;
            }).join('');
        };

        // ุชุฃููุฏ ุฃุฎูุฑ ุนูู ุงูุตูุงุญูุงุช
        window.onload = () => AuthSystem.checkSession();

        setInterval(() => window.renderDebts(), 1000);
    </script>
</body>

</html>