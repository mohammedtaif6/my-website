<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الديون - لوحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f9fafb; }
        .card-stat { transition: all 0.3s ease; }
        .card-stat:hover { transform: translateY(-4px); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }
        table tbody tr { transition: background-color 0.2s; }
        table tbody tr:hover { background-color: #fef3c7; }
        .debt-badge { display: inline-block; padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .debt-badge-pending { background-color: #fef08a; color: #713f12; }
        .debt-badge-paid { background-color: #d1fae5; color: #065f46; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-blue-600 to-purple-600 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="h-16 flex items-center justify-between">
                <a href="index.html" class="text-white font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <span>OKComputer</span>
                </a>
                <div class="hidden md:flex gap-1">
                    <a href="index.html" class="text-white hover:bg-white/10 px-3 py-2 rounded-lg transition">الرئيسية</a>
                    <a href="subscribers.html" class="text-white hover:bg-white/10 px-3 py-2 rounded-lg transition">المشتركين</a>
                    <a href="debts.html" class="text-white font-bold bg-white/20 px-3 py-2 rounded-lg transition">الديون</a>
                    <a href="payments.html" class="text-white hover:bg-white/10 px-3 py-2 rounded-lg transition">المبالغ المستلمة</a>
                    <a href="expenses.html" class="text-white hover:bg-white/10 px-3 py-2 rounded-lg transition">الصرفيات</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <h1 class="text-4xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-credit-card text-yellow-600 ml-3 text-3xl"></i>
                الديون المستحقة
            </h1>
            <p class="text-gray-600 mt-2">متابعة وإدارة الديون والدفعات الآجلة</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card-stat bg-white rounded-2xl p-6 shadow-sm border-r-4 border-yellow-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">إجمالي الديون</p>
                        <p class="text-3xl font-bold text-gray-900" id="total-debts">0 د.ع</p>
                    </div>
                    <div class="p-3 bg-yellow-100 rounded-lg text-yellow-600">
                        <i class="fas fa-calculator text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-yellow-600"><i class="fas fa-sum ml-1"></i>المجموع الكلي</p>
            </div>
            
            <div class="card-stat bg-white rounded-2xl p-6 shadow-sm border-r-4 border-red-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">عدد الديون</p>
                        <p class="text-3xl font-bold text-gray-900" id="overdue-count">0</p>
                    </div>
                    <div class="p-3 bg-red-100 rounded-lg text-red-600">
                        <i class="fas fa-list text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-red-600"><i class="fas fa-exclamation-circle ml-1"></i>العدد الكلي</p>
            </div>
            
            <div class="card-stat bg-white rounded-2xl p-6 shadow-sm border-r-4 border-orange-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">متوسط الدين</p>
                        <p class="text-3xl font-bold text-gray-900" id="average-debt">0 د.ع</p>
                    </div>
                    <div class="p-3 bg-orange-100 rounded-lg text-orange-600">
                        <i class="fas fa-chart-bar text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-orange-600"><i class="fas fa-calculator ml-1"></i>المتوسط الحسابي</p>
            </div>
            
            <div class="card-stat bg-white rounded-2xl p-6 shadow-sm border-r-4 border-green-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">نسبة التحصيل</p>
                        <p class="text-3xl font-bold text-gray-900" id="collection-rate">0%</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-lg text-green-600">
                        <i class="fas fa-percent text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-green-600"><i class="fas fa-arrow-up ml-1"></i>المستحصل</p>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-6">
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-48">
                    <label class="block text-sm font-medium text-gray-700 mb-2">بحث</label>
                    <input type="text" id="search" placeholder="ابحث عن اسم أو هاتف..." 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                           onkeyup="loadDebts()">
                </div>
                <button onclick="exportDebts()" class="px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-medium">
                    <i class="fas fa-download ml-2"></i>تصدير
                </button>
                <button onclick="printDebts()" class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-print ml-2"></i>طباعة
                </button>
            </div>
        </div>

        <!-- Debts Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-right">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                        <tr>
                            <th class="p-4 font-semibold text-gray-700">#</th>
                            <th class="p-4 font-semibold text-gray-700">الاسم</th>
                            <th class="p-4 font-semibold text-gray-700">الهاتف</th>
                            <th class="p-4 font-semibold text-gray-700">المبلغ الأصلي</th>
                            <th class="p-4 font-semibold text-gray-700">المتبقي</th>
                            <th class="p-4 font-semibold text-gray-700">تاريخ الاشتراك</th>
                            <th class="p-4 font-semibold text-gray-700">تاريخ الانتهاء</th>
                            <th class="p-4 font-semibold text-gray-700">الحالة</th>
                            <th class="p-4 font-semibold text-gray-700">الإجراء</th>
                        </tr>
                    </thead>
                    <tbody id="debts-body" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="9" class="p-8 text-center text-gray-500">
                                <i class="fas fa-spinner animate-spin text-2xl mb-2"></i>
                                <p class="mt-2">جاري تحميل البيانات...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50">
                <div class="text-sm text-gray-600">
                    عرض <span id="page-info" class="font-semibold">0</span> سجل
                </div>
                <div class="flex gap-2">
                    <button onclick="previousPage()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition font-medium text-gray-700">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <span id="current-page" class="px-4 py-2 bg-yellow-600 text-white rounded-lg font-medium">1</span>
                    <button onclick="nextPage()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition font-medium text-gray-700">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="data-manager.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let allDebts = [];
        let filteredDebts = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadDebts();
            setInterval(loadDebts, 3000);
        });

        function loadDebts() {
            try {
                const search = document.getElementById('search')?.value?.toLowerCase() || '';
                const all = DataManager.getSubscribers() || [];
                const debts = all.filter(s => s.paymentType === 'أجل' && s.price > 0);
                
                allDebts = debts.map(d => ({
                    id: d.id,
                    name: d.name || 'بدون اسم',
                    phone: d.phone || '-',
                    originalAmount: parseInt(d.originalPrice) || parseInt(d.price),
                    remaining: parseInt(d.price) || 0,
                    subscribeDate: d.subscribeDate || '-',
                    expiryDate: d.expiryDate || '-',
                    status: d.price > 0 ? 'مستحق' : 'مدفوع'
                }));

                filteredDebts = allDebts.filter(d => {
                    if (!search) return true;
                    return d.name.toLowerCase().includes(search) || d.phone.includes(search);
                });

                currentPage = 1;
                updateStats();
                renderTable();
            } catch (err) {
                console.error('خطأ:', err);
            }
        }

        function updateStats() {
            const totalAmount = allDebts.reduce((sum, d) => sum + d.originalAmount, 0);
            const remainingAmount = allDebts.reduce((sum, d) => sum + d.remaining, 0);
            const count = allDebts.length;
            const avg = count > 0 ? Math.round(remainingAmount / count) : 0;
            const collectionRate = totalAmount > 0 ? Math.round(((totalAmount - remainingAmount) / totalAmount) * 100) : 0;

            document.getElementById('total-debts').textContent = remainingAmount.toLocaleString('ar-IQ') + ' د.ع';
            document.getElementById('overdue-count').textContent = count;
            document.getElementById('average-debt').textContent = avg.toLocaleString('ar-IQ') + ' د.ع';
            document.getElementById('collection-rate').textContent = collectionRate + '%';
        }

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredDebts.slice(start, end);

            const tbody = document.getElementById('debts-body');
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="p-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30 block"></i>
                            <p>لا توجد ديون</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageData.map((d, idx) => `
                <tr class="hover:bg-yellow-50 transition">
                    <td class="p-4 font-semibold">${start + idx + 1}</td>
                    <td class="p-4 font-medium text-gray-900">${d.name}</td>
                    <td class="p-4 text-gray-600">${d.phone}</td>
                    <td class="p-4 font-bold text-gray-900">${d.originalAmount.toLocaleString('ar-IQ')} د.ع</td>
                    <td class="p-4 font-bold text-red-600">${d.remaining.toLocaleString('ar-IQ')} د.ع</td>
                    <td class="p-4 text-gray-600 text-sm">${d.subscribeDate}</td>
                    <td class="p-4 text-gray-600 text-sm">${d.expiryDate}</td>
                    <td class="p-4">
                        <span class="debt-badge ${d.remaining > 0 ? 'debt-badge-pending' : 'debt-badge-paid'}">
                            ${d.remaining > 0 ? 'مستحق' : 'مدفوع'}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <button onclick="openPaymentModal(${d.id}, '${d.name}', ${d.remaining})" class="text-blue-600 hover:text-blue-800 font-medium text-sm" title="تسديد">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('page-info').textContent = `${start + 1}-${Math.min(end, filteredDebts.length)} من ${filteredDebts.length}`;
            document.getElementById('current-page').textContent = currentPage;
        }

        function openPaymentModal(id, name, amount) {
            const payment = prompt(`أدخل مبلغ التسديد لـ ${name} (المتبقي: ${amount} د.ع):`);
            if (payment === null) return;
            
            const paymentAmount = parseInt(payment);
            if (isNaN(paymentAmount) || paymentAmount <= 0 || paymentAmount > amount) {
                return;
            }

            const subscriber = DataManager.getSubscriber(id);
            if (subscriber) {
                const remaining = amount - paymentAmount;
                const today = new Date().toISOString().split('T')[0];
                
                DataManager.updateSubscriber(id, {
                    price: remaining,
                    lastPaymentDate: today,
                    lastPaymentAmount: paymentAmount,
                    paymentType: 'أجل',
                    originalPrice: (subscriber.originalPrice || 0) + paymentAmount
                });

                loadDebts();
                if (typeof window.updateDashboard === 'function') {
                    window.updateDashboard();
                }
            }
        }

        function exportDebts() {
            if (allDebts.length === 0) return;

            let csv = '\ufeff';
            csv += 'الاسم,الهاتف,المبلغ الأصلي,المتبقي,تاريخ الاشتراك,تاريخ الانتهاء,الحالة\n';
            
            allDebts.forEach(d => {
                csv += `"${d.name}","${d.phone}",${d.originalAmount},${d.remaining},"${d.subscribeDate}","${d.expiryDate}","${d.status}"\n`;
            });

            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = `debts_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function printDebts() {
            const printWindow = window.open('', '', 'width=1000,height=600');
            let html = `
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الديون</title>
                    <style>
                        body { font-family: Arial; text-align: right; }
                        h1 { text-align: center; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; border: 1px solid #ddd; text-align: right; }
                        th { background-color: #f3f4f6; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9fafb; }
                    </style>
                </head>
                <body>
                    <h1>تقرير الديون المستحقة</h1>
                    <p>التاريخ: ${new Date().toLocaleDateString('ar-IQ')}</p>
                    <table>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>المبلغ الأصلي</th>
                            <th>المتبقي</th>
                            <th>الحالة</th>
                        </tr>
            `;
            
            allDebts.forEach((d, idx) => {
                html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${d.name}</td>
                        <td>${d.phone}</td>
                        <td>${d.originalAmount} د.ع</td>
                        <td>${d.remaining} د.ع</td>
                        <td>${d.status}</td>
                    </tr>
                `;
            });
            
            html += `
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredDebts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>
