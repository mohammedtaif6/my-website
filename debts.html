<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø¯ÙŠÙˆÙ† - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=25.0">
    <link rel="stylesheet" href="style-fab.css?v=1.0">
    <link rel="stylesheet" href="style-modal.css?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Ø¥Ø¶Ø§ÙØ© AuthSystem -->
    <script src="auth-system.js"></script>
    <script>AuthSystem.checkSession();</script>
    <script src="auto-refresh.js"></script>

    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>

</head>

<body>
    <!-- Mobile Header & Toggle -->
    <button class="menu-btn" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar / Drawer Navigation -->
    <nav class="navbar" id="main-nav">
        <div class="header-card"
            style="margin: 0; background: none; box-shadow: none; border: none; padding: 0 0 20px 0;">
            <div class="logo" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 0;">
                <i class="fas fa-chart-line"></i> OK Computer
            </div>
            <button class="close-menu" onclick="toggleMenu()"
                style="position: absolute; left: 0; top: 0;">&times;</button>
        </div>

        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li id="nav-subscribers"><a href="subscribers.html"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</a></li>
            <li id="nav-active"><a href="active_subscribers.html"><i class="fas fa-signal"></i> Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†</a></li>
            <li id="nav-debts"><a href="debts.html" class="active"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¯ÙŠÙˆÙ†</a>
            </li>
            <li id="nav-payments"><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</a></li>
            <li id="nav-reports"><a href="reports.html"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
            <li id="nav-employees"><a href="employees.html"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a></li>
            <li id="nav-maintenance-log"><a href="maintenance-log.html"><i class="fas fa-clipboard-list"></i> Ø³Ø¬Ù„
                    Ø§Ù„ØµÙŠØ§Ù†Ø§Øª</a></li>
            <li id="nav-maintenance"><a href="maintenance.html"><i class="fas fa-wrench"></i> ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©</a></li>
            <li id="nav-telegram"><a href="telegram-settings.html"><i class="fab fa-telegram"></i> Telegram</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</a></li>
        </ul>

        <div class="nav-overlay" onclick="toggleMenu()"></div>
    </nav>

    <div class="container">

        <div class="header-card">
            <div>
                <h1>Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h1>
                <p>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ø¬Ù„</p>
            </div>
            <div id="totalDebtDisplay" class="text-danger" style="font-size:1.5rem; font-weight:bold;">
                0 Ø¯.Ø¹
            </div>
        </div>

        <!-- Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="debtSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="renderDebts()">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="debtsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="subscribers.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
        </a>
        <a href="debts.html" class="nav-item active">
            <i class="fas fa-money-bill-wave"></i>
            <span>Ø§Ù„Ø¯ÙŠÙˆÙ†</span>
        </a>
        <a href="maintenance.html" class="nav-item">
            <i class="fas fa-wrench"></i>
            <span>ØµÙŠØ§Ù†Ø©</span>
        </a>
        <a href="#" class="nav-item" onclick="toggleMenu(); return false;">
            <i class="fas fa-bars"></i>
            <span>Ø§Ù„Ù…Ø²ÙŠØ¯</span>
        </a>
    </div>

    <!-- Modal: Pay Debt -->
    <div id="payDebtModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ† - <span id="debtSubName"></span></h3>
                <button class="close-btn" onclick="closeDebtModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="debtSubId">
                <input type="hidden" id="debtSubFirebaseId">

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù…Ù† Ø£ØµÙ„ <span id="currentDebtAmount"></span>)</label>
                    <input type="number" id="payDebtAmount" placeholder="0">
                </div>

                <!-- WhatsApp Option for Debt Payment -->
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="send-whatsapp-debt" style="width: auto;">
                    <label for="send-whatsapp-debt" style="margin:0; font-weight:normal; cursor:pointer;">Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„
                        Ø§Ù„ÙˆØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</label>
                </div>

                <div class="action-buttons">
                    <button onclick="confirmPayDebt(true)" class="btn btn-success">
                        <i class="fas fa-print"></i> ØªØ³Ø¯ÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button onclick="confirmPayDebt(false)" class="btn btn-primary">
                        <i class="fas fa-check"></i> ØªØ³Ø¯ÙŠØ¯ ÙÙ‚Ø·
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.openPayDebtModal = function (id, firebaseId, name, amount) {
            document.getElementById('debtSubId').value = id;
            document.getElementById('debtSubFirebaseId').value = firebaseId;
            document.getElementById('debtSubName').innerText = name;
            document.getElementById('currentDebtAmount').innerText = amount.toLocaleString();
            document.getElementById('payDebtAmount').value = '';
            document.getElementById('payDebtModal').classList.add('active');
        };

        window.closeDebtModal = () => document.getElementById('payDebtModal').classList.remove('active');

        window.confirmPayDebt = async function (print = false) {
            const subId = document.getElementById('debtSubId').value;
            const firebaseId = document.getElementById('debtSubFirebaseId').value;
            const amount = parseInt(document.getElementById('payDebtAmount').value);
            const sendWhatsapp = document.getElementById('send-whatsapp-debt').checked;

            if (!amount || amount <= 0) {
                DataManager.showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
                return;
            }

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© payDebt Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ÙÙŠ DataManager
                // Ø§Ù„ØªØ±ØªÙŠØ¨: firebaseId, subId, amount
                await DataManager.payDebt(firebaseId, subId, amount);

                const sub = DataManager.getSubscriber(subId);
                const newPrice = Math.max(0, (parseInt(sub.price) || 0));

                // 3. Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø¥Ø°Ø§ Ø·Ù„Ø¨Øª)
                if (print && sub) {
                    const receiptData = {
                        title: "ÙˆØµÙ„ ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ†",
                        subName: sub.name,
                        amount: amount,
                        totalRemaining: newPrice,
                        date: new Date().toLocaleDateString('ar-IQ'),
                        type: "ØªØ³Ø¯ÙŠØ¯ Ù†Ù‚Ø¯"
                    };
                    DataManager.printReceipt(receiptData);
                }

                // 4. ÙˆØ§ØªØ³Ø§Ø¨ (Ø¥Ø°Ø§ Ø·Ù„Ø¨)
                if (sendWhatsapp && sub && sub.phone) {
                    const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${sub.name}ØŒ\n\nØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¯ÙØ¹Ø© ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ† Ø¨Ù‚ÙŠÙ…Ø©: ${amount.toLocaleString()} Ø¯.Ø¹\nØ§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø°Ù…ØªÙƒÙ…: ${newPrice.toLocaleString()} Ø¯.Ø¹\n\nØ´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ… ğŸŒ¹`;
                    let phone = sub.phone.replace(/^0+/, '');
                    if (!phone.startsWith('964')) phone = '964' + phone;

                    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                    const url = isMobile
                        ? `whatsapp://send?phone=${phone}&text=${encodeURIComponent(msg)}`
                        : `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

                    window.open(url, '_blank');
                }

                closeDebtModal();
                // DataManager.showToast ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ payDebt
                renderDebts();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¯ÙŠØ¯:', error);
                DataManager.showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¯ÙŠØ¯: ' + error.message, 'error');
            }
        };

        window.renderDebts = function () {
            if (typeof DataManager === 'undefined') return;

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ø­Ø«
            const searchQuery = document.getElementById('debtSearch')?.value.toLowerCase() || '';

            // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø¯ÙŠÙˆÙ†
            let list = DataManager.getSubscribers().filter(s => parseInt(s.price || 0) > 0);

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
            if (searchQuery) {
                list = list.filter(s =>
                    s.name.toLowerCase().includes(searchQuery) ||
                    (s.phone && s.phone.includes(searchQuery))
                );
            }

            const tbody = document.getElementById('debtsTableBody');

            // Calculate Total Debt
            const total = list.reduce((sum, s) => sum + parseInt(s.price || 0), 0);
            document.getElementById('totalDebtDisplay').innerText = total.toLocaleString() + ' Ø¯.Ø¹';

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø³ØªØ­Ù‚Ø©</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(s => {
                let expiry = new Date(s.expiryDate || s.endDate);
                const daysLeft = Math.ceil((expiry - new Date()) / (1000 * 60 * 60 * 24));
                let badge = '';

                if (daysLeft < 0) badge = '<span class="badge badge-danger">Ù…Ù†ØªÙ‡ÙŠØ©</span>';
                else if (daysLeft <= 3) badge = '<span class="badge badge-warning">ØªØ´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>';

                return `
                 <tr>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${s.name} <br> <small style="color:#666">${s.phone || ''}</small></td>
                    <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" style="font-weight:bold; color:#d32f2f;">${parseInt(s.price).toLocaleString()}</td>
                    <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚">${s.expiryDate || s.endDate || '-'} ${badge}</td>
                    <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
                        <button onclick="openPayDebtModal('${s.id}', '${s.firebaseId}', '${s.name}', ${s.price})" class="btn btn-sm btn-success">
                            <i class="fas fa-hand-holding-usd"></i> ØªØ³Ø¯ÙŠØ¯
                        </button>
                    </td>
                 </tr>
                 `;
            }).join('');
        };

        // ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        window.onload = () => AuthSystem.checkSession();

        setInterval(() => window.renderDebts(), 1000);

        // Menu Toggle Logic
        window.toggleMenu = function () {
            const nav = document.getElementById('main-nav');
            const overlay = document.querySelector('.nav-overlay');
            nav.classList.toggle('active');
            if (nav.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
    </script>
</body>

</html>