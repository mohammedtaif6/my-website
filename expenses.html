<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الصرفيات - OK Computer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Kufi+Arabic:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=29.0">
    <link rel="stylesheet" href="style-fab.css?v=3.0">
    <link rel="stylesheet" href="style-modal.css?v=3.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="auth-system.js?v=5.0"></script>
    <script>
        (function () {
            const settings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
            const style = document.createElement('style');
            let css = '';
            ['nav-subscribers', 'nav-active', 'nav-debts', 'nav-payments', 'nav-reports', 'nav-employees', 'nav-telegram'].forEach(id => {
                if (settings[id] === false) css += `#${id} { display: none !important; } `;
            });
            style.innerHTML = css;
            document.head.appendChild(style);
        })();
        AuthSystem.checkSession();
    </script>
    <script type="module">
        import { DataManager } from './data-manager.js?v=35.0';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>

    <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

    <nav class="navbar" id="main-nav">
        <div class="header-card"
            style="margin: 0; background: none; box-shadow: none; border: none; padding: 0 0 20px 0;">
            <div class="logo" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 0;">
                <i class="fas fa-chart-line"></i> OK Computer
            </div>
            <button class="close-menu" onclick="toggleMenu()"
                style="position: absolute; left: 0; top: 0;">&times;</button>
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li id="nav-subscribers"><a href="subscribers.html"><i class="fas fa-users"></i> المشتركين</a></li>
            <li id="nav-active"><a href="active_subscribers.html"><i class="fas fa-signal"></i> الفعالين</a></li>
            <li id="nav-debts"><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li id="nav-payments"><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> الصندوق</a></li>
            <li id="nav-reports"><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
            <li id="nav-employees"><a href="employees.html"><i class="fas fa-users-cog"></i> الموظفين</a></li>
            <li id="nav-telegram"><a href="telegram-settings.html"><i class="fab fa-telegram"></i> Telegram</a></li>
            <li id="nav-settings"><a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> خروج</a></li>
        </ul>
        <div class="nav-overlay" onclick="toggleMenu()"></div>
    </nav>

    <div class="container" style="padding-top: 60px; padding-bottom: 80px;">

        <!-- Header Card with Quick Actions -->
        <div class="header-card">
            <div>
                <h1>إدارة المصروفات</h1>
                <p>سجل ومتابعة جميع النفقات اليومية</p>
            </div>
            <div class="quick-actions" style="display:flex; gap:10px;">
                <button onclick="openExpenseModal()" class="btn btn-danger">
                    <i class="fas fa-plus-circle"></i> إضافة صرفية
                </button>
                <button onclick="window.location.href='index.html'" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> تفعيل مشترك
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="stats-grid">
            <div class="card">
                <div class="icon-box red"><i class="fas fa-dollar-sign"></i></div>
                <div class="card-info">
                    <h3>إجمالي المصروفات</h3>
                    <p id="totalExpenses" class="text-danger">0</p>
                </div>
            </div>
            <div class="card">
                <div class="icon-box orange"><i class="fas fa-list-ol"></i></div>
                <div class="card-info">
                    <h3>عدد السجلات</h3>
                    <p id="expensesCount">0</p>
                </div>
            </div>
        </div>

        <!-- Expense Table -->
        <div class="table-container">
            <div class="table-header">
                <h3>سجل العمليات</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>الوصف</th>
                            <th>المبلغ</th>
                            <th>التاريخ</th>
                            <th>تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Add Expense -->
    <div id="expenseModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>إضافة صرفية جديدة</h3>
                <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>البيان / الوصف</label>
                    <input type="text" id="expenseDesc" placeholder="مثال: فاتورة كهرباء، شراء مواد...">
                </div>
                <div class="form-group">
                    <label>المبلغ (دينار)</label>
                    <input type="number" inputmode="numeric" id="expenseAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>تاريخ الصرف</label>
                    <input type="date" id="expenseDate">
                </div>
                <button onclick="saveExpense()" class="btn btn-danger btn-full" id="saveExpBtn">
                    <i class="fas fa-save"></i> حفظ الصرفية
                </button>
            </div>
        </div>
    </div>

    <script>
        // Set default date
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        });

        window.openExpenseModal = function () {
            document.getElementById('expenseModal').classList.add('active');
        };

        window.closeExpenseModal = function () {
            document.getElementById('expenseModal').classList.remove('active');
        };

        window.renderPage = function () {
            if (typeof DataManager === 'undefined') return;
            // Get all transactions
            const allTrans = DataManager.getAllTransactions();
            const expenses = allTrans.filter(t => t.type === 'expense' || (t.amount || 0) < 0);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let total = 0;

            // Sort expenses (Transactions with negative values or type='expense')
            const sortedExpenses = expenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (sortedExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:var(--secondary);">لا توجد صرفيات مسجلة</td></tr>';
            } else {
                sortedExpenses.forEach(e => {
                    const amount = Math.abs(e.amount || 0);
                    total += amount;
                    const date = new Date(e.createdAt).toLocaleDateString('ar-IQ');

                    tbody.innerHTML += `
                        <tr>
                            <td data-label="الوصف">${e.description || 'بدون وصف'}</td>
                            <td data-label="المبلغ" class="text-danger" style="font-weight:bold;">${amount.toLocaleString()}</td>
                            <td data-label="التاريخ">${date}</td>
                            <td data-label="تحكم">
                                <button onclick="deleteExpenseConfirm('${e.id}')" class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            document.getElementById('totalExpenses').innerText = total.toLocaleString();
            document.getElementById('expensesCount').innerText = sortedExpenses.length;
        };

        window.updatePageData = window.renderPage;

        window.saveExpense = async function () {
            const btn = document.getElementById('saveExpBtn');
            const desc = document.getElementById('expenseDesc').value;
            const amount = parseInt(document.getElementById('expenseAmount').value);

            if (!desc || !amount || amount <= 0) {
                DataManager.showToast('⚠️ يرجى إدخال وصف ومبلغ صحيح', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

            try {
                // Use new V12 function
                await DataManager.addExpense(amount, desc);

                document.getElementById('expenseDesc').value = '';
                document.getElementById('expenseAmount').value = '';
                closeExpenseModal();
            } catch (e) {
                console.error(e);
                DataManager.showToast('❌ حدث خطأ أثناء الحفظ', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> حفظ الصرفية';
            }
        };

        window.deleteExpenseConfirm = async function (id) {
            if (confirm('هل أنت متأكد من حذف هذه الصرفية؟')) {
                await DataManager.deleteTransaction(id);
            }
        };

        setInterval(() => { if (typeof DataManager !== 'undefined') renderPage(); }, 1000);

        window.toggleMenu = function () {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
            document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
        };
    </script>
</body>

</html>