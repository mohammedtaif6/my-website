<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
<<<<<<< HEAD
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الصرفيات - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.0">
=======
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الصرفيات</title>
    <link rel="stylesheet" href="style.css?v=8">
>>>>>>> 468b659 (Update project files and add server.js)
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-file-invoice-dollar"></i> الصرفيات
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> المشتركين</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> المبالغ</a></li>
            <li><a href="expenses.html" class="active"><i class="fas fa-file-invoice-dollar"></i> الصرفيات</a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
        </ul>
    </nav>

    <div class="container">
<<<<<<< HEAD

        <!-- Header Card with Quick Actions -->
        <div class="header-card">
            <div>
                <h1>إدارة المصروفات</h1>
                <p>سجل ومتابعة جميع النفقات اليومية</p>
            </div>
            <div class="quick-actions" style="display:flex; gap:10px;">
                <button onclick="openExpenseModal()" class="btn btn-danger">
                    <i class="fas fa-plus-circle"></i> إضافة صرفية
                </button>
                <button onclick="window.location.href='index.html'" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> تفعيل مشترك
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="stats-grid">
            <div class="card">
                <div class="icon-box red"><i class="fas fa-dollar-sign"></i></div>
                <div class="card-info">
                    <h3>إجمالي المصروفات</h3>
                    <p id="totalExpenses" class="text-danger">0</p>
                </div>
            </div>
            <div class="card">
                <div class="icon-box orange"><i class="fas fa-list-ol"></i></div>
                <div class="card-info">
                    <h3>عدد السجلات</h3>
                    <p id="expensesCount">0</p>
                </div>
            </div>
        </div>

        <!-- Expense Table -->
        <div class="table-container">
            <div class="table-header">
                <h3>سجل العمليات</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>الوصف</th>
                            <th>المبلغ</th>
                            <th>التاريخ</th>
                            <th>تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal: Add Expense -->
    <div id="expenseModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>إضافة صرفية جديدة</h3>
                <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>البيان / الوصف</label>
                    <input type="text" id="expenseDesc" placeholder="مثال: فاتورة كهرباء، شراء مواد...">
                </div>
                <div class="form-group">
                    <label>المبلغ (دينار)</label>
                    <input type="number" id="expenseAmount" placeholder="0">
                </div>
                <div class="form-group">
                    <label>تاريخ الصرف</label>
                    <input type="date" id="expenseDate">
                </div>
                <button onclick="saveExpense()" class="btn btn-danger btn-full" id="saveExpBtn">
                    <i class="fas fa-save"></i> حفظ الصرفية
                </button>
            </div>
=======
        <div class="page-header">
            <h1>سجل المصروفات</h1>
            <div style="display: flex; gap: 10px;">
                <button onclick="openExpenseModal()" class="btn btn-danger"><i class="fas fa-plus"></i> إضافة صرفية</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="card" style="background: var(--danger-color); color: white; padding: 15px; border-radius: 8px;">
                <div style="font-size: 12px;">إجمالي المصروفات</div>
                <div id="totalExpenses" style="font-size: 24px; font-weight: bold; margin-top: 5px;">0</div>
            </div>
            <div class="card" style="background: var(--info-color); color: white; padding: 15px; border-radius: 8px;">
                <div style="font-size: 12px;">عدد المصروفات</div>
                <div id="expensesCount" style="font-size: 24px; font-weight: bold; margin-top: 5px;">0</div>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>البيان</th>
                        <th>المبلغ</th>
                        <th>التاريخ</th>
                        <th>تحكم</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
>>>>>>> 468b659 (Update project files and add server.js)
        </div>
    </div>

    <!-- Modal for adding expense -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة صرفية جديدة</h3>
                <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>البيان / الوصف</label>
                <input type="text" id="expenseDesc" placeholder="مثال: راتب الموظف، إيجار..." style="width: 100%; padding: 8px;">
            </div>
            <div class="form-group">
                <label>المبلغ (دينار)</label>
                <input type="number" id="expenseAmount" placeholder="المبلغ" style="width: 100%; padding: 8px;">
            </div>
            <div class="form-group">
                <label>التاريخ</label>
                <input type="date" id="expenseDate" style="width: 100%; padding: 8px;">
            </div>
            <div class="modal-footer">
                <button onclick="saveExpense()" class="btn btn-danger" style="width: 100%;">حفظ الصرفية</button>
            </div>
        </div>
    </div>

    <script>
<<<<<<< HEAD
        // Set default date
        window.addEventListener('load', () => {
=======
        // Set today's date as default
        window.addEventListener('load', function() {
>>>>>>> 468b659 (Update project files and add server.js)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        });

<<<<<<< HEAD
        window.openExpenseModal = function () {
            document.getElementById('expenseModal').classList.add('active');
        };

        window.closeExpenseModal = function () {
            document.getElementById('expenseModal').classList.remove('active');
        };

        window.renderPage = function () {
=======
        window.renderPage = function() {
>>>>>>> 468b659 (Update project files and add server.js)
            if (typeof DataManager === 'undefined') return;
            // Get all transactions
            const allTrans = DataManager.getAllTransactions();
            const expenses = allTrans.filter(t => t.type === 'expense' || (t.amount || 0) < 0);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let total = 0;

<<<<<<< HEAD
            let total = 0;

            // Sort expenses (Transactions with negative values or type='expense')
            const sortedExpenses = expenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (sortedExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:var(--secondary);">لا توجد صرفيات مسجلة</td></tr>';
            } else {
                sortedExpenses.forEach(e => {
                    const amount = Math.abs(e.amount || 0);
                    total += amount;
                    const date = new Date(e.createdAt).toLocaleDateString('ar-IQ');

                    tbody.innerHTML += `
                        <tr>
                            <td data-label="الوصف">${e.description || 'بدون وصف'}</td>
                            <td data-label="المبلغ" class="text-danger" style="font-weight:bold;">${amount.toLocaleString()}</td>
                            <td data-label="التاريخ">${date}</td>
                            <td data-label="تحكم">
                                <button onclick="deleteExpenseConfirm('${e.id}')" class="btn btn-outline" style="padding:5px 10px; color:var(--danger); border-color:var(--danger);">
=======
            if (exps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px;">لا توجد صرفيات</td></tr>';
            } else {
                exps.sort((a,b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date)).forEach(e => {
                    const amount = e.amount || 0;
                    total += amount;
                    const date = new Date(e.createdAt || e.date || Date.now()).toLocaleDateString('ar-IQ');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${e.description || '-'}</td>
                            <td style="color:var(--danger-color); font-weight:bold;">${amount.toLocaleString()}</td>
                            <td>${date}</td>
                            <td>
                                <button onclick="deleteExpenseConfirm('${e.firebaseId || e.id}')" class="btn btn-danger btn-sm">
>>>>>>> 468b659 (Update project files and add server.js)
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
<<<<<<< HEAD

            document.getElementById('totalExpenses').innerText = total.toLocaleString();
            document.getElementById('expensesCount').innerText = sortedExpenses.length;
        };

        window.updatePageData = window.renderPage;

        window.saveExpense = async function () {
            const btn = document.getElementById('saveExpBtn');
            const desc = document.getElementById('expenseDesc').value;
            const amount = parseInt(document.getElementById('expenseAmount').value);

            if (!desc || !amount || amount <= 0) {
                alert('الرجاء إدخال وصف ومبلغ صحيح');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

            try {
                // Use new V12 function
                await DataManager.addExpense(amount, desc);

                document.getElementById('expenseDesc').value = '';
                document.getElementById('expenseAmount').value = '';
                closeExpenseModal();
            } catch (e) {
                console.error(e);
                alert('حدث خطأ');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> حفظ الصرفية';
            }
        };

        window.deleteExpenseConfirm = async function (id) {
            if (confirm('هل أنت متأكد من حذف هذه الصرفية؟')) {
                await DataManager.deleteTransaction(id);
            }
        };

        setInterval(() => { if (typeof DataManager !== 'undefined') renderPage(); }, 1000);
=======
            
            document.getElementById('totalExpenses').innerText = total.toLocaleString();
            document.getElementById('expensesCount').innerText = exps.length;
        };

        window.openExpenseModal = function() {
            document.getElementById('expenseModal').classList.add('active');
        };

        window.closeExpenseModal = function() {
            document.getElementById('expenseModal').classList.remove('active');
        };

        window.saveExpense = async function() {
            const description = document.getElementById('expenseDesc').value;
            const amount = parseInt(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;

            if (!description || !amount || amount <= 0) {
                alert('الرجاء ملء جميع الحقول بشكل صحيح');
                return;
            }

            // تسجيل الصرفية كمبلغ سالب فقط (بدون تخزين مزدوج)
            await DataManager.recordTransaction(null, -amount, `صرفية: ${description}`, 'صرفية');
            
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseAmount').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            closeExpenseModal();
            // بدون alert - تحديث فوري بدلاً منه
        };

        window.deleteExpenseConfirm = async function(id) {
            if(confirm('حذف هذه الصرفية؟')) {
                const exp = DataManager.getExpenses().find(e => (e.firebaseId || e.id) === id);
                if(exp) {
                    await DataManager.deleteExpense(exp.id);
                }
            }
        };

        // Auto-refresh
        setInterval(() => { if(typeof DataManager !== 'undefined') renderPage(); }, 500);
        
        // Initial render
        setTimeout(renderPage, 1000);
>>>>>>> 468b659 (Update project files and add server.js)
    </script>
</body>

</html>