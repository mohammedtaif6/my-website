<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=25.0">
    <link rel="stylesheet" href="style-fab.css?v=1.0">
    <link rel="stylesheet" href="style-modal.css?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="auth-system.js?v=3.0"></script>
    <script>
        // Anti-Flicker: Apply visibility as fast as possible
        (function () {
            const settings = JSON.parse(localStorage.getItem('sas_settings') || '{}');
            const style = document.createElement('style');
            let css = '';
            ['nav-subscribers', 'nav-active', 'nav-debts', 'nav-payments', 'nav-reports', 'nav-employees', 'nav-telegram'].forEach(id => {
                if (settings[id] === false) css += `#${id} { display: none !important; } `;
            });
            style.innerHTML = css;
            document.head.appendChild(style);
        })();
        AuthSystem.checkSession();
    </script>
    <script type="module">
        import { DataManager } from './data-manager.js?v=28.0';
        window.DataManager = DataManager;
        DataManager.init();
    </script>

    <style>
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            margin-bottom: 25px;
            color: white;
        }

        .report-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .date-input,
        .period-select {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            background: white;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-input:hover,
        .period-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .summary-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 800;
            margin: 10px 0;
        }

        .summary-label {
            color: #666;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .income {
            color: #10b981;
        }

        .expense {
            color: #ef4444;
        }

        .balance {
            color: #667eea;
        }

        .debt {
            color: #f59e0b;
        }

        .transactions-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .section-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction-item {
            padding: 18px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .transaction-item:hover {
            background: #f8fafc;
            transform: translateX(-5px);
        }

        .tx-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .tx-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .tx-details {
            flex: 1;
        }

        .tx-description {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .tx-date {
            font-size: 0.85rem;
            color: #64748b;
        }

        .tx-amount {
            font-weight: 800;
            font-size: 1.2rem;
            direction: ltr;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 8px;
        }

        .archive-btn,
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .archive-btn:hover,
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .toggle-archive-btn {
            background: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-archive-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media print {

            .menu-btn,
            .navbar,
            .filter-group,
            .archive-btn,
            .export-btn {
                display: none !important;
            }

            .report-header {
                background: white !important;
                color: #333 !important;
            }
        }

        @media (max-width: 600px) {
            .report-summary {
                grid-template-columns: 1fr;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .tx-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <script>AuthSystem.checkSession();</script>

    <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

    <nav class="navbar" id="main-nav">
        <div class="header-card"
            style="margin: 0; background: none; box-shadow: none; border: none; padding: 0 0 20px 0;">
            <div class="logo" style="color: var(--primary); font-size: 1.5rem; margin-bottom: 0;">
                <i class="fas fa-chart-line"></i> OK Computer
            </div>
            <button class="close-menu" onclick="toggleMenu()"
                style="position: absolute; left: 0; top: 0;">&times;</button>
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</a></li>
            <li><a href="active_subscribers.html"><i class="fas fa-signal"></i> Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¯ÙŠÙˆÙ†</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</a></li>
            <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
            <li><a href="employees.html"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a></li>
            <li><a href="telegram-settings.html"><i class="fab fa-telegram"></i> Telegram</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
            <li><a href="#" onclick="AuthSystem.logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</a></li>
        </ul>
        <div class="nav-overlay" onclick="toggleMenu()"></div>
    </nav>

    <div class="container" style="padding-bottom: 80px;">

        <!-- Header & Filters -->
        <div class="report-header">
            <h1 class="report-title">
                <i class="fas fa-chart-line"></i>
                ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø¬Ø±Ø¯
            </h1>
            <div class="filter-group">
                <select id="report-period" class="period-select" onchange="updateReport()">
                    <option value="daily">Ø§Ù„ÙŠÙˆÙ…</option>
                    <option value="monthly" selected>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                    <option value="custom">Ù…Ø®ØµØµ</option>
                    <option value="all">ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª</option>
                </select>
                <div class="search-box" style="flex: 1; min-width: 200px; position: relative;">
                    <i class="fas fa-search"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888;"></i>
                    <input type="text" id="report-search" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ..." class="date-input"
                        style="padding-right: 35px; width: 100%;" oninput="updateReport()">
                </div>
                <div id="custom-date-range" style="display:none; gap:10px; align-items:center; flex-wrap:wrap;">
                    <label style="color:white; font-weight:600;">Ù…Ù†</label>
                    <input type="date" id="report-date-from" class="date-input" onchange="updateReport()">
                    <label style="color:white; font-weight:600;">Ø¥Ù„Ù‰</label>
                    <input type="date" id="report-date-to" class="date-input" onchange="updateReport()">
                </div>
                <button id="show-archived-btn" class="toggle-archive-btn" onclick="toggleArchivedView()">
                    <i class="fas fa-history"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                </button>
                <button onclick="exportReport()" class="export-btn" style="background: rgba(255,255,255,0.2);">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
                <button onclick="archiveCurrentView()" class="archive-btn" id="archive-btn"
                    style="background: rgba(255,255,255,0.2);">
                    <i class="fas fa-box-archive"></i> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØªØ±Ø©
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="report-summary">
            <div class="summary-card">
                <div class="summary-icon income"><i class="fas fa-arrow-circle-up"></i></div>
                <div class="summary-value income" id="total-income">0</div>
                <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</div>
            </div>
            <div class="summary-card">
                <div class="summary-icon expense"><i class="fas fa-arrow-circle-down"></i></div>
                <div class="summary-value expense" id="total-expense">0</div>
                <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
            </div>
            <div class="summary-card">
                <div class="summary-icon balance"><i class="fas fa-wallet"></i></div>
                <div class="summary-value balance" id="net-balance">0</div>
                <div class="summary-label">ØµØ§ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</div>
            </div>
            <div class="summary-card">
                <div class="summary-icon debt"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="summary-value debt" id="total-debts">0</div>
                <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
            </div>
        </div>

        <!-- Transactions List -->
        <div class="transactions-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-list-ul"></i>
                    ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    <span id="view-mode-label" style="font-size: 0.85rem; color:#64748b;">(Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</span>
                </div>
                <div style="color: #64748b; font-size: 0.9rem;" id="tx-count">0 Ø¹Ù…Ù„ÙŠØ©</div>
            </div>
            <div id="report-list">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { DataManager } from './data-manager.js?v=21.0';

        let isViewArchived = false;

        window.generateReport = () => {
            console.log('ğŸ“Š Generating report...');

            const period = document.getElementById('report-period').value;
            let txs = isViewArchived ? DataManager.getArchivedTransactions() : DataManager.getAllTransactions();
            const list = document.getElementById('report-list');

            if (!txs) {
                console.warn('âš ï¸ No transactions data');
                return;
            }

            console.log(`ğŸ“Š Total transactions: ${txs.length}`);

            // Update UI labels
            const viewLabel = document.getElementById('view-mode-label');
            const toggleBtn = document.getElementById('show-archived-btn');
            const archiveBtn = document.getElementById('archive-btn');

            if (isViewArchived) {
                viewLabel.innerText = "(Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø³Ø§Ø¨Ù‚)";
                viewLabel.style.color = "#ef4444";
                toggleBtn.innerHTML = '<i class="fas fa-chart-line"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ';
                archiveBtn.style.display = 'none';
            } else {
                viewLabel.innerText = "(Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)";
                viewLabel.style.color = "#10b981";
                toggleBtn.innerHTML = '<i class="fas fa-history"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ';
                archiveBtn.style.display = 'flex';
            }

            // Show/hide custom date range
            const customRange = document.getElementById('custom-date-range');
            if (period === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
            }

            // Filter by period
            const now = new Date();
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;

            // Filter by search term
            const searchTerm = document.getElementById('report-search').value.toLowerCase();

            txs = txs.filter(t => {
                const date = new Date(t.createdAt);
                if (t.type === 'subscription_debt') return false;

                // Search filter
                if (searchTerm) {
                    const desc = (t.description || '').toLowerCase();
                    const note = (t.note || '').toLowerCase();
                    const subName = (t.subscriberName || '').toLowerCase();
                    if (!desc.includes(searchTerm) && !note.includes(searchTerm) && !subName.includes(searchTerm)) return false;
                }

                if (period === 'daily') {
                    return date.getDate() === now.getDate() &&
                        date.getMonth() === now.getMonth() &&
                        date.getFullYear() === now.getFullYear();
                }
                if (period === 'monthly') {
                    return date.getMonth() === now.getMonth() &&
                        date.getFullYear() === now.getFullYear();
                }
                if (period === 'custom') {
                    const dateStr = date.toISOString().split('T')[0];
                    if (dateFrom && dateStr < dateFrom) return false;
                    if (dateTo && dateStr > dateTo) return false;
                    return true;
                }
                return true;
            });

            console.log(`ğŸ“Š Filtered transactions: ${txs.length}`);

            // Calculate totals
            const income = txs.filter(t => t.amount > 0).reduce((a, b) => a + b.amount, 0);
            const expense = txs.filter(t => t.amount < 0).reduce((a, b) => a + Math.abs(b.amount), 0);
            const net = income - expense;

            // Calculate total debts from subscribers
            const subs = DataManager.subscribers || [];
            const totalDebts = subs.reduce((sum, s) => sum + (parseInt(s.price) || 0), 0);

            // Update summary cards
            document.getElementById('total-income').innerText = income.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('total-expense').innerText = expense.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('net-balance').innerText = net.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('total-debts').innerText = totalDebts.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('tx-count').innerText = txs.length + ' Ø¹Ù…Ù„ÙŠØ©';

            // Render transactions
            if (txs.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <p>${isViewArchived ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙ' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©'}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = txs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .map(t => {
                    const isIncome = t.amount > 0;
                    const date = new Date(t.createdAt);

                    let icon = isIncome ? 'fa-arrow-circle-up' : 'fa-arrow-circle-down';
                    let typeLabel = isIncome ? 'Ù‚Ø¨Ø¶' : 'ØµØ±Ù';
                    let badge = '';

                    if (t.type === 'subscription_cash') {
                        badge = '<span class="badge" style="background:#ecfdf5; color:#059669;">ğŸ’° Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ù‚Ø¯ÙŠ</span>';
                    } else if (t.type === 'debt_payment') {
                        badge = '<span class="badge" style="background:#dbeafe; color:#1e40af;">ğŸ’µ ØªØ³Ø¯ÙŠØ¯ Ø¯ÙŠÙ†</span>';
                    } else if (t.type === 'expense') {
                        badge = '<span class="badge" style="background:#fee2e2; color:#b91c1c;">ğŸ“¤ ØµØ±ÙÙŠØ©</span>';
                    } else if (t.description && t.description.includes('Ø±Ø§ØªØ¨')) {
                        badge = '<span class="badge" style="background:#f3e5f5; color:#7b1fa2;">ğŸ‘¤ Ø±Ø§ØªØ¨</span>';
                    } else if (t.description && t.description.includes('Ø³Ù„ÙØ©')) {
                        badge = '<span class="badge" style="background:#fff3e0; color:#e65100;">ğŸ’¸ Ø³Ù„ÙØ©</span>';
                    }

                    return `
                        <div class="transaction-item">
                            <div class="tx-info">
                                <div class="tx-icon ${isIncome ? 'income' : 'expense'}">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div class="tx-details">
                                    <div class="tx-description">${badge} ${t.description || typeLabel}</div>
                                    <div class="tx-date">
                                        ${date.toLocaleDateString('ar-IQ')} - ${date.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            </div>
                            <div class="tx-amount ${isIncome ? 'income' : 'expense'}">
                                ${isIncome ? '+' : '-'}${Math.abs(t.amount).toLocaleString()}
                            </div>
                        </div>
                    `;
                }).join('');
        };

        window.toggleArchivedView = () => {
            isViewArchived = !isViewArchived;
            if (isViewArchived) {
                document.getElementById('report-period').value = 'all';
            } else {
                document.getElementById('report-period').value = 'monthly';
            }
            window.generateReport();
        };

        window.updateReport = () => {
            window.generateReport();
        };

        window.archiveCurrentView = async () => {
            await DataManager.archiveAllCurrent();
            window.generateReport();
        };

        window.exportReport = () => {
            window.print();
        };

        window.toggleMenu = function () {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
            document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
        };

        // Auto-update every 5 seconds
        setInterval(() => {
            if (typeof DataManager !== 'undefined' && !isViewArchived) {
                window.generateReport();
            }
        }, 5000);

        // Initial load
        setTimeout(() => window.generateReport(), 1000);
    </script>
</body>

</html>