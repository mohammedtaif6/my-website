<div class="main-content">
    <header>
        <h1>أرشيف التقارير</h1>
        <div class="stats-cards">
            <div class="card">
                <h3>إجمالي الأرشيف</h3>
                <p id="totalReportAmount">0</p>
            </div>
            <div class="card">
                <h3>عدد الفواتير</h3>
                <p id="totalReportCount">0</p>
            </div>
        </div>
    </header>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>تاريخ الترحيل</th>
                    <th>تاريخ الوصل</th>
                    <th>المبلغ</th>
                    <th>النوع</th>
                    <th>حذف</th> </tr>
            </thead>
            <tbody id="reportsTableBody">
                </tbody>
        </table>
    </div>
</div>

<script type="module">
    // تأكد من ربط data-manager.js
</script>

<script>
    window.loadReports = async function() {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">جاري تحميل الأرشيف...</td></tr>';

        // جلب البيانات من دالة الأرشيف الجديدة
        const reports = await DataManager.getArchivedTransactions();

        tbody.innerHTML = '';
        if (reports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">الأرشيف فارغ</td></tr>';
            updateHeaderStats(0, 0);
            return;
        }

        let total = 0;

        reports.forEach(r => {
            total += parseInt(r.amount) || 0;
            
            // تحويل التاريخ لصيغة مقروءة
            const archiveDate = r.archivedAt ? r.archivedAt.split('T')[0] : '-';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${archiveDate}</td>
                <td>${r.date}</td>
                <td>${parseInt(r.amount).toLocaleString()}</td>
                <td>${r.type || 'تسديد'}</td>
                <td>
                    <button onclick="deleteReport('${r.firebaseId}')" class="action-btn delete-btn" style="background:#f44336; color:white;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        updateHeaderStats(total, reports.length);
    };

    function updateHeaderStats(amount, count) {
        document.getElementById('totalReportAmount').innerText = amount.toLocaleString();
        document.getElementById('totalReportCount').innerText = count;
    }

    // دالة الحذف التي تستدعي الدالة الجديدة في DataManager
    window.deleteReport = async function(firebaseId) {
        await DataManager.deleteArchivedTransaction(firebaseId);
    };

    // تحميل البيانات عند فتح الصفحة (مع تأخير بسيط لضمان تحميل المدير)
    setTimeout(loadReports, 1000);
</script>
