<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>التقارير - OK Computer</title>
    <link rel="stylesheet" href="style.css?v=12.1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        import { DataManager } from './data-manager.js';
        window.DataManager = DataManager;
        DataManager.init();
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-chart-bar"></i> التقارير
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li><a href="subscribers.html"><i class="fas fa-users"></i> المشتركين</a></li>
            <li><a href="debts.html"><i class="fas fa-money-bill-wave"></i> الديون</a></li>
            <li><a href="payments.html"><i class="fas fa-hand-holding-usd"></i> المبالغ</a></li>
            <li><a href="expenses.html"><i class="fas fa-file-invoice-dollar"></i> الصرفيات</a></li>
            <li><a href="reports.html" class="active"><i class="fas fa-chart-bar"></i> التقارير</a></li>
        </ul>
    </nav>

    <div class="container">

        <div class="header-card">
            <div>
                <h1>التقارير المالية</h1>
                <p>ملخص الأداء المالي والفترة الزمنية</p>
            </div>
            <div>
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                    <label>من تاريخ</label>
                    <input type="date" id="dateFrom" onchange="generateReport()">
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                    <label>إلى تاريخ</label>
                    <input type="date" id="dateTo" onchange="generateReport()">
                </div>
                <div style="flex: 0 0 auto;">
                    <button onclick="generateReport()" class="btn btn-success" style="height: 52px; margin-top: 28px;">
                        <i class="fas fa-filter"></i> عرض
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <div class="icon-box green"><i class="fas fa-hand-holding-usd"></i></div>
                <div class="card-info">
                    <h3>إجمالي المقبوضات</h3>
                    <p id="totalIncome" class="text-success">0</p>
                </div>
            </div>

            <div class="card">
                <div class="icon-box red"><i class="fas fa-file-invoice-dollar"></i></div>
                <div class="card-info">
                    <h3>إجمالي المصروفات</h3>
                    <p id="totalExpense" class="text-danger">0</p>
                </div>
            </div>

            <div class="card">
                <div class="icon-box blue"><i class="fas fa-wallet"></i></div>
                <div class="card-info">
                    <h3>صافي الأرباح</h3>
                    <p id="netProfit">0</p>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>تفاصيل الحركة المالية للفترة المحددة</h3>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>عدد الحركات</th>
                            <th>مقبوضات</th>
                            <th>مصروفات</th>
                            <th>صافي اليوم</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        window.generateReport = function () {
            if (typeof DataManager === 'undefined') return;

            const fromDateVal = document.getElementById('dateFrom').value;
            const toDateVal = document.getElementById('dateTo').value;

            // Default to start of current month if not set
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const from = fromDateVal ? new Date(fromDateVal) : startOfMonth;
            const to = toDateVal ? new Date(toDateVal) : now;

            // Set end date to end of day
            to.setHours(23, 59, 59, 999);
            from.setHours(0, 0, 0, 0);

            // Update inputs if they were empty
            if (!fromDateVal) document.getElementById('dateFrom').value = from.toISOString().split('T')[0];
            if (!toDateVal) document.getElementById('dateTo').value = to.toISOString().split('T')[0];

            const txs = DataManager.getAllTransactions();
            const filtered = txs.filter(t => {
                const d = new Date(t.createdAt);
                // Filter out Debt-Only records (non-cash)
                if (t.type === 'subscription_debt') return false;
                return d >= from && d <= to;
            });

            // Group by Day
            const dailyStats = {};
            let grandIncome = 0;
            let grandExpense = 0;

            filtered.forEach(t => {
                const dayKey = new Date(t.createdAt).toLocaleDateString('en-CA'); // YYYY-MM-DD
                if (!dailyStats[dayKey]) dailyStats[dayKey] = { income: 0, expense: 0, count: 0 };

                const amt = t.amount || 0;
                if (amt > 0) {
                    dailyStats[dayKey].income += amt;
                    grandIncome += amt;
                } else {
                    dailyStats[dayKey].expense += Math.abs(amt);
                    grandExpense += Math.abs(amt);
                }
                dailyStats[dayKey].count++;
            });

            // Render Totals
            document.getElementById('totalIncome').innerText = grandIncome.toLocaleString();
            document.getElementById('totalExpense').innerText = grandExpense.toLocaleString();
            const net = grandIncome - grandExpense;
            document.getElementById('netProfit').innerText = net.toLocaleString();
            document.getElementById('netProfit').style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';

            // Render Table
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';

            // Sort days descending
            const sortedDays = Object.keys(dailyStats).sort((a, b) => new Date(b) - new Date(a));

            if (sortedDays.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">لا توجد بيانات لهذه الفترة</td></tr>';
            } else {
                sortedDays.forEach(day => {
                    const s = dailyStats[day];
                    const dailyNet = s.income - s.expense;
                    tbody.innerHTML += `
                        <tr>
                            <td data-label="التاريخ">${day}</td>
                            <td data-label="العمليات">${s.count}</td>
                            <td data-label="مقبوضات" class="text-success">${s.income.toLocaleString()}</td>
                            <td data-label="مصروفات" class="text-danger">${s.expense.toLocaleString()}</td>
                            <td data-label="صافي" style="font-weight:bold; color:${dailyNet >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                ${dailyNet.toLocaleString()}
                            </td>
                        </tr>
                    `;
                });
            }
        };

        window.updatePageData = window.generateReport;

        // Initial load
        setTimeout(() => {
            if (typeof DataManager !== 'undefined') generateReport();
        }, 1000);
    </script>
</body>

</html>